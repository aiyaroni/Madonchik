<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××“×¢××•× ×¦×³×™×§ - ×—×™×“×•×Ÿ ×¤×™×–×™×§×”</title>
  <!--
    ×§×•×‘×¥ ×©××œ×•×ª ××•×¤×¦×™×•× ×œ×™: /data/physics-questions.json
    ×¤×•×¨××˜ ×¤×¨×™×˜:
    {
      "q": "×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×¨×¢×?",
      "choices": ["×§×•×œ ××”×™×¨ ×™×•×ª×¨","××•×¨ ××”×™×¨ ×™×•×ª×¨","×–×” ×§×•×¨×” ×™×—×“","×ª×œ×•×™ ×‘×¢× × ×™×"],
      "correct": 1,
      "hint": "×”××•×¨ ××”×™×¨ ××”×§×•×œ.",
      "steps": ["××” × ×¢ ××”×¨ ×™×•×ª×¨","××” ×¨×•××™× ×§×•×“×","×¡×™×›×•×"],
      "topic": "waves",        // waves | optics | motion | electricity | gravity | pressure | buoyancy | thermo | general
      "level": "easy",         // easy | medium | hard
      "img": "/images/physics/waves.svg" // ××™×•×¨ ××•×¤×¦×™×•× ×œ×™
    }
  -->
  <style>
    :root{
      --ink:#1f2430; --ink-soft:#4b5263; --bg:#f6f7fb; --card:#ffffff;
      --accent:#6b74ff; --accent-2:#22c55e; --wrong:#ff6b6b; --muted:#e6e9f2; --ring:#93c5fd;
      --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.08);
    }
    html.dark{
      --ink:#e6e9f2; --ink-soft:#b6bed1; --bg:#0f1116; --card:#161a24;
      --accent:#8b92ff; --accent-2:#2bd4a7; --wrong:#ff7b88; --muted:#23283a; --ring:#7aa2ff;
      --shadow:0 8px 28px rgba(0,0,0,.40);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Heebo,Arimo,Arial,sans-serif; line-height:1.6}

    /* ×¢×˜×™×¤×” ×•×’×¨×™×“ ×›×œ×œ×™ */
    .wrap{max-width:1080px; margin:0 auto; padding: max(16px, env(safe-area-inset-top)) 16px 24px; min-height:100dvh}
    header.top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:44px; height:44px; border-radius:12px; display:grid; place-items:center; font-weight:900; color:#fff; background:linear-gradient(135deg, var(--accent), #aab0ff); box-shadow:var(--shadow)}
    .brand h1{margin:0; font-weight:900; letter-spacing:.2px; font-size:clamp(20px,2.2vw,26px)}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--muted); background:var(--card); color:var(--ink); border-radius:999px; padding:10px 14px; cursor:pointer; font-weight:800; font-size:14px; box-shadow:var(--shadow)}
    .chip:focus-visible{outline:3px solid var(--ring); outline-offset:2px}
    .chip[aria-pressed="true"]{box-shadow:0 0 0 3px rgba(147,197,253,.35), var(--shadow)}

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .subhead{font-weight:900; font-size:clamp(18px,1.6vw,22px); color:#1f2937; letter-spacing:-.01em}

    .progress{height:10px; background:var(--muted); border-radius:999px; overflow:hidden; margin:12px 0 14px}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#8aa0ff); transition:width .35s ease}

    /* ××¡×›×™× */
    .screen{display:none}
    .screen.active{display:block}

    /* ××–×•×¨ ×©××œ×” */
    .q-wrap{display:grid; grid-template-columns:64px 1fr; gap:12px; align-items:center}
    @media (min-width:640px){ .q-wrap{grid-template-columns:72px 1fr} }
    .q-illus{width:64px; height:64px; border-radius:16px; background:rgba(107,116,255,.10); display:grid; place-items:center; overflow:hidden; font-size:36px}
    .q-illus img{width:100%; height:100%; object-fit:contain}
    .q-illus svg{width:72%; height:72%}
    .q{font-size:clamp(20px,2.2vw,26px); margin:2px 0 2px; font-weight:900; overflow-wrap:anywhere}
    .assist{font-size:14px; color:var(--ink-soft)}

    .coach{display:flex; gap:10px; align-items:flex-start; background:rgba(0,0,0,.03); border:1px solid var(--muted); border-radius:14px; padding:10px 12px; margin:10px 0}
    .coach .owl{font-size:28px; line-height:1}
    .coach .say{font-weight:700}

    .choices{display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px}
    @media (min-width:640px){ .choices{grid-template-columns:1fr 1fr} }

    .btn{border:1px solid var(--muted); background:var(--card); border-radius:14px; padding:14px 14px; text-align:right; cursor:pointer; font-size:16px; color:var(--ink); min-height:56px; transition:transform .02s ease, border-color .2s ease, box-shadow .2s ease}
    @media (hover:hover) and (pointer:fine){ .btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.05) } }
    .btn:active{transform:scale(.995)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn.correct{border-color:var(--accent-2); box-shadow:0 0 0 3px rgba(34,197,94,.25)}
    .btn.wrong{border-color:var(--wrong); box-shadow:0 0 0 3px rgba(255,107,107,.25)}
    .btn:focus-visible{outline:3px solid var(--ring); outline-offset:2px}

    .hint{background:rgba(107,116,255,.10); border:1px dashed rgba(107,116,255,.35); color:color-mix(in oklab, var(--ink) 90%, var(--ink-soft)); padding:10px 12px; border-radius:12px; margin:12px 0 0; display:none; font-size:14px}

    .controls{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    .primary,.ghost{border:0; border-radius:12px; padding:12px 16px; font-weight:900; cursor:pointer; font-size:15px}
    .primary{background:var(--accent); color:#fff}
    .primary:disabled{opacity:.6; cursor:not-allowed}
    .ghost{background:rgba(0,0,0,.06); color:var(--ink)}
    .ghost:focus-visible,.primary:focus-visible{outline:3px solid var(--ring); outline-offset:2px}

    /* ×¤×¨×•×¤×™×œ */
    .kpis{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width:720px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    .kpi{padding:14px; border-radius:14px; border:2px solid var(--muted); background:var(--card)}
    .kpi .label{font-size:12px; color:#2563eb; font-weight:800}
    .kpi .val{font-size:28px; font-weight:900}

    .topics-grid{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width:880px){ .topics-grid{grid-template-columns:repeat(4,1fr)} }
    .topic-card{padding:12px; border-radius:14px; border:2px solid var(--muted); background:var(--card)}

    .history{display:grid; gap:8px}
    .history-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border-radius:12px; border:2px solid var(--muted); background:var(--card)}

    /* ×—×ª×™××” */
    .site-signature{text-align:center;color:#6b7280;font-size:.875rem;line-height:1.6; margin-top:1.25rem;margin-bottom:1.25rem}
    @media (min-width:640px){ .site-signature{font-size:1rem;margin-top:2rem;margin-bottom:2rem} }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}

    /* ××•×“×œ×™× ×‘×¡×™×¡×™×™× */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:16px; z-index:60}
    .modal .dialog{background:var(--card); border-radius:16px; padding:16px; width:min(520px, 96vw); box-shadow:var(--shadow)}

    /* Toast */
    .toast{position:fixed; inset-inline:0; bottom:16px; display:none; place-items:center; pointer-events:none; z-index:70}
    .toast > div{pointer-events:auto; background:var(--card); color:var(--ink); border:1px solid var(--muted); border-radius:12px; box-shadow:var(--shadow); padding:10px 14px; font-weight:800}

    .ltr{direction:ltr; unicode-bidi:embed; display:inline-block}
    [dir="rtl"] .choices .btn{text-align:right}
    @media (prefers-reduced-motion: reduce){ .bar{transition:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top" aria-label="×¡×¨×’×œ ×¢×œ×™×•×Ÿ">
      <div class="brand">
        <div class="logo" aria-hidden="true">Md</div>
        <h1 title="Madonchik">Madonchik - ×—×™×“×•×Ÿ ×¤×™×–×™×§×”</h1>
      </div>
      <div class="toolbar" role="group" aria-label="×‘×§×¨×•×ª ×¢×œ×™×•× ×•×ª">
        <button id="audioToggle" class="chip" type="button" aria-pressed="false" title="××¦×‘ ×¦×œ×™×œ">ğŸ”Š ×¦×œ×™×œ</button>
        <button id="themeToggle" class="chip" type="button" aria-pressed="false" title="××¦×‘ ×›×”×” ××• ×‘×”×™×¨">ğŸŒ— ××¦×‘ ×›×”×”</button>
        <button id="refreshBankBtn" class="chip" type="button" title="×˜×¢×Ÿ ××• ×¨×¢× ×Ÿ ×××’×¨ ×©××œ×•×ª">â™»ï¸ ×¨×¢× ×•×Ÿ ×××’×¨</button>
        <button id="profileBtn" class="chip" type="button" title="××–×•×¨ ××™×©×™">ğŸ‘¤ ××–×•×¨ ××™×©×™</button>
      </div>
    </header>

    <!-- ××¡×š ×‘×¨×•×š ×”×‘× -->
    <section id="welcomeScreen" class="screen active">
      <div class="card" style="text-align:center; padding:28px 18px">
        <div style="font-size:64px; margin-bottom:8px">ğŸ¦‰</div>
        <h2 class="subhead" style="margin:0 0 8px; color:#6b74ff">××“×¢×•× ×¦'×™×§</h2>
        <p style="font-size:18px; margin:0 0 16px">×‘×•××• ×œ×œ××•×“ ×¤×™×–×™×§×” ×‘×©××œ×•×ª ×§×¦×¨×•×ª ×¢× ×©×•×¤×™</p>
        <button id="startBtn" class="primary" type="button" style="font-size:18px; padding:14px 22px">×”×ª×—×œ×ª ××©×—×§</button>
      </div>
      <footer class="site-signature px-4">
        <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
        <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
      </footer>
    </section>

    <!-- ××¡×š ×©× -->
    <section id="nameScreen" class="screen">
      <div class="card" style="max-width:560px; margin-inline:auto; text-align:center">
        <div style="font-size:56px; margin-bottom:6px">ğŸ‘‹</div>
        <h2 class="subhead" id="nameTitle" style="margin:0 0 8px">××™×š ×§×•×¨××™× ×œ×›×?</h2>
        <p id="nameSubtitle" style="color:var(--ink-soft); margin:0 0 8px; display:none"></p>
        <input id="playerName" type="text" inputmode="text" placeholder="×”×§×œ×™×“×• ×©×" style="width:100%; font-size:18px; padding:14px; border-radius:12px; border:2px solid var(--muted); text-align:center; margin:8px 0 8px" />
        <div style="margin:4px 0 12px">
          <button id="profileOrSwitchBtn" class="ghost" type="button">×”×—×œ×¤×ª ××©×ª××© ××• ××–×•×¨ ××™×©×™</button>
        </div>
        <button id="nameNext" class="primary" type="button">×”××©×š</button>
      </div>
    </section>

    <!-- ×‘×•×¨×¨ ××©×ª××©×™× -->
    <div id="userPicker" class="modal" aria-hidden="true">
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="userPickerTitle">
        <h3 id="userPickerTitle" class="subhead" style="margin:0 0 8px">×‘×—×¨×• ××©×ª××©</h3>
        <div id="userList" style="max-height:50vh; overflow:auto; display:grid; gap:8px; margin:8px 0 12px"></div>
        <div style="display:flex; gap:8px; justify-content:space-between">
          <button id="userPickerClose" class="ghost" type="button">×¡×’×™×¨×”</button>
          <button id="newUserBtn" class="primary" type="button">××©×ª××© ×—×“×©</button>
        </div>
      </div>
    </div>

    <!-- ××¡×š ×—×™×“×•×Ÿ -->
    <section id="quizScreen" class="screen">
      <div class="card">
        <div class="meta" style="display:flex; justify-content:space-between; align-items:center; color:var(--ink-soft); font-size:14px; margin-bottom:8px">
          <div id="greet" style="font-weight:800">×©×œ×•× ××•×¨×—</div>
          <div class="score">× ×™×§×•×“: <strong id="score">0</strong> / <span id="total">10</span></div>
          <div id="counter">×©××œ×” <b class="ltr">1</b> ××ª×•×š <b class="ltr">10</b></div>
        </div>
        <div class="progress" aria-label="×”×ª×§×“××•×ª ××©×—×§"><div class="bar" id="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0% ×”×•×©×œ××•"></div></div>

        <div class="q-wrap">
          <div class="q-illus" id="illus" aria-hidden="true">ğŸ¦‰</div>
          <div>
            <div class="q" id="question">×˜×•×¢× ×™× ×¡×˜ ×—×“×©...</div>
            <div id="assist" class="assist">×‘×—×¨×• ×ª×©×•×‘×” ××—×ª × ×›×•× ×”. ×× ××¡×ª×‘×›×™× ×œ×•×—×¦×™× ×¢×œ ×¢×–×¨×”.</div>
          </div>
        </div>

        <div class="coach" id="coach" role="status" aria-live="polite"><div class="owl" aria-hidden="true">ğŸ¦‰</div><div class="say" id="coachText">×©×•×¤×™ ×›××Ÿ ×‘×©×‘×™×œ×›×.</div></div>

        <div class="choices" id="choices" aria-label="×‘×—×™×¨×ª ×ª×©×•×‘×”" role="group"></div>
        <div class="hint" id="hintBox" role="note"></div>

        <div class="controls">
          <button class="ghost" id="hintBtn" type="button" disabled aria-describedby="hintBox">×¢×–×¨×”</button>
          <button class="primary" id="nextBtn" type="button" disabled>×©××œ×” ×”×‘××”</button>
          <button class="ghost" id="newSetBtn" type="button" title="××©×—×§ ×—×“×© ××ª×•×š ×”×××’×¨ ×”×˜×¢×•×Ÿ">××©×—×§ ×—×“×©</button>
        </div>
      </div>
    </section>

    <!-- ××¡×š ×ª×•×¦××•×ª -->
    <section id="resultsScreen" class="screen">
      <div class="card" style="text-align:center; position:relative; overflow:hidden">
        <div style="font-size:64px; margin-bottom:8px">ğŸ†</div>
        <h2 id="resultsTitle" class="subhead" style="margin:0 0 10px">×¡×™×›×•× ×”××©×—×§</h2>
        <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0 10px">
          <span style="display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(34,197,94,.12); font-weight:900"><span id="finalScore">0</span> / <span id="finalTotal">0</span></span>
        </div>
        <p id="resultText" style="margin:0 0 12px">×™×¤×” ×××•×“</p>
        <div class="controls" style="justify-content:center">
          <button id="learnBtn" class="ghost" type="button" style="display:none">×œ×•××“×™× ××”×˜×¢×•×™×•×ª</button>
          <button id="retryBtn" class="primary" type="button">×× ×™ ×¨×•×¦×” ×œ×©×—×§ ×©×•×‘</button>
          <button id="altBtn" class="ghost" type="button">×¢×•×“ ××©×—×§</button>
          <button id="profileFromResultsBtn" class="ghost" type="button">××–×•×¨ ××™×©×™</button>
        </div>
      </div>
      <footer class="site-signature px-4">
        <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
        <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
      </footer>
    </section>

    <!-- ××¡×š ×˜×¢×•×™×•×ª -->
    <section id="mistakesScreen" class="screen">
      <div class="card">
        <div style="text-align:center; margin-bottom:12px">
          <div style="font-size:56px; margin-bottom:6px">ğŸ“š</div>
          <h2 class="subhead" id="mistakesTitle" style="margin:0 0 8px; color:#ef8a00">×œ×•××“×™× ××”×˜×¢×•×™×•×ª</h2>
          <p id="mistakesLead" style="margin:0 0 8px; color:var(--ink-soft)">×”× ×” ×”×©××œ×•×ª ×©×›×“××™ ×œ×—×–×§. ×œ×•×—×¦×™× ×›×“×™ ×œ×¨××•×ª ×”×¡×‘×¨ ×§×¦×¨.</p>
        </div>
        <div id="mistakesList" style="display:grid; gap:10px"></div>
        <div class="controls" style="justify-content:center">
          <button id="backToResults" class="ghost" type="button">×—×–×¨×” ×œ×ª×•×¦××•×ª</button>
          <button id="restartFromMistakes" class="ghost" type="button">××¡×š ×¤×ª×™×—×”</button>
        </div>
      </div>
    </section>

    <!-- ××¡×š ××–×•×¨ ××™×©×™ -->
    <section id="profileScreen" class="screen">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <h2 class="subhead" style="margin:0; color:#4f46e5">×”××–×•×¨ ×”××™×©×™</h2>
          <div style="display:flex; gap:8px">
            <button id="profileStartBtn" class="primary" type="button">×”×ª×—×œ×ª ××©×—×§</button>
            <button id="profileSwitchBtn" class="ghost" type="button">×”×—×œ×¤×ª ××©×ª××©</button>
            <button id="profileNewBtn" class="ghost" type="button">××©×ª××© ×—×“×©</button>
          </div>
        </div>
        <div id="profileHeader" style="margin-bottom:10px; color:var(--ink-soft)"></div>
        <div class="kpis" style="margin-bottom:12px">
          <div class="kpi"><div class="label">×¡×˜×™× ×©×‘×•×¦×¢×•</div><div id="kpiSets" class="val ltr">0</div></div>
          <div class="kpi"><div class="label">×“×™×•×§ ××¦×˜×‘×¨</div><div id="kpiAccuracy" class="val ltr">0%</div></div>
          <div class="kpi"><div class="label">×–××Ÿ ×××•×¦×¢ ×œ×©××œ×”</div><div id="kpiAvg" class="val ltr">0s</div></div>
        </div>
        <h3 class="subhead" style="margin:6px 0 6px">×¡×˜×˜×™×¡×˜×™×§×” ×œ×¤×™ × ×•×©×</h3>
        <div id="byTopicGrid" class="topics-grid" style="margin-bottom:12px"></div>
        <h3 class="subhead" style="margin:6px 0 6px">×”×™×¡×˜×•×¨×™×™×ª ××©×—×§×™×</h3>
        <div id="historyList" class="history"></div>
      </div>
    </section>

    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- ×˜×•×¡×˜ -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"><div id="toastMsg">×”×•×“×¢×”</div></div>

  <script>
    /* ===== ×§×‘×•×¢×™× ×•××—×¡×•×Ÿ ===== */
    const BANK_URL = '/data/physics-questions.json';
    const TOTAL_QUESTIONS = 10;

    const LS_BANK = 'mdk_bank_cache_v1';
    const LS_BANK_TS = 'mdk_bank_cache_ts_v1';
    const LS_SOUND = 'mdk_sound_muted';
    const LS_THEME = 'mdk_theme';
    const STORE_KEY = 'mdk_profiles_v1';
    const LS_RECENT = 'mdk_recent_qids_v1';

    let store = null, memOnly = false;

    function uuid(){ return 'xxxxxxxyxxxx'.replace(/[xy]/g, c=>{ const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16); }); }
    function storeInit(){
      try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }catch{ store=null; memOnly=true; }
      if(!store){ store={version:1, installedAt:Date.now(), activeId:null, profiles:{}}; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    }
    function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
    function getActiveProfile(){ return store.activeId ? (store.profiles[store.activeId]||null) : null; }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){
      const norm=(name||'').trim(); if(!norm) return null;
      const existing=profilesArr().find(p=>p.name.trim()===norm);
      if(existing){ setActiveProfile(existing.id); return existing; }
      const id=uuid(); store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
        totals:{sets:0,questions:0,correct:0,timeSec:0,hints:0}, byTopic:{}, history:[] };
      setActiveProfile(id); return {id, ...store.profiles[id]};
    }

    function logSessionToProfile(entry){
      const prof=getActiveProfile(); if(!prof) return;
      prof.history.unshift(entry); if(prof.history.length>120) prof.history.pop();
      prof.totals.sets += 1; prof.totals.questions += entry.count; prof.totals.correct += entry.correct; prof.totals.timeSec += entry.timeSec; prof.totals.hints += entry.hints;
      Object.entries(entry.topics||{}).forEach(([topic,count])=>{
        if(!prof.byTopic[topic]) prof.byTopic[topic]={sets:0,questions:0,correct:0,timeSec:0,hints:0};
        const bt=prof.byTopic[topic]; bt.sets += 1; bt.questions += count; bt.correct += Math.round((entry.correct/entry.count)*count); bt.timeSec += Math.round(entry.timeSec*(count/entry.count)); bt.hints += Math.round(entry.hints*(count/entry.count));
      });
      saveStore();
    }

    /* ===== ×¢×–×¨×™ ×–×™×›×¨×•×Ÿ ×©××œ×•×ª ××—×¨×•× ×•×ª ===== */
    function getRecent(){ try{ return JSON.parse(localStorage.getItem(LS_RECENT)||'[]'); }catch{ return []; } }
    function setRecent(arr){ try{ localStorage.setItem(LS_RECENT, JSON.stringify(arr.slice(-60))); }catch{} }
    function qId(text){ let h=0; const s=String(text||''); for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return 'q'+Math.abs(h); }

    /* ===== ××©×—×§ - ××¦×‘ ===== */
    let bankLoaded = [];
    let quizData = [];
    let idx = 0, score = 0, locked = false, hintStep = -1, startTime=0, totalTime=0, totalHints=0;
    let mistakes = [];

    /* ===== DOM ===== */
    const $=sel=>document.querySelector(sel);
    const el = {
      // ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×™×
      audioToggle: $('#audioToggle'), themeToggle: $('#themeToggle'), refreshBankBtn: $('#refreshBankBtn'), profileBtn: $('#profileBtn'),
      // ××¡×›×™×
      welcome: $('#welcomeScreen'), name: $('#nameScreen'), quiz: $('#quizScreen'), results: $('#resultsScreen'), mistakes: $('#mistakesScreen'), profile: $('#profileScreen'),
      // ×‘×•×¨×¨ ××©×ª××©
      userPicker: $('#userPicker'), userList: $('#userList'), userPickerClose: $('#userPickerClose'), newUserBtn: $('#newUserBtn'),
      // ×‘×¨×•×š ×”×‘× ×•×©×
      startBtn: $('#startBtn'), nameInput: $('#playerName'), nameNext: $('#nameNext'), nameTitle: $('#nameTitle'), nameSubtitle: $('#nameSubtitle'), profileOrSwitchBtn: $('#profileOrSwitchBtn'),
      // ×—×™×“×•×Ÿ
      greet: $('#greet'), score: $('#score'), total: $('#total'), counter: $('#counter'), bar: $('#bar'), question: $('#question'), illus: $('#illus'), assist: $('#assist'),
      coach: $('#coach'), coachText: $('#coachText'), choices: $('#choices'), hintBox: $('#hintBox'), hintBtn: $('#hintBtn'), nextBtn: $('#nextBtn'), newSetBtn: $('#newSetBtn'),
      // ×ª×•×¦××•×ª
      resultsTitle: $('#resultsTitle'), finalScore: $('#finalScore'), finalTotal: $('#finalTotal'), resultText: $('#resultText'), learnBtn: $('#learnBtn'), retryBtn: $('#retryBtn'), altBtn: $('#altBtn'), profileFromResultsBtn: $('#profileFromResultsBtn'),
      // ×˜×¢×•×™×•×ª
      mistakesTitle: $('#mistakesTitle'), mistakesLead: $('#mistakesLead'), mistakesList: $('#mistakesList'), backToResults: $('#backToResults'), restartFromMistakes: $('#restartFromMistakes'),
      // ×¤×¨×•×¤×™×œ
      profileHeader: $('#profileHeader'), kpiSets: $('#kpiSets'), kpiAccuracy: $('#kpiAccuracy'), kpiAvg: $('#kpiAvg'), byTopicGrid: $('#byTopicGrid'), historyList: $('#historyList'), profileStartBtn: $('#profileStartBtn'), profileSwitchBtn: $('#profileSwitchBtn'), profileNewBtn: $('#profileNewBtn'),
      // ×˜×•×¡×˜
      toast: $('#toast'), toastMsg: $('#toastMsg')
    };

    /* ===== ××•×“×™×• ===== */
    let isMuted = false, audioCtx = null, audioUnlocked = false;
    function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
    function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; try{ const buffer=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); const g=ctx.createGain(); g.gain.value=0.0001; src.buffer=buffer; src.connect(g); g.connect(ctx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); g.disconnect(); }catch{} audioUnlocked=true; },0); }catch{} }
    function tone(freq,dur,t,type='sine',gain=.22){ if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
    function playTick(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520,.08,t,'triangle',.18); }
    function playSuccess(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,.10,t,'sine',.18); tone(659.25,.10,t+.09,'sine',.16); tone(783.99,.12,t+.18,'sine',.14); }
    function playError(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,.10,t,'square',.18); tone(180,.10,t+.09,'square',.16); }

    try{ isMuted = localStorage.getItem(LS_SOUND) === 'true'; }catch{ isMuted=false }
    el.audioToggle.setAttribute('aria-pressed', isMuted?'true':'false'); el.audioToggle.textContent=(isMuted?'ğŸ”‡':'ğŸ”Š')+' '+'×¦×œ×™×œ';
    el.audioToggle.addEventListener('click', ()=>{ isMuted=!isMuted; el.audioToggle.setAttribute('aria-pressed', isMuted?'true':'false'); el.audioToggle.textContent=(isMuted?'ğŸ”‡':'ğŸ”Š')+' '+'×¦×œ×™×œ'; try{ localStorage.setItem(LS_SOUND, String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); playTick(); });
    ['pointerdown','touchstart','click','keydown'].forEach(ev=> window.addEventListener(ev, unlockAudioOnce, { once:true, passive:true }));

    /* ===== Theme ===== */
    (function initTheme(){ let stored=null; try{ stored=localStorage.getItem(LS_THEME);}catch{} const wantsDark= stored? stored==='dark' : (window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches); document.documentElement.classList.toggle('dark', wantsDark); el.themeToggle.setAttribute('aria-pressed', wantsDark?'true':'false'); el.themeToggle.textContent=(wantsDark?'ğŸŒ':'ğŸŒ—')+' ××¦×‘ '+(wantsDark?'×‘×”×™×¨':'×›×”×”'); })();
    el.themeToggle.addEventListener('click', ()=>{ const nowDark=!document.documentElement.classList.contains('dark'); document.documentElement.classList.toggle('dark', nowDark); el.themeToggle.setAttribute('aria-pressed', nowDark?'true':'false'); el.themeToggle.textContent=(nowDark?'ğŸŒ':'ğŸŒ—')+' ××¦×‘ '+(nowDark?'×‘×”×™×¨':'×›×”×”'); try{ localStorage.setItem(LS_THEME, nowDark?'dark':'light'); }catch{} playTick(); });

    /* ===== ×××’×¨ ×©××œ×•×ª ===== */
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    function enrichQuestion(q){ const id=q.id||qId(q.q); return {...q, id, topic:q.topic||'general'}; }
    function pickRandomQuestions(bank, n){
      const recent=new Set(getRecent());
      const shuffled=[...bank].map(enrichQuestion); shuffle(shuffled);
      const selected=[]; const seen=new Set();
      for(const q of shuffled){ const id=q.id; if(recent.has(id) || seen.has(id)) continue; selected.push(q); seen.add(id); if(selected.length===n) break; }
      // ×× ×œ× ×”×¡×¤×™×§ - × ×¨×¤×” ×××¡× ×Ÿ recent ××‘×œ × ×©××•×¨ ×™×™×—×•×“×™×•×ª
      if(selected.length<n){ for(const q of shuffled){ const id=q.id; if(seen.has(id)) continue; selected.push(q); seen.add(id); if(selected.length===n) break; } }
      // ×¢×¨×‘×•×‘ ×ª×©×•×‘×•×ª ×•×‘× ×™×™×ª ×¤×¨×™×˜ ××©×—×§
      const result=selected.map(q=>{ const mix=q.choices.map((txt,i)=>({txt,i})); shuffle(mix); return { id:q.id, q:q.q, choices:mix.map(c=>c.txt), correct:mix.findIndex(c=>c.i===q.correct), hint:q.hint||'', steps:Array.isArray(q.steps)?q.steps.slice():[], topic:q.topic||'general', level:q.level||null, img:q.img||null }; });
      // ×¢×“×›×•×Ÿ recent
      const newRecent=[...recent, ...result.map(x=>x.id)]; setRecent(newRecent);
      return result;
    }

    const localBigBank = [
      { q:"××” ××•×©×š ×—×¤×¦×™× ×œ×§×¨×§×¢", choices:["×—×™×›×•×š","×’×¨×‘×™×˜×¦×™×”","××’× ×˜×™×•×ª","×¨×•×—"], correct:1, hint:"×”×›×•×— ×©××•×©×š ×”×›×œ ×œ××˜×”", topic:'gravity' },
      { q:"××™×–×• ×× ×¨×’×™×” ×™×© ×œ×ª× ×•×¢×”", choices:["×§×™× ×˜×™×ª","×—×©××œ×™×ª","×ª×¨××™×ª","××œ×¡×˜×™×ª"], correct:0, hint:"×§×™× ×˜×™×ª ×–×” ×ª× ×•×¢×”", topic:'motion' },
      { q:"×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×©×©×•××¢×™× ×¨×¢×", choices:["×”×§×•×œ ××”×™×¨ ×™×•×ª×¨","×”××•×¨ ××”×™×¨ ×™×•×ª×¨","×–×” ×§×•×¨×” ×™×—×“","×ª×œ×•×™ ×‘×¢× × ×™×"], correct:1, hint:"×”××•×¨ ××”×™×¨ ××”×§×•×œ", steps:["×”××•×¨ × ×¢ ××”×¨ ×™×•×ª×¨ ××”×§×•×œ","×‘×¨×§ ×–×” ××•×¨, ×¨×¢× ×–×” ×§×•×œ","×œ×›×Ÿ ×¨×•××™× ×§×•×“× ××ª ×”×‘×¨×§"], topic:'waves' },
      { q:"××“×•×¢ ×¡×¤×™× ×” ×¦×¤×”", choices:["××©×§×œ ×§×˜×Ÿ","×¦×¤×™×¤×•×ª × ××•×›×” ×××™×","×× ×•×¢ ×—×–×§","××’× ×˜×™×"], correct:1, hint:"×¦×¤×™×¤×•×ª ×§×•×‘×¢×ª ×¦×™×¤×”", topic:'buoyancy' },
      { q:"××” ××•×“×“ ××“×—×•×", choices:["×˜××¤×¨×˜×•×¨×”","××¡×”","×œ×—×¥","××”×™×¨×•×ª"], correct:0, hint:"×›××” ×—× ××• ×§×¨", topic:'thermo' },
      { q:"××™×–×” ×›×•×— ×’×•×¨× ×œ××¡×œ×•×œ ××¢×’×œ×™", choices:["×¦×™×¤×”","×¦× ×˜×¨×™×¤×˜×œ×™","×—×™×›×•×š","××œ×¡×˜×™"], correct:1, hint:"×¤×•× ×” ××œ ×”××¨×›×–", topic:'motion' },
      { q:"×‘××¢×’×œ ×—×©××œ×™ ×¡×’×•×¨ ×¢× ×¡×•×œ×œ×” ×•× ×•×¨×”", choices:["×©×•× ×“×‘×¨","×”× ×•×¨×” ×ª×“×œ×§","×”×¡×•×œ×œ×” × ×¢×œ××ª","×™×”×™×” ×¦×œ×™×œ"], correct:1, hint:"×–×¨× × ×¢ ×‘××¢×’×œ ×¡×’×•×¨", topic:'electricity' },
      { q:"××™×–×” ×¦×‘×¢ × ×©×‘×¨ ×”×›×™ ×”×¨×‘×” ×‘××™×", choices:["××“×•×","×™×¨×•×§","×›×—×•×œ","×¡×’×•×œ"], correct:3, hint:"×”×§×¦×” ×”×¡×’×•×œ ×©×œ ×”×§×©×ª", topic:'optics' },
      { q:"××” ××§×•×¨ ×”×× ×¨×’×™×” ×œ×¨×•×—", choices:["×”×©××© ××—×××ª ×œ× ××—×™×“","×”×™×¨×—","××’× ×˜×™×","×¨×¢×©"], correct:0, hint:"×”×‘×“×œ×™ ×˜××¤×¨×˜×•×¨×” ×•×œ×—×¥", topic:'thermo' }
    ];

    async function fetchBankNoStore(){ const res=await fetch(BANK_URL, {cache:'no-store'}); if(!res.ok) throw new Error('Bad status'); const json=await res.json(); if(!Array.isArray(json)||!json.length) throw new Error('Empty JSON'); return json; }
    async function loadQuestionBank({forceNetwork=false}={}){
      if(forceNetwork){ try{ const bank=await fetchBankNoStore(); try{ localStorage.setItem(LS_BANK, JSON.stringify(bank)); localStorage.setItem(LS_BANK_TS, String(Date.now())); }catch{} toast('×”×××’×¨ ×¨×•×¢× ×Ÿ ××”×©×¨×ª'); return bank; }catch{} }
      try{ const cached=JSON.parse(localStorage.getItem(LS_BANK)||'[]'); if(cached && cached.length){ toast('× ×˜×¢×Ÿ ×××’×¨ ××”×™×¨ ××”×“×¤×“×¤×Ÿ'); return cached; } }catch{}
      try{ const bank=await fetchBankNoStore(); try{ localStorage.setItem(LS_BANK, JSON.stringify(bank)); localStorage.setItem(LS_BANK_TS, String(Date.now())); }catch{} toast('×”×××’×¨ × ×˜×¢×Ÿ ××”×©×¨×ª'); return bank; }catch{ toast('××™×Ÿ ×¨×©×ª - × ×˜×¢×Ÿ ×××’×¨ ××§×•××™'); return localBigBank; }
    }

    async function refreshBank(){ el.refreshBankBtn.disabled=true; el.refreshBankBtn.textContent='â³ ××¨×¢× ×Ÿ...'; try{ bankLoaded=await loadQuestionBank({forceNetwork:true}); playSuccess(); }catch{ playError(); } finally{ el.refreshBankBtn.disabled=false; el.refreshBankBtn.textContent='â™»ï¸ ×¨×¢× ×•×Ÿ ×××’×¨'; } }

    /* ===== ××™×•×¨ ×œ×¤×™ topic ××• ×ª××•× ×” ===== */
    function svgIcon(topic){
      const map={
        waves:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 12c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/><path d="M2 16c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/></svg>`,
        optics:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="7" cy="12" r="3"/><path d="M2 12h3m5-4 12 8M10 16l12-8"/></svg>`,
        motion:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12h9"/><path d="M13 12l-3-3m3 3-3 3"/><circle cx="18" cy="12" r="2"/></svg>`,
        electricity:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2 3 14h7l-1 8 11-12h-7l0-8z"/></svg>`,
        gravity:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="7" r="3"/><path d="M12 10v7m-4 0h8"/></svg>`,
        pressure:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="7"/><path d="M12 12l4-2"/></svg>`,
        buoyancy:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 15c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/><rect x="9" y="5" width="6" height="5" rx="1"/></svg>`,
        thermo:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M10 2v9a4 4 0 1 0 4 0V2z"/><circle cx="12" cy="17" r="3"/></svg>`
      };
      return map[topic] || `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/></svg>`;
    }
    function renderIllustration(item){ el.illus.innerHTML='ğŸ¦‰'; if(item?.img){ const img=document.createElement('img'); img.alt='××™×•×¨'; img.src=item.img; el.illus.innerHTML=''; el.illus.appendChild(img); return; } if(item?.topic){ el.illus.innerHTML=svgIcon(item.topic); } }

    /* ===== × ×™×•×•×˜ ××¡×›×™× ===== */
    const SCREENS=['welcomeScreen','nameScreen','quizScreen','resultsScreen','mistakesScreen','profileScreen'];
    function showScreen(id){ SCREENS.forEach(s=>{ const elS=$('#'+s); if(!elS) return; elS.classList.toggle('active', s===id); }); window.scrollTo({top:0, left:0, behavior:'auto'}); }

    /* ===== ×œ×•×’×™×§×ª ××©×—×§ ===== */
    function render(){
      locked=false; const item=quizData[idx];
      el.question.textContent=item?.q||'...'; el.assist.textContent='×‘×—×¨×• ×ª×©×•×‘×” ××—×ª × ×›×•× ×”'; el.coachText.textContent='×× ××¡×ª×‘×›×™× ×œ×•×—×¦×™× ×¢×œ ×¢×–×¨×”'; renderIllustration(item);
      el.choices.innerHTML=''; el.hintBox.style.display='none'; el.hintBox.textContent=''; hintStep=-1; startTime=Date.now();

      const hasAssist=(item?.steps && item.steps.length) || item?.hint; el.hintBtn.disabled=!hasAssist; el.hintBtn.textContent=(item?.steps && item.steps.length)?'×¦×¢×“ ×”×‘×':'×¢×–×¨×”'; el.nextBtn.disabled=true;
      el.counter.innerHTML=`×©××œ×” <b class="ltr">${idx+1}</b> ××ª×•×š <b class="ltr">${quizData.length}</b>`; const progress=Math.round((idx/quizData.length)*100); el.bar.style.width=progress+'%'; el.bar.setAttribute('aria-valuenow', String(progress)); el.bar.setAttribute('aria-valuetext', `${progress}% ×”×•×©×œ××•`);

      (item?.choices||[]).forEach((txt,i)=>{ const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=txt; b.setAttribute('tabindex','-1'); b.addEventListener('click',()=>selectAnswer(i,b)); el.choices.appendChild(b); });
    }

    function selectAnswer(choiceIndex, btn){
      if(locked) return; locked=true; playTick(); const item=quizData[idx]; const correct=item.correct; const end=Date.now(); totalTime+=Math.max(0,(end-startTime)/1000);
      [...el.choices.children].forEach((b,i)=>{ b.disabled=true; if(i===correct) b.classList.add('correct'); });
      if(choiceIndex===correct){ score++; el.score.textContent=String(score); playSuccess(); el.coachText.textContent='×‘×•×œ. ×›×œ ×”×›×‘×•×“'; }
      else{ btn.classList.add('wrong'); playError(); el.coachText.textContent='×›××¢×˜. ×”× ×” ×¢×–×¨×” ×§×¦×¨×”'; onWrongAnswer(item); trackMistake(item); }
      el.nextBtn.disabled=false;
    }

    function onWrongAnswer(item){ if(item.steps && item.steps.length){ hintStep=0; el.hintBox.textContent=item.steps[0]; el.hintBox.style.display='block'; el.hintBtn.textContent=(item.steps.length>1)?'×¦×¢×“ ×”×‘×':'×¡×™×•× ×¦×¢×“×™×'; el.hintBtn.disabled=(item.steps.length<=1); totalHints++; } else if(item.hint){ el.hintBox.textContent=item.hint; el.hintBox.style.display='block'; el.hintBtn.disabled=true; totalHints++; } }

    function trackMistake(item){
      mistakes.push({ id:item.id, q:item.q, correctIndex:item.correct, correctText:item.choices[item.correct], hint:item.hint, steps:item.steps, topic:item.topic });
    }

    el.hintBtn.addEventListener('click', ()=>{ const item=quizData[idx]; if(!item) return; playTick(); if(item.steps && item.steps.length){ hintStep++; const step=item.steps[Math.min(hintStep, item.steps.length-1)]; el.hintBox.textContent=step; el.hintBox.style.display='block'; const more=hintStep<item.steps.length-1; el.hintBtn.textContent= more? '×¦×¢×“ ×”×‘×' : '×¡×™×•× ×¦×¢×“×™×'; if(!more) el.hintBtn.disabled=true; totalHints++; } else if(item.hint){ el.hintBox.textContent=item.hint; el.hintBox.style.display='block'; el.hintBtn.disabled=true; totalHints++; } });

    el.nextBtn.addEventListener('click', ()=>{ if(idx<quizData.length-1){ idx++; render(); el.coachText.textContent='×§×“×™××” ×œ×©××œ×” ×”×‘××”'; } else { finish(); } playTick(); });
    el.newSetBtn.addEventListener('click', ()=>{ buildSessionFromLoadedBank(); playTick(); });

    function finish(){
      el.bar.style.width='100%'; el.bar.setAttribute('aria-valuenow','100'); el.bar.setAttribute('aria-valuetext','100% ×”×•×©×œ××•');
      showScreen('resultsScreen'); el.finalScore.textContent=String(score); el.finalTotal.textContent=String(quizData.length);
      const pct=Math.round((score/quizData.length)*100); let title='×¡×™×›×•× ×”××©×—×§', msg='×™×¤×” ×××•×“. ×××©×™×›×™× ×œ×’×œ×•×ª ×•×œ×©××•×œ'; if(pct===100){ title='××•×©×œ×'; msg='××œ×•×¤×™×. × × ×¡×” ×¢×•×“ ×©×œ×‘'; confetti(); } else if(pct>=80){ title='××¢×•×œ×”'; msg='×›××¢×˜ ××•×©×œ× - ×¢×•×“ ×¡×™×‘×•×‘ ×•×™×© ×©×™× ×—×“×©'; } else if(pct>=50){ title='×™×© ×”×ª×§×“××•×ª'; msg='×¢×•×“ ×§×¦×ª ×ª×¨×’×•×œ ×•× ×§×¤×•×¥ ×§×“×™××”'; } else { title='×›×œ ×”×ª×—×œ×” ×”×™× ×¦×¢×“ ×¨××©×•×Ÿ'; msg='×œ× × ×•×¨×. ×—×•×–×¨×™× ×œ×¡×™×‘×•×‘ × ×•×¡×£ ×•××©×ª×¤×¨×™× ××”×¨'; }
      el.resultsTitle.textContent=title; el.resultText.textContent=msg; el.coachText.textContent='×˜×•×‘ ×××•×“. ××¤×©×¨ ×œ×©×—×§ ×©×•×‘ ××• ×œ×˜×¢×•×Ÿ ××©×—×§ ×—×“×©';

      // ×œ×•×’ ×¤×¨×•×¤×™×œ
      const topicsCount={}; quizData.forEach(q=>{ topicsCount[q.topic]=(topicsCount[q.topic]||0)+1; });
      const entry={ id:uuid(), ts:Date.now(), count:quizData.length, correct:score, timeSec:Math.round(totalTime), hints:totalHints, topics:topicsCount, scorePct:pct };
      logSessionToProfile(entry);

      // ×˜×¢×•×™×•×ª
      el.learnBtn.style.display = mistakes.length ? 'inline-block' : 'none';
    }

    function buildSessionFromLoadedBank(){
      const n=Math.min(TOTAL_QUESTIONS, (bankLoaded && bankLoaded.length) ? bankLoaded.length : localBigBank.length);
      mistakes = [];
      quizData=pickRandomQuestions(bankLoaded.length?bankLoaded:localBigBank, n);
      idx=0; score=0; locked=false; totalTime=0; totalHints=0; el.score.textContent='0'; el.total.textContent=String(quizData.length);
      const prof=getActiveProfile(); const nm=prof?prof.name:'××•×¨×—'; el.greet.textContent=`×©×œ×•× ${nm}`;
      showScreen('quizScreen'); render();
    }

    async function newSession(){ if(!bankLoaded.length){ bankLoaded=await loadQuestionBank(); } buildSessionFromLoadedBank(); }

    /* ===== Mistakes UI ===== */
    function renderMistakes(){
      showScreen('mistakesScreen');
      el.mistakesList.innerHTML='';
      if(!mistakes.length){ const d=document.createElement('div'); d.className='history-row'; d.style.color='var(--ink-soft)'; d.textContent='××™×Ÿ ×˜×¢×•×™×•×ª ×”×¤×¢× - ×›×œ ×”×›×‘×•×“'; el.mistakesList.appendChild(d); return; }
      mistakes.forEach(m=>{
        const card=document.createElement('div'); card.className='topic-card';
        const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center'; head.style.gap='10px';
        const q=document.createElement('div'); q.style.fontWeight='900'; q.textContent=m.q;
        const btn=document.createElement('button'); btn.type='button'; btn.className='ghost'; btn.textContent='×”×¡×‘×¨ ×§×¦×¨';
        head.appendChild(q); head.appendChild(btn); card.appendChild(head);
        const body=document.createElement('div'); body.style.display='none'; body.style.marginTop='8px'; body.style.fontSize='14px'; body.style.color='var(--ink-soft)';
        const correct=document.createElement('div'); correct.innerHTML = '×ª×©×•×‘×” × ×›×•× ×”: <span class="ltr" style="font-weight:900">'+m.correctText+'</span>';
        const help=document.createElement('div'); help.textContent = (m.steps && m.steps.length) ? m.steps.join(' â†’ ') : (m.hint || '×˜×™×¤ ×§×¦×¨: × ×¡×• ×œ×—×©×•×‘ ××” ×”×›×™ ×”×’×™×•× ×™');
        body.appendChild(correct); body.appendChild(help); card.appendChild(body);
        btn.addEventListener('click', ()=>{ body.style.display = body.style.display==='none' ? 'block' : 'none'; });
        el.mistakesList.appendChild(card);
      });
    }

    /* ===== Toast ×•Ö¾×§×•× ×¤×˜×™ ===== */
    let toastTimer=null; function toast(msg){ el.toastMsg.textContent=msg; el.toast.style.display='grid'; clearTimeout(toastTimer); toastTimer=setTimeout(()=>{ el.toast.style.display='none'; }, 1800); }
    function confetti(){ try{ if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; }catch{} const root=document.body; const n=28; for(let i=0;i<n;i++){ const dot=document.createElement('span'); dot.style.position='fixed'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%'; dot.style.left='50%'; dot.style.top='20%'; const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7']; dot.style.background=colors[i%colors.length]; dot.style.zIndex=80; const angle=(i/n)*Math.PI*2, dist=80+Math.random()*60, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist; const anim=dot.animate([{transform:'translate(-50%,-50%) scale(1)', opacity:1},{transform:`translate(${tx-50}%,${ty-50}%) scale(.9)`, opacity:0}],{duration:900, easing:'cubic-bezier(.2,.8,.2,1)'}); anim.onfinish=()=>dot.remove(); root.appendChild(dot); } }

    /* ===== ××•×“×œ ×‘×•×¨×¨ ××©×ª××©×™× ===== */
    let lastFocusEl=null; let dialogKeyHandler=null;
    function openUserPicker(){ buildUserList(); lastFocusEl=document.activeElement; el.userPicker.style.display='flex'; trapDialog(el.userPicker); }
    function closeUserPicker(){ el.userPicker.style.display='none'; if(dialogKeyHandler){ el.userPicker.removeEventListener('keydown', dialogKeyHandler); dialogKeyHandler=null; } if(lastFocusEl && lastFocusEl.focus) lastFocusEl.focus(); }
    function buildUserList(){ const arr=profilesArr(); el.userList.innerHTML=''; if(arr.length===0){ const p=document.createElement('div'); p.textContent='××™×Ÿ ××©×ª××©×™× ×©××•×¨×™×'; p.style.color='var(--ink-soft)'; el.userList.appendChild(p); return; } arr.forEach(p=>{ const b=document.createElement('button'); b.type='button'; b.className='btn'; b.style.minHeight='44px'; b.textContent=p.name; b.addEventListener('click',()=>{ setActiveProfile(p.id); closeUserPicker(); renderProfile(); toast(`×¢×‘×¨×ª× ×œ ${p.name}`); }); el.userList.appendChild(b); }); }
    function trapDialog(modal){ function getF(){ return modal.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])'); } function onKey(e){ if(e.key==='Escape'){ closeUserPicker(); } if(e.key!=='Tab') return; const f=[...getF()]; if(!f.length) return; const first=f[0], last=f[f.length-1]; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } } dialogKeyHandler=onKey; modal.addEventListener('keydown', onKey); setTimeout(()=>{ const f=modal.querySelector('button'); f && f.focus(); }, 0); }

    /* ===== ×¤×¨×•×¤×™×œ - UI ===== */
    function renderProfile(){ showScreen('profileScreen'); const prof=getActiveProfile(); const users=profilesArr().length; el.profileSwitchBtn.disabled=users<=1; el.profileSwitchBtn.classList.toggle('disabled', users<=1);
      if(!prof){ el.profileHeader.textContent='××™×Ÿ ××©×ª××© ×¤×¢×™×œ. ××¤×©×¨ ×œ×™×¦×•×¨ ××©×ª××© ×—×“×© ××• ×œ×”×—×œ×™×£ ×œ××©×ª××© ×§×™×™×'; el.kpiSets.textContent='0'; el.kpiAccuracy.textContent='0%'; el.kpiAvg.textContent='0s'; el.byTopicGrid.innerHTML=''; el.historyList.innerHTML='<div class="history-row" style="color:var(--ink-soft)">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ</div>'; return; }
      // XSS-safe
      el.profileHeader.textContent = '××©×ª××© ×¤×¢×™×œ: ';
      const strong = document.createElement('span'); strong.style.fontWeight='900'; strong.style.color='#111'; strong.textContent = prof.name; el.profileHeader.appendChild(strong);
      const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0,hints:0}; const acc=tot.questions? Math.round((tot.correct/tot.questions)*100) : 0; const avg=tot.questions? Math.round(tot.timeSec/tot.questions) : 0; el.kpiSets.textContent=String(tot.sets||0); el.kpiAccuracy.textContent=acc+'%'; el.kpiAvg.textContent=(avg||0)+'s';
      const topics=prof.byTopic||{}; const labels={general:'×›×œ×œ×™', waves:'×’×œ×™×', optics:'××•×¤×˜×™×§×”', motion:'×ª× ×•×¢×”', electricity:'×—×©××œ', gravity:'×’×¨×‘×™×˜×¦×™×”', pressure:'×œ×—×¥', buoyancy:'×¦×™×¤×”', thermo:'×—×•×'};
      el.byTopicGrid.innerHTML=''; Object.keys(labels).forEach(key=>{ const b=topics[key]; const q=b?.questions||0, c=b?.correct||0, a=q?Math.round(c/q*100):0; const card=document.createElement('div'); card.className='topic-card'; card.innerHTML=`<div style="font-weight:900; margin-bottom:6px">${labels[key]}</div><div style="font-size:12px; color:var(--ink-soft); margin-bottom:6px">×©××œ×•×ª: <span class="ltr">${q}</span></div><div class="progress" aria-hidden="true" style="height:8px"><div style="width:${a}%" class="bar"></div></div><div style="font-size:12px; color:var(--ink-soft); margin-top:6px">×“×™×•×§: <span class="ltr">${a}%</span></div>`; el.byTopicGrid.appendChild(card); });
      const h=prof.history||[]; el.historyList.innerHTML=''; if(h.length===0){ el.historyList.innerHTML='<div class="history-row" style="color:var(--ink-soft)">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ</div>'; } else { h.slice(0,20).forEach(item=>{ const pct=Math.round(item.scorePct|| (item.correct/item.count*100)); const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'}); const row=document.createElement('div'); row.className='history-row'; row.innerHTML=`<div><div style="font-size:12px; color:var(--ink-soft)">${date}</div><div>×©××œ×•×ª: ${item.count} Â· ×–××Ÿ ×××•×¦×¢: ${Math.max(1, Math.round(item.timeSec/item.count))}s Â· ×¨××–×™×: ${item.hints}</div></div><div class="ltr" style="font-weight:900; ${pct===100?'color:#16a34a': pct>=60?'color:#2563eb':'color:#ea580c'}">${pct}%</div>`; el.historyList.appendChild(row); }); }
    }

    /* ===== ×—×™×•×•×˜ ××™×¨×•×¢×™× ===== */
    function bindAll(){
      el.startBtn.addEventListener('click', ()=>{ showScreen('nameScreen'); el.nameInput.value=''; const prof=getActiveProfile(); if(prof){ el.nameInput.value=prof.name; el.nameSubtitle.textContent=`×©×œ×•× ${prof.name}`; el.nameSubtitle.style.display='block'; } else { el.nameSubtitle.style.display='none'; } playTick(); });
      el.nameNext.addEventListener('click', ()=>{ const v=(el.nameInput.value||'').trim(); if(!v){ alert('×× × ×›×ª×‘×• ×©×'); el.nameInput.focus(); return; } ensureProfileByName(v); const prof=getActiveProfile(); el.greet.textContent=`×©×œ×•× ${prof.name}`; newSession(); });
      el.profileOrSwitchBtn.addEventListener('click', ()=>{ const arr=profilesArr(); if(arr.length>0) openUserPicker(); else renderProfile(); });

      el.userPickerClose.addEventListener('click', closeUserPicker); el.newUserBtn.addEventListener('click', ()=>{ closeUserPicker(); el.nameInput.value=''; showScreen('nameScreen'); el.nameInput.focus(); });

      el.profileBtn.addEventListener('click', renderProfile); el.profileFromResultsBtn.addEventListener('click', renderProfile); el.profileStartBtn.addEventListener('click', ()=>{ const prof=getActiveProfile(); if(!prof) { showScreen('nameScreen'); el.nameInput.focus(); } else { newSession(); } }); el.profileSwitchBtn.addEventListener('click', openUserPicker); el.profileNewBtn.addEventListener('click', ()=>{ store.activeId=null; saveStore(); showScreen('nameScreen'); el.nameInput.value=''; el.nameInput.focus(); });

      el.retryBtn.addEventListener('click', ()=>{ if(!quizData.length) newSession(); else buildSessionFromLoadedBank(); playTick(); });
      el.altBtn.addEventListener('click', async ()=>{ await refreshBank(); await newSession(); });
      el.learnBtn.addEventListener('click', ()=>{ renderMistakes(); });

      el.backToResults.addEventListener('click', ()=>{ showScreen('resultsScreen'); });
      el.restartFromMistakes.addEventListener('click', ()=>{ showScreen('welcomeScreen'); });

      el.refreshBankBtn.addEventListener('click', async ()=>{ await refreshBank(); await newSession(); });
    }

    /* ===== ×”×¤×¢×œ×” ===== */
    (async function init(){ storeInit(); bindAll(); showScreen('welcomeScreen'); })();
  </script>
</body>
</html>
