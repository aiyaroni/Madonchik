<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××“×¢×•× ×¦'×™×§ - ×—×™×“×•×Ÿ ××“×¢ ×•×¤×™×–×™×§×”</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Fonts & Base ===== */
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    :root{
      --ink:#1f2937; --ink-soft:#6b7280;
      --bg-grad-from:#e0f2fe; --bg-grad-via:#f5f3ff; --bg-grad-to:#dcfce7;
      --card:#ffffff; --muted:#e5e7eb;
      --accent:#3b82f6; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --radius:16px; --shadow:0 10px 26px rgba(0,0,0,.12);
    }
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink)}

    .subhead{font-weight:600;font-size:clamp(1.05rem, .9rem + .7vw, 1.25rem); line-height:1.35; color:#374151}
    .choice-card{
      position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;
      background:#fff; border:2px solid transparent; border-radius:1.25rem; padding:1.15rem;
      box-shadow:var(--shadow); transition:.18s; cursor:pointer; outline:none; user-select:none; min-height:92px;
      /* FIX: ×× ×™×¢×ª ××¤×§×˜×™ ××¡×›×”/×¤×™×™×“ ×œ× ×¨×¦×•×™×™× ×‘×¡×¤××¨×™/××•×‘×™×™×œ */
      -webkit-mask-image:none; mask-image:none; background-clip:padding-box; -webkit-background-clip:padding-box; isolation:isolate;
    }
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .choice-card .emoji{font-size:2rem}

    .chip{min-width:68px; min-height:52px; display:inline-flex; align-items:center; justify-content:center;
      border:2px solid #e5e7eb; background:white; border-radius:1rem; padding:.3rem .9rem;
      font-weight:700; font-size:1.125rem; cursor:pointer; transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20)}

    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;
      -webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,1);border-radius:1rem;border:2px solid transparent;outline:none; min-height:88px;
      display:flex;align-items:center;justify-content:center;padding:1rem}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-text{width:100%; text-align:center; font-size:1.25rem; font-weight:600; line-height:1.5; word-break:break-word; hyphens:auto}
    .answer-text.ltr{direction:ltr; unicode-bidi:embed}
    .answer-text.rtl{direction:rtl; unicode-bidi:embed}

    .link-cta{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;margin:.5rem auto 1rem;font-weight:700;font-size:1rem;
      color:#111827;text-decoration:underline;cursor:pointer;background:transparent;border:none;padding:.25rem .5rem;border-radius:.5rem}

    .site-signature{ text-align:center;color:#6b7280;font-size:.95rem;line-height:1.6; margin:1.5rem auto }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}

    /* Floating controls */
    #floatingControls{position:fixed; left:16px; top:16px; z-index:50; display:flex; flex-direction:column; gap:10px;}
    #audioToggle,#profileBtn{padding:.5rem .7rem;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12); font-size:20px}

    /* Welcome owl fallback pulse */
    .pulse{animation:pulse 1.6s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    /* Topics collapse: show 4 by default */
    #topicsGrid.topics-collapsed > :nth-child(n+5){ display:none; }
    #topicsWrapper{position:relative}
    .topics-collapsed{max-height:min(45vh, 360px); overflow:hidden;}
    #topicsFade{position:absolute; inset-inline:0; bottom:0; height:64px;
      background:linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0)); pointer-events:none;}

    /* Accessibility helpers */
    .no-focus-outline:focus{outline:none !important; box-shadow:none !important}
  </style>
</head>

<body class="bg-gradient-to-br from-[var(--bg-grad-from)] via-[var(--bg-grad-via)] to-[var(--bg-grad-to)] min-h-screen">

  <!-- Floating controls -->
  <div id="floatingControls" aria-label="×‘×§×¨×•×ª ××”×™×¨×•×ª">
    <button id="audioToggle" type="button" aria-label="×”×—×œ×¤×ª ××¦×‘ ×¦×œ×™×œ" aria-pressed="false" title="×”×¦×œ×™×œ ×¤×¢×™×œ">ğŸ”Š</button>
    <button id="profileBtn" type="button" aria-label="××–×•×¨ ××™×©×™" title="××–×•×¨ ××™×©×™">ğŸ‘¤</button>
  </div>

  <!-- Welcome -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <img src="/assets/shofi.gif" alt="×©×•×¤×™ ×”×™× ×©×•×£" class="w-20 h-20 mx-auto mb-4 rounded-xl" onerror="this.outerHTML='<div class=&quot;text-6xl mb-4 pulse&quot;>ğŸ¦‰</div>'">
      <h1 id="welcomeTitle" tabindex="-1" class="no-focus-outline text-4xl font-extrabold text-purple-600 mb-3">××“×¢×•× ×¦'×™×§</h1>
      <p class="text-2xl text-gray-700 mb-8">×©×•×¤×™ ×”×™× ×©×•×£ ××—×›×” ×œ×›× ×œ×—×™×“×•×Ÿ ××“×¢ ×›×™×¤×™</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ</button>
    </div>
    <footer class="site-signature px-4" id="globalSignature">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">ğŸ‘‹</div>
      <h2 id="nameTitle" tabindex="-1" class="no-focus-outline text-3xl font-extrabold text-blue-600 mb-2">××™×š ×§×•×¨××™× ×œ×š?</h2>
      <p id="nameSubtitle" class="text-gray-600 mb-4 hidden"></p>
      <input type="text" id="playerName" name="playerName" required placeholder="×”×›× ×™×¡×• ××ª ×©××›× ×›××Ÿ" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="link-cta">×”×—×œ×¤×ª ××©×ª××© - ××–×•×¨ ××™×©×™</button>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”××©×š</button>
    </form>
  </div>

  <!-- User Picker -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-2xl font-extrabold text-gray-800 mb-3">×‘×—×¨×• ××©×ª××©</h3>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">×¡×’×•×¨</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">××©×ª××© ×—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Topics -->
  <div id="topicsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-4xl w-full">
      <div class="text-5xl mb-4">ğŸ“š</div>
      <h2 id="topicsTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">××™×–×” × ×•×©× ××¢× ×™×™×Ÿ ××ª×›× ×”×™×•×?</h2>
      <p class="subhead mb-6">××¤×©×¨ ×œ×‘×—×•×¨ × ×•×©× ××—×“ ××• ×™×•×ª×¨</p>

      <div id="topicsWrapper" class="relative mb-6">
        <div id="topicsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 topics-collapsed"></div>
        <div id="topicsFade" class="hidden"></div>
      </div>

      <div class="flex items-center justify-center gap-3 flex-wrap mt-2">
        <button id="topicsMore" type="button" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold hidden" aria-expanded="false">×”×¦×’ ×¢×•×“</button>
        <button id="topicsNext" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”××©×š</button>
      </div>
    </div>
  </div>

  <!-- Program -->
  <div id="programScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-xl w-full">
      <div class="text-5xl mb-4">ğŸ¯</div>
      <h2 class="text-3xl md:text-4×œ font-extrab×•×“ text-indigo-600 mb-2">××™×–×• ×ª×›× ×™×ª ×œ×™××•×“ ××ª××™××”?</h2>
      <p class="subhead mb-6">×‘×—×¨×• ××ª ×”×›×™×ª×” ×©×œ×›×</p>

      <!-- ×ª××™×“ 2Ã—2 -->
      <div id="programGrid" class="grid grid-cols-2 gap-4 mb-6"></div>

      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="programNext" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”××©×š</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settingsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-xl w-full">
      <div class="text-5xl mb-4">âš™ï¸</div>
      <h2 class="text-3xl md:text-4xl font-extrabold text-emerald-600 mb-2">××¡×¤×¨ ×”×©××œ×•×ª ×‘××©×—×§</h2>

      <div class="mb-6">
        <div id="countChips" class="flex flex-wrap gap-2 justify-center">
          <button type="button" class="chip" data-count="6" aria-pressed="false">6</button>
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
        </div>
      </div>

      <h3 class="text-2xl font-extrabold text-blue-600 mb-3">××™×–×• ×¨××ª ×§×•×©×™ ××ª××™××” ×œ×š ×”×™×•×?</h3>
      <div id="difficultyChips" class="flex flex-wrap gap-2 justify-center mb-6">
        <button type="button" class="chip" data-diff="easy" aria-pressed="false">ğŸ™‚ ×§×œ</button>
        <button type="button" class="chip" data-diff="medium" aria-pressed="false">ğŸ’ª ×‘×™× ×•× ×™</button>
        <button type="button" class="chip" data-diff="hard" aria-pressed="false">ğŸ§  ××ª×§×“×</button>
      </div>

      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="settingsNext" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”×ª×—×œ</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4 gap-3 flex-wrap">
        <div class="text-2xl font-extrabold text-purple-600">×©××œ×” <span id="currentQuestion" class="ltr">1</span> ××ª×•×š <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-700">×©×œ×•× <span id="gamePlayerName" class="font-bold"></span> - ×‘×”×¦×œ×—×”</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
      <div id="statusMsg" class="sr-only" aria-live="polite"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-lg text-center">
      <img src="/assets/shofi.gif" alt="×©×•×¤×™ ×”×™× ×©×•×£" class="w-16 h-16 mx-auto mb-4 rounded-xl" onerror="this.outerHTML='<div class=&quot;text-5xl mb-4 pulse&quot;>ğŸ¦‰</div>'">
      <div id="questionText" tabindex="-1" class="no-focus-outline text-3xl font-extrabold text-gray-900 mb-5">×˜×•×¢×Ÿ ×©××œ×”...</div>
      <div class="subhead text-gray-700">×‘×—×¨×• ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg mx-auto px-4 mb-6"></div>

    <div class="text-center space-y-4 pb-10">
      <button id="confirmButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">××©×¨ ×ª×©×•×‘×”</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
    </div>

    <!-- End-of-set Feedback -->
    <div id="feedback" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">ğŸ‰</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-extrabold mb-6">×¡×™×™×× ×• ××ª ×”×¡×˜ - ×›×œ ×”×›×‘×•×“</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×¡×™×›×•× ×”×ª×•×¦××•×ª</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">ğŸ†</div>
      <h2 id="resultsTitle" tabindex="-1" class="no-focus-outline text-3xl font-extrabold text-green-600 mb-4">×›×œ ×”×›×‘×•×“</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">×”×‘×™×¦×•×¢×™× ×©×œ×š:</span>
          <span id="performancePercentage" class="text-sm font-extrabold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">âœ“ × ×›×•× ×•×ª: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">âœ— ×©×’×•×™×•×ª: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">×¡×™×™××ª ××ª ×”×¡×˜ - ×™×¤×”</div>
        <div class="mb-2">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span id="correctAnswers" class="font-extrabold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">×–××Ÿ ×××•×¦×¢: <span id="averageTime" class="font-extrabold text-blue-600 ltr">0</span> ×©× ×™×•×ª</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="learnBtn" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×œ××•×“ ××”×˜×¢×•×™×•×ª</button>
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×—×–×•×¨ ×¢×œ ×”×ª×¨×’×™×œ ××—×“×©</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×‘× ×œ×™ × ×•×©× ××—×¨</button>
        <button id="profileFromResultsBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">××–×•×¨ ××™×©×™</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Learn from Mistakes -->
  <div id="mistakesScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <h2 class="text-3xl font-extrabold text-amber-600 mb-4 text-center">×œ×•××“×™× ××”×˜×¢×•×™×•×ª</h2>
      <div id="mistakesList" class="space-y-3 mb-6"></div>
      <div class="flex gap-3 justify-center">
        <button id="backToResultsBtn" class="px-6 py-3 rounded-full bg-gray-100 hover:bg-gray-200 font-bold">×—×–×¨×” ×œ×¡×™×›×•×</button>
        <button id="fromMistakesStartBtn" class="px-6 py-3 rounded-full bg-green-600 text-white font-bold hover:bg-green-700">×”×ª×—×œ ××©×—×§ ×—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <h2 class="text-3xl font-extrabold text-indigo-600">×”××–×•×¨ ×”××™×©×™</h2>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">×”×ª×—×œ ××©×—×§</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">×”×—×œ×£ ××©×ª××©</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">××©×ª××© ×—×“×©</button>
        </div>
      </div>

      <div id="profileHeader" class="mb-6 text-lg text-gray-700"></div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">×¡×˜×™× ×©×‘×•×¦×¢×•</div>
          <div id="kpiSets" class="text-3xl font-extrabold text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">×“×™×•×§ ××¦×˜×‘×¨</div>
          <div id="kpiAccuracy" class="text-3xl font-extrabold text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">×–××Ÿ ×××•×¦×¢ ×œ×©××œ×”</div>
          <div id="kpiAvg" class="text-3xl font-extrabold text-gray-900 ltr">0s</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="byTopicGrid"></div>

      <div>
        <h3 class="text-2xl font-extrabold text-gray-800 mb-3">×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™×</h3>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State & Store ========= */
    let selectedTopics = new Set(), selectedProgram = null, selectedCount = null, selectedDifficulty = null;
    let playerName = '', questionCount = 6;
    let currentQuestionIndex = 0, correctCount = 0, totalQuestions = 6;
    let questions = [], selectedAnswer = null, startTime = 0, totalTime = 0;
    let wrongAnswers = []; // ×œ××¡×š "×œ××“ ××”×˜×¢×•×™×•×ª"

    const STORE_KEY='mdnc_profiles_v2';
    const RECENT_KEY='mdnc_recent_ids_v2';
    let store=null; let memOnly=false;

    function uuid(){
      return 'xxxxxxxyxxxx'.replace(/[xy]/g, c=>{
        const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8);
        return v.toString(16);
      });
    }
    function storeInit(){
      try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }
      catch{ store=null; memOnly=true; }
      if(!store){
        store = { version:2, installedAt:Date.now(), activeId:null, profiles:{} };
        try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; }
      }
    }
    function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
    function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null; }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){
      const norm=(name||'').trim(); if(!norm) return null;
      const existing=profilesArr().find(p=>p.name.trim()===norm);
      if(existing){ setActiveProfile(existing.id); return existing; }
      const id=uuid();
      store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
        totals:{sets:0,questions:0,correct:0,timeSec:0}, byTopic:{}, history:[] };
      setActiveProfile(id);
      return {id, ...store.profiles[id]};
    }
    function logSessionToProfile(topicSummary){
      const prof=getActiveProfile(); if(!prof) return;
      const entry={ id:uuid(), ts:Date.now(), topics:[...topicSummary], diff:selectedDifficulty,
        count:totalQuestions, correct:correctCount, avgSec:Math.max(1,Math.round(totalTime/Math.max(1,totalQuestions))) };
      prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop();

      prof.totals.sets+=1; prof.totals.questions+=totalQuestions; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);

      topicSummary.forEach(t=>{
        if(!prof.byTopic[t]) prof.byTopic[t]={sets:0,questions:0,correct:0,timeSec:0};
        prof.byTopic[t].sets+=1; prof.byTopic[t].questions+=Math.round(totalQuestions/topicSummary.length);
        prof.byTopic[t].correct+=Math.round(correctCount/topicSummary.length);
        prof.byTopic[t].timeSec+=Math.round(totalTime/topicSummary.length);
      });
      saveStore();
    }

    /* ========= Audio ========= */
    let isMuted=false, audioCtx=null, audioUnlocked=false;
    function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
    function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const ctx=getAudioCtx(); if(!ctx) return;
      try{ const buffer=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); const gain=ctx.createGain(); gain.gain.value=0.0001; src.buffer=buffer; src.connect(gain); gain.connect(ctx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); gain.disconnect(); }catch{} audioUnlocked=true; },0); }catch{}
    }
    function tone(freq,dur,t,type='sine',gain=0.24){ if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
    function playSelectTick(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520,0.10,t,'triangle',0.24); }
    function playSuccessSound(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.22); tone(659.25,0.12,t+0.1,'sine',0.20); tone(783.99,0.14,t+0.2,'sine',0.18); }
    function playErrorSound(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,0.12,t,'square',0.20); tone(180,0.12,t+0.1,'square',0.18); }
    document.addEventListener('click',e=>{
      const el=e.target.closest('button,.choice-card,.chip,.answer-item');
      if(!el||el.id==='audioToggle') return;
      const wasLocked=!audioUnlocked; unlockAudioOnce();
      if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
      if(wasLocked) setTimeout(playSelectTick,0); else playSelectTick();
    });
    function initAudioToggle(){
      const btn=$('#audioToggle'); if(!btn) return;
      try{ isMuted=localStorage.getItem('mdnc_sound_muted')==='true'; }catch{ isMuted=false; }
      btn.setAttribute('aria-pressed', isMuted?'true':'false');
      btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      btn.addEventListener('click',()=>{ isMuted=!isMuted; btn.setAttribute('aria-pressed', isMuted?'true':'false'); btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; try{ localStorage.setItem('mdnc_sound_muted', String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); });
    }

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]];}return c}
    function sample(arr){ return arr && arr.length ? arr[Math.floor(Math.random()*arr.length)] : null; }
    function focusTop(selector){
      const el=typeof selector==='string'?document.querySelector(selector):selector;
      const target=el||document.body;
      if(target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      requestAnimationFrame(()=>{ window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); try{ target && target.focus({preventScroll:true}); }catch{} });
    }
    function updateStatus(msg){ const el=$('#statusMsg'); if(el) el.textContent=msg||''; }
    const onlyDigitsLatin = (s)=>/^[0-9A-Za-z .,:;'"()\-+/*]+$/.test(s||'');

    /* ========= Screens ========= */
    const SCREENS=['welcomeScreen','nameScreen','topicsScreen','programScreen','settingsScreen','gameScreen','resultsScreen','mistakesScreen','profileScreen'];
    function showScreen(id){ SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden')); $('#'+id)?.classList.remove('hidden'); window.scrollTo({top:0,left:0,behavior:'auto'}); }

    /* ========= Topics & Programs ========= */
    const Topics = [
      {key:'motion', label:'×ª× ×•×¢×” ×•×›×•×—', emoji:'ğŸƒâ€â™‚ï¸'},
      {key:'gravity', label:'×›×•×— ×”××©×™×›×”', emoji:'ğŸª¨'},
      {key:'light', label:'××•×¨ ×•×¦×œ', emoji:'ğŸ’¡'},
      {key:'sound', label:'×§×•×œ ×•×’×œ×™×', emoji:'ğŸ”Š'},
      {key:'electric', label:'×—×©××œ ×•××¢×’×œ×™×', emoji:'âš¡'},
      {key:'matter', label:'×—×•××¨ ×•××¦×‘×™ ×¦×‘×™×¨×”', emoji:'ğŸ§Š'},
      {key:'energy', label:'×× ×¨×’×™×” ×•×—×•×', emoji:'ğŸ”¥'},
      {key:'space', label:'×›×“×•×¨ ×”××¨×¥ ×•×”×—×œ×œ', emoji:'ğŸª'},
      {key:'measure', label:'××“×™×“×•×ª ×•×›×œ×™×', emoji:'ğŸ“'},
      {key:'magnet', label:'××’× ×˜×™×', emoji:'ğŸ§²'},
    ];

    const Programs = [
      {key:'p1', label:'×', emoji:'ğŸ’'},
      {key:'p2', label:'×‘', emoji:'âœï¸'},
      {key:'p3', label:'×’-×“', emoji:'ğŸ”¬'},
      {key:'p4', label:'×”-×–', emoji:'ğŸ§ª'},
    ];

    /* ========= FACTS Bank (× ×•×©× + ×›×™×ª×” + ×¨××•×ª ×§×•×©×™ ×¢× × ×™×¡×•×—×™×) ========= */
    const FACTS = [
      /* Gravity */
      { id:'grav_pull', topic:'gravity', programs:['p1','p2','p3','p4'], group:'gravity_terms', correct:'×›×•×— ×”××©×™×›×”',
        explain:'×›×•×— ×©××•×©×š ×—×¤×¦×™× ××œ ××¨×›×– ×›×“×•×¨ ×”××¨×¥.',
        stems:{ easy:['××” ××•×©×š ×—×¤×¦×™× ××œ ×”×§×¨×§×¢?'], medium:['×œ××” ×›×“×•×¨ ×©× ×–×¨×§ ×œ××¢×œ×” ×—×•×–×¨ ×œ××˜×”?'], hard:['××™×–×” ×›×•×— ××¡×‘×™×¨ × ×¤×™×œ×” ×—×•×¤×©×™×ª ×©×œ ×’×•×£?'] }
      },

      /* Motion */
      { id:'motion_friction', topic:'motion', programs:['p1','p2','p3','p4'], group:'motion_forces', correct:'×—×™×›×•×š',
        explain:'×”×›×•×— ×©××ª× ×’×“ ×œ×ª× ×•×¢×” ×‘×™×Ÿ ××©×˜×—×™×.',
        stems:{ easy:['××™×–×” ×›×•×— ×××˜ ×ª× ×•×¢×” ×¢×œ ×”×§×¨×§×¢?'], medium:['×¢×’×œ×” × ×¡×¢×” ×•× ×¢×¦×¨×” ×œ×‘×“. ××” ×’×¨× ×œ×” ×œ×¢×¦×•×¨?'], hard:['×”×—×œ×§×” ×™×•×¨×“×ª ×¢× ×”×–××Ÿ ×¢×œ ××©×˜×— ××—×•×¡×¤×¡. ××” ×”×¡×™×‘×”?'] }
      },
      { id:'motion_parachute', topic:'motion', programs:['p2','p3','p4'], group:'motion_drag', correct:'×’×¨×¨ ××•×•×™×¨',
        explain:'×©×˜×— ×’×“×•×œ ×™×•×¦×¨ ×”×ª× ×’×“×•×ª ××•×•×™×¨ ×©×××˜×ª ××ª ×”× ×¤×™×œ×”.',
        stems:{ easy:['××” ×’×•×¨× ×œ××¦× ×— ×œ×”××˜ × ×¤×™×œ×”?'], medium:['×¦× ×—×Ÿ ×¤×•×ª×— ××¦× ×— ×•×××˜. ××™×–×” ×›×•×— ×¤×•×¢×œ ×¢×œ×™×•?'], hard:['××™×š ×”×’×“×œ×ª ×©×˜×— ×”×—×ª×š ××©×¤×™×¢×” ×¢×œ ××”×™×¨×•×ª × ×¤×™×œ×” ×‘××•×•×™×¨?'] }
      },

      /* Light */
      { id:'light_speed', topic:'light', programs:['p1','p2','p3','p4'], group:'light_speed', correct:'××•×¨ ××”×™×¨ ×™×•×ª×¨',
        explain:'×”××•×¨ × ×¢ ××”×¨ ×‘×”×¨×‘×” ××”×§×•×œ, ×œ×›×Ÿ ×× ×• ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×©×©×•××¢×™× ×¨×¢×.',
        stems:{ easy:['×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×©×©×•××¢×™× ×¨×¢×?'], medium:['××™ × ×¢ ××”×¨ ×™×•×ª×¨ ×‘××•×•×™×¨: ××•×¨ ××• ×§×•×œ?'], hard:['××™×–×• ×ª×•×¤×¢×” ××¡×‘×™×¨×” ×¨××™×™×ª ×”×‘×¨×§ ×œ×¤× ×™ ×”×¨×¢×?'] }
      },
      { id:'light_refraction_color', topic:'light', programs:['p3','p4'], group:'color_refraction', correct:'×¡×’×•×œ',
        explain:'×‘×§×¦×” ×”×¡×’×œ×’×œ ×©×œ ×”×¡×¤×§×˜×¨×•× ×”×©×‘×™×¨×” ×—×–×§×” ×™×•×ª×¨ ×•×œ×›×Ÿ ×”×¡×˜×™×™×” ×’×“×•×œ×” ×™×•×ª×¨.',
        stems:{ easy:['××™×–×” ×¦×‘×¢ × ×©×‘×¨ ×”×›×™ ×”×¨×‘×” ×‘××™×?'], medium:['×‘××•×¨ ×œ×‘×Ÿ ×”×¢×•×‘×¨ ×‘×¤×¨×™×–××”: ××™×–×” ×¦×‘×¢ ××ª×¢×§× ×™×•×ª×¨?'], hard:['×‘×§×©×ª ×¦×‘×¢×™×, ××™×–×” ×¦×‘×¢ ×¢×•×‘×¨ ×¡×˜×™×™×” ×–×•×•×™×ª×™×ª ×’×“×•×œ×” ×™×•×ª×¨?'] }
      },
      { id:'light_behavior', topic:'light', programs:['p1','p2','p3','p4'], group:'light_behave', correct:'××•×—×–×¨',
        explain:'×‘××¨××” ×¨×•×‘ ×”××•×¨ ××•×—×–×¨.',
        stems:{ easy:['××” ×§×•×¨×” ×œ××•×¨ ×›××©×¨ ×”×•× ×¤×•×’×¢ ×‘××¨××”?'], medium:['××•×¨ ×”×¤×•×’×¢ ×‘××©×˜×— ××‘×¨×™×§: ××” ×™×§×¨×” ×‘×¢×™×§×¨?'], hard:['××™×–×• ×ª×•×¤×¢×” ×“×•××™× × ×˜×™×ª ×‘××¨××” ××•×©×œ××ª?'] }
      },

      /* Sound */
      { id:'sound_amplitude', topic:'sound', programs:['p1','p2','p3','p4'], group:'sound_amp', correct:'×”×§×•×œ ×—×–×§ ×™×•×ª×¨',
        explain:'×××¤×œ×™×˜×•×“×” ×’×‘×•×”×” ×™×•×ª×¨ = ×¢×•×¦××” ×’×‘×•×”×” ×™×•×ª×¨, ×œ× ×’×•×‘×” ×¦×œ×™×œ.',
        stems:{ easy:['×›×©××¢×œ×™× ××ª ×¢×•×¦××ª ×”×¦×œ×™×œ ××” ×§×•×¨×”?'], medium:['×× ×××¤×œ×™×˜×•×“×ª ×’×œ ×”×§×•×œ ×’×“×œ×”: ××” ×™×§×¨×”?'], hard:['××” ×”×§×©×¨ ×‘×™×Ÿ ×××¤×œ×™×˜×•×“×” ×©×œ ×§×•×œ ×œ×ª×—×•×©×ª ×”×—×•×–×§?'] }
      },
      { id:'sound_medium', topic:'sound', programs:['p2','p3','p4'], group:'sound_medium', correct:'×—×•××¨ ×›××• ××•×•×™×¨ ××• ××™×',
        explain:'×§×•×œ ×”×•× ×’×œ ××›× ×™ ×•×–×§×•×§ ×œ×ª×•×•×š ×—×•××¨×™.',
        stems:{ easy:['×§×•×œ × ×¢ ×“×¨×š ××”?'], medium:['×”×× ×§×•×œ ×™×›×•×œ ×œ× ×•×¢ ×‘×¨×™×§ ××•×—×œ×˜?'], hard:['×œ××” ×§×•×œ ××™× ×• ××ª×§×“× ×‘×—×œ×œ ×¨×™×§?'] }
      },

      /* Electricity */
      { id:'elec_closed', topic:'electric', programs:['p1','p2','p3','p4'], group:'elec_closed', correct:'×”× ×•×¨×” ×ª×“×œ×§',
        explain:'×‘××¢×’×œ ×¡×’×•×¨ ×”×–×¨× ×–×•×¨× ×•×”× ×•×¨×” × ×“×œ×§×ª.',
        stems:{ easy:['×‘××¢×’×œ ×¡×’×•×¨ ×¢× ×¡×•×œ×œ×” ×•× ×•×¨×”, ××” ×™×§×¨×”?'], medium:['×¡×’×¨× ×• ××ª×’ ×‘××¢×’×œ ×¢× × ×•×¨×”. ××” ×¦×¤×•×™?'], hard:['××” ×”×ª× ××™ ×œ×”×“×œ×§×ª × ×•×¨×” ×‘××¢×’×œ ×¤×©×•×˜?'] }
      },
      { id:'elec_open', topic:'electric', programs:['p1','p2','p3','p4'], group:'elec_open', correct:'×—×¡×¨ ××¢×’×œ ×¡×’×•×¨',
        explain:'×‘××¢×’×œ ×¤×ª×•×— ××™×Ÿ ×–×¨× ×•×œ×›×Ÿ ×”× ×•×¨×” ×œ× ×“×•×œ×§×ª.',
        stems:{ easy:['××“×•×¢ × ×•×¨×” ×œ× ×“×•×œ×§×ª ×‘××¢×’×œ ×¤×ª×•×—?'], medium:['×‘××¢×’×œ ×¢× × ×ª×§: ××” ×™×§×¨×” ×œ×–×¨×?'], hard:['××” ×”×¡×™×‘×” ×œ××™ ×–×¨×™××ª ×–×¨× ×›××©×¨ ×™×© ×”×¤×¡×§×” ×‘××•×œ×™×š?'] }
      },

      /* Matter & Phase changes â€” ×œ×œ× ×—×™×¦×™×; â€œ×â€¦ ×œâ€¦â€ */
      { id:'thermometer', topic:'matter', programs:['p1','p2','p3','p4'], group:'matter_thermo', correct:'×˜××¤×¨×˜×•×¨×”',
        explain:'××“×—×•× ××•×“×“ ×›××” ×—× ××• ×§×¨ â€” ××ª ×”×˜××¤×¨×˜×•×¨×”.',
        stems:{ easy:['××” ××•×“×“ ××“×—×•×?'], medium:['××™×–×• ×›××•×ª ×¤×™×–×™×§×œ×™×ª × ××“×“×ª ×‘××“×—×•×?'], hard:['××“×—×•× × ×•×¢×“ ×œ××“×•×“ ××ª ×”×˜××¤×¨×˜×•×¨×”.'] }
      },
      { id:'density_float', topic:'matter', programs:['p2','p3','p4'], group:'matter_density', correct:'×¦×¤×™×¤×•×ª × ××•×›×” ×××™×',
        explain:'×’×•×£ ×™×¦×•×£ ×× ×”×¦×¤×™×¤×•×ª ×”×××•×¦×¢×ª ×©×œ×• × ××•×›×” ××–×• ×©×œ ×”× ×•×–×œ.',
        stems:{ easy:['××” ×§×•×‘×¢ ×× ×¡×¤×™× ×” ×ª×¦×•×£?'], medium:['××ª×™ ×’×•×£ ×™×¦×•×£ ×¢×œ ×¤× ×™ ××™×?'], hard:['××™×–×” ×ª× ××™ ×‘×¦×¤×™×¤×•×ª ×××¤×©×¨ ×¦×™×¤×” ×‘××™×?'] }
      },

      /* ××¢×‘×¨×™ ××¦×‘ ×¦×‘×™×¨×” */
      { id:'phase_melt', topic:'matter', programs:['p1','p2','p3','p4'], group:'matter_states', correct:'×”×ª×›×”',
        explain:'××¢×‘×¨ ×××•×¦×§ ×œ× ×•×–×œ × ×§×¨× ×”×ª×›×”.',
        stems:{ easy:['××” ×©××• ×©×œ ××¢×‘×¨ ×××•×¦×§ ×œ× ×•×–×œ?'], medium:['××™×š × ×§×¨× ×ª×”×œ×™×š ×—×™××•× ×§×¨×— ×¢×“ ×©×”×•× ×”×•×¤×š ×œ× ×•×–×œ?'], hard:['××”×• ×”×©× ×”××“×¢×™ ×œ××¢×‘×¨ ×××¦×‘ ××•×¦×§ ×œ× ×•×–×œ?'] }
      },
      { id:'phase_freeze', topic:'matter', programs:['p1','p2','p3','p4'], group:'matter_states', correct:'×§×™×¤××•×Ÿ',
        explain:'××¢×‘×¨ ×× ×•×–×œ ×œ××•×¦×§ × ×§×¨× ×§×™×¤××•×Ÿ (×§×¤×™××”).',
        stems:{ easy:['××™×š × ×§×¨× ×”××¢×‘×¨ ×× ×•×–×œ ×œ××•×¦×§?'], medium:['××™× ×©×”×•×¤×›×™× ×œ×§×¨×—: ××” ×©× ×”×ª×”×œ×™×š?'], hard:['××”×• ×”×©× ×œ××¢×‘×¨ ×××¦×‘ × ×•×–×œ ×œ××•×¦×§?'] }
      },
      { id:'phase_evap', topic:'matter', programs:['p2','p3','p4'], group:'matter_states', correct:'×”×ª××™×™×“×•×ª',
        explain:'××¢×‘×¨ ×× ×•×–×œ ×œ×’×– × ×§×¨× ×”×ª××™×™×“×•×ª (××• ×¨×ª×™×—×” ×‘×ª× ××™× ××¡×•×™××™×).',
        stems:{ easy:['××™×š × ×§×¨× ×”××¢×‘×¨ ×× ×•×–×œ ×œ×’×–?'], medium:['××™× ×©×”×•×¤×›×™× ×œ××“×™×: ××” ×©× ×”×ª×”×œ×™×š?'], hard:['××”×• ×”××¢×‘×¨ ×××¦×‘ × ×•×–×œ ×œ×’×–?'] }
      },
      { id:'phase_cond', topic:'matter', programs:['p2','p3','p4'], group:'matter_states', correct:'×¢×™×‘×•×™',
        explain:'××¢×‘×¨ ××’×– ×œ× ×•×–×œ × ×§×¨× ×¢×™×‘×•×™.',
        stems:{ easy:['××™×š × ×§×¨× ×”××¢×‘×¨ ××’×– ×œ× ×•×–×œ?'], medium:['××“×™ ××™× ×©×”×•×¤×›×™× ×œ×˜×™×¤×•×ª: ××” ×©× ×”×ª×”×œ×™×š?'], hard:['××”×• ×”××¢×‘×¨ ×××¦×‘ ×’×– ×œ× ×•×–×œ?'] }
      },
      { id:'phase_subl', topic:'matter', programs:['p3','p4'], group:'matter_states', correct:'×¡×•×‘×œ×™××¦×™×”',
        explain:'××¢×‘×¨ ×××•×¦×§ ×œ×’×– ×‘×œ×™ ×œ×”×¤×•×š ×œ× ×•×–×œ ×‘×××¦×¢.',
        stems:{ easy:['××™×š × ×§×¨× ××¢×‘×¨ ×××•×¦×§ ×™×©×™×¨×•×ª ×œ×’×–?'], medium:['×™×•×“ ×©×¢×•×‘×¨ ×××•×¦×§ ×œ×’×–: ××” ×©× ×”×ª×”×œ×™×š?'], hard:['××”×• ×”×©× ×”××“×¢×™ ×œ××¢×‘×¨ ×××¦×‘ ××•×¦×§ ×œ×’×– ×œ×œ× ×‘×™× ×™×™×?'] }
      },
      { id:'phase_depo', topic:'matter', programs:['p3','p4'], group:'matter_states', correct:'×¨×™×‘×•×¥',
        explain:'××¢×‘×¨ ××’×– ×œ××•×¦×§ ×‘×œ×™ ×œ×”×™×•×ª × ×•×–×œ ×‘×××¦×¢.',
        stems:{ easy:['××™×š × ×§×¨× ××¢×‘×¨ ××’×– ×™×©×™×¨×•×ª ×œ××•×¦×§?'], medium:['××“×™× ×©×”×•×¤×›×™× ×œ×§×¨×— ×‘×œ×™ ×©×œ×‘ × ×•×–×œ×™: ××” ×©× ×”×ª×”×œ×™×š?'], hard:['××”×• ×”××¢×‘×¨ ×××¦×‘ ×’×– ×œ××•×¦×§ ×œ×œ× ×©×œ×‘ × ×•×–×œ×™?'] }
      },
      { id:'clouds', topic:'matter', programs:['p1','p2','p3','p4'], group:'matter_cloud', correct:'×’×– ×•×˜×™×¤×•×ª ×–×¢×™×¨×•×ª',
        explain:'×¢× ×Ÿ ×”×•× ××“×™ ××™× ×•×˜×™×¤×•×ª ×–×¢×™×¨×•×ª ×‘××•×•×™×¨.',
        stems:{ easy:['×××” ×¢×©×•×™ ×¢× ×Ÿ ×‘×¢×™×§×¨?'], medium:['××” ×”××¨×›×™×‘ ×”×¢×™×§×¨×™ ×‘×¢× × ×™×?'], hard:['×¢× ×Ÿ ×”×•× ×ª×¢×¨×•×‘×ª ×©×œ ××“×™ ××™× ×•×˜×™×¤×•×ª ×–×¢×™×¨×•×ª ×‘××•×•×™×¨.'] }
      },

      /* Energy */
      { id:'energy_kin', topic:'energy', programs:['p1','p2','p3','p4'], group:'energy_types', correct:'×§×™× ×˜×™×ª',
        explain:'×× ×¨×’×™×™×ª ×ª× ×•×¢×” × ×§×¨××ª ×× ×¨×’×™×” ×§×™× ×˜×™×ª.',
        stems:{ easy:['××™×–×• ×× ×¨×’×™×” ×™×© ×œ×ª× ×•×¢×”?'], medium:['××” ×©××” ×©×œ ×× ×¨×’×™×™×ª ×”×ª× ×•×¢×”?'], hard:['×× ×¨×’×™×™×ª ×ª× ×•×¢×” × ×§×¨××ª ×× ×¨×’×™×” ×§×™× ×˜×™×ª.'] }
      },
      { id:'energy_elastic', topic:'energy', programs:['p2','p3','p4'], group:'energy_types', correct:'×¤×•×˜× ×¦×™××œ×™×ª ××œ×¡×˜×™×ª',
        explain:'×‘×§×¤×™×¥ ×“×—×•×¡ × ××’×¨×ª ×× ×¨×’×™×” ×¤×•×˜× ×¦×™××œ×™×ª ××œ×¡×˜×™×ª.',
        stems:{ easy:['××™×–×• ×× ×¨×’×™×” × ××’×¨×ª ×‘×§×¤×™×¥ ×“×—×•×¡?'], medium:['×§×¤×™×¥ × ××ª×—: ××™×–×• ×× ×¨×’×™×” × ××’×¨×ª ×‘×•?'], hard:['××™×–×” ×¡×•×’ ×× ×¨×’×™×” ×××¤×™×™×Ÿ ××œ×¡×˜×™×•×ª?'] }
      },
      { id:'gas_heat', topic:'energy', programs:['p2','p3','p4'], group:'gas_heat', correct:'××ª×¨×—×‘',
        explain:'×—×™××•× ×’×– ××’×“×™×œ ××ª ×”×× ×¨×’×™×” ×•××ª ×”× ×¤×— (×‘×ª× ××™ ×œ×—×¥ ×§×‘×•×¢).',
        stems:{ easy:['××” ×§×•×¨×” ×œ× ×¤×— ×’×– ×›×©××—×××™× ××•×ª×•?'], medium:['×’×– ××—×•×× ×‘×œ×—×¥ ×§×‘×•×¢: ××” ×§×•×¨×” ×œ× ×¤×—?'], hard:['××™×š ××©×¤×™×¢ ×—×™××•× ×¢×œ × ×¤×— ×’×–?'] }
      },

      /* Space / Earth */
      { id:'sunset', topic:'light', programs:['p1','p2','p3','p4'], group:'space_sunset', correct:'×”××•×•×™×¨ ××¢×§× ××•×¨',
        explain:'×”××˜××•×¡×¤×™×¨×” ×©×•×‘×¨×ª ××•×¨ ×•×™×•×¦×¨×ª ××©×œ×™×” ×©×”×©××© ×’×“×•×œ×” ×™×•×ª×¨ ×‘×©×§×™×¢×”.',
        stems:{ easy:['×œ××” ×”×©××© × ×¨××™×ª ×’×“×•×œ×” ×‘×©×§×™×¢×”?'], medium:['××™×–×• ×ª×•×¤×¢×” ××•×¤×˜×™×ª ×’×•×¨××ª ×œ××¨××” ×©××© ×’×“×•×œ×” ×‘×©×§×™×¢×”?'], hard:['×©×‘×™×¨×ª ××•×¨ ×‘××˜××•×¡×¤×™×¨×” ××¡×‘×™×¨×” ××ª ×”××¨××” ×©×œ ×©××© ×’×“×•×œ×” ×‘×©×§×™×¢×”.'] }
      },
      { id:'wind', topic:'space', programs:['p2','p3','p4'], group:'wind_source', correct:'×”×©××© ××—×××ª ×œ× ××—×™×“',
        explain:'×”×‘×“×œ×™ ×—×™××•× ×™×•×¦×¨×™× ×”×‘×“×œ×™ ×œ×—×¥ ×©×× ×™×¢×™× ×¨×•×—×•×ª.',
        stems:{ easy:['××” ××§×•×¨ ×”×× ×¨×’×™×” ×œ×¨×•×—?'], medium:['××“×•×¢ × ×•×¦×¨×ª ×¨×•×— ×¢×œ ×¤× ×™ ×›×“×•×¨ ×”××¨×¥?'], hard:['×”×‘×“×œ×™ ×˜××¤×¨×˜×•×¨×” ×•×œ×—×¥ ×‘××˜××•×¡×¤×™×¨×” ×’×•×¨××™× ×œ×¨×•×—×•×ª.'] }
      },

      /* Measurement */
      { id:'si_mass', topic:'measure', programs:['p1','p2','p3','p4'], group:'measure_mass_SI', correct:'×§×™×œ×•×’×¨×',
        explain:'×§×™×œ×•×’×¨× ×”×™× ×™×—×™×“×ª ×”××¡×” ×‘××¢×¨×›×ª SI.',
        stems:{ easy:['××”×™ ×™×—×™×“×ª ×”××¡×” ×‘××¢×¨×›×ª SI?'], medium:['××™×–×• ×™×—×™×“×” ××•×“×“×ª ××¡×” ×‘-SI?'], hard:['×™×—×™×“×ª ×”××¡×” ×”×¡×˜× ×“×¨×˜×™×ª × ×§×¨××ª ×§×™×œ×•×’×¨×.'] }
      },
      { id:'si_force', topic:'measure', programs:['p3','p4'], group:'measure_force_SI', correct:'× ×™×•×˜×•×Ÿ',
        explain:'× ×™×•×˜×•×Ÿ ×”×™× ×™×—×™×“×ª ×”×›×•×— ×‘××¢×¨×›×ª SI.',
        stems:{ easy:['××”×™ ×™×—×™×“×ª ×”×›×•×— ×‘××¢×¨×›×ª SI?'], medium:['××™×–×• ×™×—×™×“×” ××•×“×“×ª ×›×•×—?'], hard:['×›×•×— × ××“×“ ×‘×™×—×™×“×•×ª × ×™×•×˜×•×Ÿ.'] }
      },
      { id:'ruler', topic:'measure', programs:['p1','p2','p3','p4'], group:'measure_ruler', correct:'×¡×¨×’×œ ××• ××˜×¨',
        explain:'×œ××“×™×“×ª ××•×¨×š ××©×ª××©×™× ×‘×¡×¨×’×œ/××˜×¨.',
        stems:{ easy:['×‘××™×–×” ×›×œ×™ ××•×“×“×™× ××•×¨×š ××—×‘×¨×ª?'], medium:['××™×–×” ×›×œ×™ ××ª××™× ×œ××“×™×“×ª ××•×¨×š ×©×•×œ×—×Ÿ?'], hard:['××“×™×“×ª ××•×¨×š × ×¢×©×™×ª ×‘×××¦×¢×•×ª ×¡×¨×’×œ ××• ××˜×¨.'] }
      },

      /* Magnetism */
      { id:'magnet_pull', topic:'magnet', programs:['p1','p2','p3','p4'], group:'magnet_basic', correct:'××’× ×˜',
        explain:'××’× ×˜ ××•×©×š ×—×•××¨×™× ×¤×¨×•××’× ×˜×™×™× ×›×’×•×Ÿ ×‘×¨×–×œ.',
        stems:{ easy:['××” ××•×©×š ×¡×™×›×•×ª ×‘×¨×–×œ?'], medium:['××™×–×” ×—×¤×¥ ×™××©×•×š ×©×‘×‘×™ ×‘×¨×–×œ?'], hard:['××™×–×” ×¢×¦× ××¤×¢×™×œ ×›×•×— ××©×™×›×” ×¢×œ ×‘×¨×–×œ?'] }
      },
      { id:'magnet_poles', topic:'magnet', programs:['p1','p2','p3','p4'], group:'magnet_poles', correct:'×“×—×™×™×”',
        explain:'×§×•×˜×‘×™× ×–×”×™× ×“×•×—×™×, ×©×•× ×™× ××•×©×›×™×.',
        stems:{ easy:['××” ×§×•×¨×” ×‘×™×Ÿ ×§×˜×‘×™× ×–×”×™× ×©×œ ××’× ×˜?'], medium:['××” ×§×•×¨×” ×›××©×¨ ××§×¨×‘×™× N ×œ-N?'], hard:['××¤×’×© ×‘×™×Ÿ ×§×˜×‘×™× ×–×”×™× ×™×•×¦×¨ ×“×—×™×™×”.'] }
      }
    ];

    /* ××¡×™×—×™× × ×•×¡×¤×™× ×œ×¤×™ ×§×‘×•×¦×ª ×™×“×¢ (×œ××§×¨×” ×©××¢×˜ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×”) */
    const EXTRA_DISTRACTORS = {
      gravity_terms: ['××’× ×˜×™×•×ª','×—×™×›×•×š','×¨×•×—','×—×©××œ ×¡×˜×˜×™','×œ×—×¥ ××•×•×™×¨'],
      motion_forces: ['×’×¨×¨ ××•×•×™×¨','×›×•×— ×”××©×™×›×”','×“×—×£','××ª×™×—×”','×ª× ×•×¤×”'],
      motion_drag: ['×—×™×›×•×š','×¦×™×¤×”','××ª×™×—×”','×“×—×£'],
      light_speed: ['×§×•×œ ××”×™×¨ ×™×•×ª×¨','×–×” ×§×•×¨×” ×™×—×“','×ª×œ×•×™ ×‘×¢× × ×™×','××•×•×™×¨ ×—×'],
      color_refraction: ['××“×•×','×™×¨×•×§','×›×—×•×œ'],
      light_behave: ['× ×‘×œ×¢','× ×©×‘×¨','××¤×•×–×¨'],
      sound_amp: ['×”×¦×œ×™×œ ×’×‘×•×” ×™×•×ª×¨','××”×™×¨×•×ª ××©×ª× ×”','×”×›×•×œ ×™×—×“'],
      sound_medium: ['×¨×™×§ ××•×—×œ×˜ ×‘×œ×‘×“','×¨×§ ××ª×›×ª','×¨×§ ×—×•×˜×™×'],
      elec_closed: ['×©×•× ×“×‘×¨','×”×¡×•×œ×œ×” × ×¢×œ××ª','×™×”×™×” ×¦×œ×™×œ'],
      elec_open: ['×¦×¨×™×š ×©×ª×™ ×¡×•×œ×œ×•×ª','×›×‘×œ ×¢×‘×” ×—×¡×¨','×¦×¨×™×š ××ª×’ ×—×›×'],
      matter_thermo: ['××¡×”','×œ×—×¥','××”×™×¨×•×ª'],
      matter_density: ['××©×§×œ ×§×˜×Ÿ','×× ×•×¢ ×—×–×§','××’× ×˜×™×'],
      matter_states: ['×”×ª×›×”','×§×™×¤××•×Ÿ','×”×ª××™×™×“×•×ª','×¢×™×‘×•×™','×¡×•×‘×œ×™××¦×™×”','×¨×™×‘×•×¥'],
      matter_cloud: ['× ×•×–×œ','×§×¨×— ×’×“×•×œ','×¤×œ×–××”'],
      energy_types: ['×—×©××œ×™×ª','×ª×¨××™×ª','××œ×¡×˜×™×ª'],
      gas_heat: ['××ª×›×•×•×¥','× ×¢×œ×','×”×•×¤×š ×œ××™×'],
      space_sunset: ['×”×©××© ××ª×§×¨×‘×ª','×”×™×¨×— ××¡×ª×™×¨','×”×©××© ×’×“×œ×”'],
      wind_source: ['×”×™×¨×—','××’× ×˜×™×','×¨×¢×©'],
      measure_mass_SI: ['× ×™×•×˜×•×Ÿ','××˜×¨','×××¤×¨'],
      measure_force_SI: ['×§×™×œ×•×’×¨×','×¤×¡×§×œ','×’×³××•×œ'],
      measure_ruler: ['××“ ×—×•×','×××•×•×¨×¨','×©× ××™'],
      magnet_basic: ['×›×•×¡ ××™×','×‘×œ×•×Ÿ','× ×™×™×¨'],
      magnet_poles: ['××©×™×›×”','×©×•× ×“×‘×¨','×”×ª×—×××•×ª']
    };
    const GENERIC_DISTRACTORS = ['×—×•×','×§×•×¨','××•×¨','×¦×œ','××™×','××“××”','××ª×›×ª'];

    /* ========= Recent-avoid ========= */
    function getRecentIds(){
      try{ const arr=JSON.parse(sessionStorage.getItem(RECENT_KEY)||'[]'); return Array.isArray(arr)?arr:[]; }catch{ return []; }
    }
    function pushRecentIds(ids){
      try{
        const cur=getRecentIds();
        const merged=[...ids, ...cur].slice(0, 200);
        sessionStorage.setItem(RECENT_KEY, JSON.stringify(merged));
      }catch{}
    }

    /* ========= Bank â†’ Questions ========= */
    function stemsForDiff(fact, diff){
      if(!fact.stems) return [];
      if(diff==='easy') return fact.stems.easy || fact.stems.medium || fact.stems.hard || [];
      if(diff==='medium') return fact.stems.medium || fact.stems.easy || fact.stems.hard || [];
      return fact.stems.hard || fact.stems.medium || fact.stems.easy || [];
    }
    function pickStem(fact, diff){
      const arr = stemsForDiff(fact, diff);
      return sample(arr) || '';
    }
    function buildChoicesForFact(fact){
      const pool = new Set();
      // ×›×œ ×”×ª×©×•×‘×•×ª ×”×ª×§×™× ×•×ª ×”××—×¨×•×ª ×‘×§×‘×•×¦×”
      FACTS.filter(f=>f.group===fact.group && f.correct!==fact.correct).forEach(f=>pool.add(f.correct));
      // ×”×–×¨×§×” ××§×‘×•×¦×ª ×”××¡×™×—×™× ×”× ×•×¡×¤×ª
      (EXTRA_DISTRACTORS[fact.group]||[]).forEach(s=>pool.add(s));
      // × ×§×” ××¤×©×¨×•×ª ×–×”×” ×œ×ª×©×•×‘×” × ×›×•× ×”
      pool.delete(fact.correct);
      // ×‘×—×¨ 3 ××¡×™×—×™×
      const arr = shuffle([...pool]).slice(0,3);
      while(arr.length<3){
        const g = sample(GENERIC_DISTRACTORS);
        if(g && g!==fact.correct && !arr.includes(g)) arr.push(g);
        if(arr.length>20) break;
      }
      const options = shuffle([fact.correct, ...arr].slice(0,4));
      const correctIndex = options.indexOf(fact.correct);
      return { options, correctIndex };
    }

    function filterFacts(topicsSel, programKey){
      return FACTS.filter(f=> topicsSel.has(f.topic) && f.programs.includes(programKey));
    }

    function buildCandidateQuestions(topicsSel, programKey, diff){
      const facts = filterFacts(topicsSel, programKey);
      const qs = [];
      facts.forEach(f=>{
        const stem = pickStem(f, diff);
        if(!stem) return;
        const {options, correctIndex} = buildChoicesForFact(f);
        if(options.length<4 || correctIndex<0) return;
        qs.push({
          id: f.id + '_' + diff,
          conceptId: f.id,
          topic: f.topic,
          level: diff,
          q: stem,
          choices: options,
          correct: correctIndex,
          hint: f.explain || ''
        });
      });
      return qs;
    }

    function buildUniqueSet(requiredCount, topicsSel, diff, programKey){
      const recent = new Set(getRecentIds());
      // ×‘×•× ×™× ×××’×¨ ××•×¢××“×™× ×•××¢×¨×‘×‘×™×
      const pool = shuffle(buildCandidateQuestions(topicsSel, programKey, diff));
      const selected = [];
      const usedConcept = new Set();

      for(const q of pool){
        if(selected.length >= requiredCount) break;
        if(usedConcept.has(q.conceptId)) continue;
        if(recent.has(q.conceptId)) continue;
        selected.push(q);
        usedConcept.add(q.conceptId);
      }
      // ×× ×—×¡×¨ â€“ ×××œ××™× ×‘×œ×™ ×œ×‘×“×•×§ recent
      for(const q of pool){
        if(selected.length >= requiredCount) break;
        if(usedConcept.has(q.conceptId)) continue;
        selected.push(q);
        usedConcept.add(q.conceptId);
      }
      // ×× ×¢×“×™×™×Ÿ ×—×¡×¨ â€“ fallback ××›×œ ×”×‘× ×§ (××•×ª×• diff, ×‘×œ×™ ×¡×™× ×•×Ÿ ×ª×•×›× ×™×ª)
      if(selected.length < requiredCount){
        const extra = shuffle(FACTS.filter(f=>topicsSel.has(f.topic))).map(f=>{
          const stem = pickStem(f, diff);
          const {options, correctIndex} = buildChoicesForFact(f);
          return {
            id:f.id+'_'+diff+'_x', conceptId:f.id, topic:f.topic, level:diff,
            q: stem, choices: options, correct: correctIndex, hint: f.explain||''
          };
        }).filter(q=>q.q && q.choices && q.choices.length===4);
        for(const q of extra){
          if(selected.length >= requiredCount) break;
          if(usedConcept.has(q.conceptId)) continue;
          selected.push(q); usedConcept.add(q.conceptId);
        }
      }
      if(selected.length < requiredCount){
        alert('××™×Ÿ ××¡×¤×™×§ ×©××œ×•×ª ×ª×•×××•×ª ×‘×—×™×¨×”. × ×¡×• ×œ×‘×—×•×¨ ×¢×•×“ × ×•×©××™× ××• ×¨××ª ×§×•×©×™ ××—×¨×ª.');
      }
      return selected.slice(0, requiredCount);
    }

    /* ========= Rendering ========= */
    function renderTopics(){
      const grid=$('#topicsGrid'); grid.innerHTML='';
      Topics.forEach(t=>{
        const b=document.createElement('button');
        b.type='button'; b.className='choice-card'; b.setAttribute('data-topic', t.key);
        b.setAttribute('aria-pressed','false');
        b.innerHTML = `<div class="emoji">${t.emoji}</div><div class="text-xl font-extrabold text-gray-800">${t.label}</div>`;
        b.addEventListener('click', ()=>{
          const k=t.key;
          if(selectedTopics.has(k)){ selectedTopics.delete(k); b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); }
          else { selectedTopics.add(k); b.classList.add('selected'); b.setAttribute('aria-pressed','true'); }
          updateTopicsNextState();
        });
        grid.appendChild(b);
      });
      refreshTopicsOverflow();
    }
    let isTopicsExpanded=false;
    function refreshTopicsOverflow(){
      const grid = $('#topicsGrid'), more = $('#topicsMore'), fade = $('#topicsFade');
      if(!grid||!more||!fade) return;
      const all = [...grid.children];
      const visible = all.filter(el => el.offsetParent !== null).length;
      const overflowByHeight = grid.scrollHeight > grid.clientHeight + 2;
      const hasHidden = visible < all.length;
      more.classList.toggle('hidden', !(hasHidden && !isTopicsExpanded));
      fade.classList.toggle('hidden', !(overflowByHeight && !isTopicsExpanded));
    }
    function setTopicsExpanded(expanded){
      isTopicsExpanded=!!expanded;
      const grid=$('#topicsGrid'), more=$('#topicsMore'); if(!grid||!more) return;
      grid.classList.toggle('topics-collapsed', !isTopicsExpanded);
      more.textContent=isTopicsExpanded?'×”×¦×’ ×¤×—×•×ª':'×”×¦×’ ×¢×•×“';
      more.setAttribute('aria-expanded', isTopicsExpanded?'true':'false');
      refreshTopicsOverflow();
    }
    function updateTopicsNextState(){
      const ready = selectedTopics.size>0;
      const nextBtn=$('#topicsNext');
      nextBtn.disabled=!ready; nextBtn.setAttribute('aria-disabled', ready?'false':'true');
    }

    function renderPrograms(){
      const grid = $('#programGrid'); grid.innerHTML='';
      Programs.forEach(p=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='choice-card';
        b.setAttribute('data-program', p.key);
        b.setAttribute('aria-pressed','false');
        b.innerHTML = `<div class="emoji text-3xl">${p.emoji}</div>
                       <div class="text-xl font-extrabold text-gray-800">${p.label}</div>`;
        b.onclick=()=>{
          $$('#programGrid .choice-card').forEach(x=>{x.classList.remove('selected'); x.setAttribute('aria-pressed','false');});
          b.classList.add('selected'); b.setAttribute('aria-pressed','true');
          selectedProgram = p.key;
          updateProgramNext();
        };
        grid.appendChild(b);
      });
    }
    function updateProgramNext(){
      const ready = !!selectedProgram;
      const btn = $('#programNext');
      btn.disabled = !ready;
      btn.setAttribute('aria-disabled', ready?'false':'true');
    }

    /* ========= Game Flow ========= */
    function startGame(){
      const prof=getActiveProfile(); playerName = prof ? prof.name : playerName;
      totalQuestions = selectedCount || 6; questionCount = totalQuestions;
      wrongAnswers = [];
      questions = buildUniqueSet(totalQuestions, selectedTopics, selectedDifficulty, selectedProgram);
      $('#totalQuestions').textContent=String(totalQuestions);
      $('#gamePlayerName').textContent=playerName;
      currentQuestionIndex=0; correctCount=0; selectedAnswer=null; totalTime=0;
      showScreen('gameScreen'); showQuestion(); focusTop('#questionText'); updateStatus('×™×¦×× ×• ×œ×“×¨×š - ×‘×—×¨×• ×ª×©×•×‘×” ×•××– ××©×¨×•');
    }
    function normalizeQuestionMark(txt){
      const q = (txt||'').trim();
      return q.endsWith('?') ? q : (q + '?');
    }
    function showQuestion(){
      if(currentQuestionIndex>=questions.length){ showResultsWithModal(); return; }
      selectedAnswer=null;
      const q=questions[currentQuestionIndex];
      $('#questionText').textContent = normalizeQuestionMark(q.q);
      $('#currentQuestion').textContent=currentQuestionIndex+1;

      // ×¤×¨×•×’×¨×¡ ××™×™×¦×’ ×©××œ×•×ª ×©× ×¢× ×•
      const prog=(currentQuestionIndex/totalQuestions)*100;
      const pb=$('#progressBar');
      const p=Math.round(prog);
      pb.style.width=p+'%'; pb.setAttribute('aria-valuenow',String(p));

      const grid=$('#answersGrid'); grid.innerHTML='';
      const options = shuffle(q.choices.map((txt,i)=>({txt,i})));
      options.forEach((opt)=>{
        const d=document.createElement('div');
        d.className='answer-item shadow-lg';
        d.setAttribute('data-value',String(opt.i));
        d.setAttribute('role','button');
        d.setAttribute('aria-selected','false');

        const isLatin = onlyDigitsLatin(opt.txt);
        const clsDir = isLatin ? 'ltr' : 'rtl';
        const textDiv = document.createElement('div');
        textDiv.className = `answer-text ${clsDir}`;
        textDiv.textContent = opt.txt;

        d.appendChild(textDiv);
        d.addEventListener('click', ()=> chooseAnswer(d, opt.i));
        grid.appendChild(d);
      });

      disableConfirm();
      startTime=Date.now();
    }
    function chooseAnswer(el, idx){
      $$('#answersGrid .answer-item').forEach(x=>{ x.classList.remove('selected'); x.setAttribute('aria-selected','false'); });
      el.classList.add('selected'); el.setAttribute('aria-selected','true');
      selectedAnswer=idx;
      enableConfirm();
    }
    function enableConfirm(){ const btn=$('#confirmButton'); btn.disabled=false; btn.removeAttribute('disabled'); btn.setAttribute('aria-disabled','false'); }
    function disableConfirm(){ const btn=$('#confirmButton'); btn.disabled=true; btn.setAttribute('disabled',''); btn.setAttribute('aria-disabled','true'); }

    $('#confirmButton').addEventListener('click', ()=>{
      if(selectedAnswer===null) return;
      const q=questions[currentQuestionIndex];
      const end=Date.now(); totalTime+=Math.max(0,(end-startTime)/1000);

      const correctIndex = q.correct;
      if(selectedAnswer===correctIndex){
        correctCount++; playSuccessSound(); updateStatus('×›×œ ×”×›×‘×•×“ - ×××©×™×›×™×');
      }else{
        playErrorSound(); updateStatus('×›××¢×˜! ×××©×™×›×™× ×œ×©××œ×” ×”×‘××”');
        wrongAnswers.push({
          q: normalizeQuestionMark(q.q),
          chosen: q.choices[selectedAnswer],
          correct: q.choices[q.correct],
          conceptId: q.conceptId,
          topic: q.topic,
          hint: q.hint || ''
        });
      }

      // ×¢×“×›×Ÿ ×¤×¨×•×’×¨×¡ ×œ××—×¨ ×”××¢× ×” (×›×•×œ×œ 100% ×‘×©××œ×” ×”××—×¨×•× ×”)
      const answered = Math.min(currentQuestionIndex+1, totalQuestions);
      const pct = Math.round((answered/totalQuestions)*100);
      const pb=$('#progressBar'); pb.style.width=pct+'%'; pb.setAttribute('aria-valuenow',String(pct));

      if(currentQuestionIndex===totalQuestions-1){ 
        // ×©××™×¨×ª ××–×”×™× ×œ×× ×™×¢×ª ×—×–×¨×”
        pushRecentIds(questions.map(x=>x.conceptId));
        showResultsWithModal(); 
      }
      else{ currentQuestionIndex++; showQuestion(); }
    });

    function showResultsWithModal(){
      const fb=$('#feedback'), icon=$('#feedbackIcon'), text=$('#feedbackText'), nextBtn=$('#nextButton');
      const pct=Math.round((correctCount/totalQuestions)*100);
      if(pct===100){ icon.textContent='ğŸ‘'; text.className='text-2xl font-extrabold mb-6 text-green-600'; text.textContent='××“×”×™×! ×¡×™×™×× ×• ××ª ×”×¡×˜'; }
      else if(pct>=60){ icon.textContent='ğŸ‘'; text.className='text-2xl font-extrabold mb-6 text-blue-600'; text.textContent='×™×¤×”! ×¡×™×™×× ×• ××ª ×”×¡×˜'; }
      else{ icon.textContent='ğŸ’ª'; text.className='text-2xl font-extrabold mb-6 text-orange-600'; text.textContent='×¡×™×™×× ×• ××ª ×”×¡×˜'; }
      nextBtn.onclick=()=>{ $('#feedback').classList.add('hidden'); showResults(); };
      fb.classList.remove('hidden');
      trapDialog('#feedback');
    }

    function showResults(){
      showScreen('resultsScreen');

      const incorrect=totalQuestions-correctCount;
      const pct=Math.round((correctCount/totalQuestions)*100);
      const prof=getActiveProfile(); const displayName=prof?prof.name:playerName;
      $('#resultsTitle').textContent = getResultsTitleCopy(displayName,pct);

      updatePerformanceBar(correctCount,incorrect,pct);
      $('#correctAnswers').textContent=String(correctCount);
      $('#resultsTotal').textContent=String(totalQuestions);
      $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions)));

      const topicsSummary=[...selectedTopics];
      logSessionToProfile(topicsSummary);

      // "×œ×œ××•×“ ××”×˜×¢×•×™×•×ª" ×–××™×Ÿ ×¨×§ ×× ×™×© ×˜×¢×•×™×•×ª
      const learnBtn = $('#learnBtn');
      learnBtn.disabled = wrongAnswers.length===0;
      learnBtn.classList.toggle('opacity-50', wrongAnswers.length===0);

      focusTop('#resultsTitle');
    }
    function getResultsTitleCopy(name,pct){
      if(pct===0) return `×œ× × ×•×¨× ${name}, × × ×¡×” ×©×•×‘ ×•× ×©×ª×¤×¨`;
      else if(pct<=59) return `${name}, ×¨×•××™× ×”×ª×§×“××•×ª - ×××©×™×›×™× ×œ×ª×¨×’×œ`;
      else if(pct<=79) return `${name}, ×¢×‘×•×“×” ×™×¤×” - ×¢×•×“ ×§×¦×ª ×•×©×•×œ×˜×™×`;
      else if(pct<=89) return `×•××•×• ${name}, ×©×œ×™×˜×” ××¨×©×™××”`;
      return `×›×œ ×”×›×‘×•×“ ${name}, ×©×•×¤×™ ×’××” ×‘×š`;
    }
    function updatePerformanceBar(correct,incorrect,pct){
      $('#correctBar').style.width=(correct/totalQuestions*100)+'%';
      $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%';
      $('#performancePercentage').textContent=pct+'%';
      $('#correctCount').textContent=String(correct);
      $('#incorrectCount').textContent=String(incorrect);
    }

    /* ========= Learn from Mistakes ========= */
    const TERM_EXPLAIN = {
      '×§×™× ×˜×™×ª': '×× ×¨×’×™×™×ª ×ª× ×•×¢×”. ×›×©×—×¤×¥ × ×¢, ×™×© ×œ×• ×× ×¨×’×™×” ×§×™× ×˜×™×ª â€” ×›×›×œ ×©×”×•× × ×¢ ××”×¨ ××• ×›×‘×“ ×™×•×ª×¨, ×”×× ×¨×’×™×” ×’×“×•×œ×” ×™×•×ª×¨.',
      '×××¤×œ×™×˜×•×“×”': '×’×•×‘×” ×”×’×œ. ×‘×§×•×œ, ×××¤×œ×™×˜×•×“×” ×’×‘×•×”×” ×¤×™×¨×•×©×” ×§×•×œ ×—×–×§ ×™×•×ª×¨ (×œ× â€œ×¦×œ×™×œ ×’×‘×•×”â€ ×™×•×ª×¨).',
      '×¦×¤×™×¤×•×ª': '×›××” ×—×•××¨ ×™×© ×‘× ×¤×— ××¡×•×™×. ×× ×¦×¤×™×¤×•×ª ×”×¡×¤×™× ×” ×§×˜× ×” ××–×• ×©×œ ××™× â€” ×”×™× ×¦×¤×”.'
    };
    function getSimpleExplanation(item){
      const add = [];
      const words = `${item.q} ${item.correct}`.split(/\s+/);
      Object.keys(TERM_EXPLAIN).forEach(k=>{
        if(words.some(w=>w.includes(k))) add.push(TERM_EXPLAIN[k]);
      });
      const base = item.hint ? item.hint : '';
      if(base && add.length) return base + ' ' + add.join(' ');
      if(add.length) return add.join(' ');
      return base || '×”×¡×‘×¨: × × ×¡×” ×œ×ª××¨ ××ª ×”×¢×™×§×¨×•×Ÿ ×”××¨×›×–×™ ×‘×¤×©×˜×•×ª ×•×‘×“×•×’××” ×™×•××™×•××™×ª.';
    }

    function renderMistakes(){
      const box = $('#mistakesList'); box.innerHTML='';
      if(wrongAnswers.length===0){
        box.innerHTML = '<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 text-center">××™×Ÿ ×˜×¢×•×™×•×ª ×‘×¡×˜ ×”×–×”. ×›×œ ×”×›×‘×•×“!</div>';
        return;
      }
      wrongAnswers.forEach((it, idx)=>{
        const card = document.createElement('div');
        card.className = 'p-4 rounded-2xl border-2 border-amber-200 bg-amber-50';
        const exp = getSimpleExplanation(it);
        card.innerHTML = `
          <div class="font-extrabold text-gray-900 mb-2">×©××œ×” ${idx+1}: ${escapeHtml(it.q)}</div>
          <div class="text-sm text-gray-700 mb-1">×”×ª×©×•×‘×” ×©×‘×—×¨×ª×: <span class="font-extrabold text-orange-600">${escapeHtml(it.chosen||'')}</span></div>
          <div class="text-sm text-gray-700 mb-2">×”×ª×©×•×‘×” ×”× ×›×•× ×”: <span class="font-extrabold text-green-700">${escapeHtml(it.correct||'')}</span></div>
          <button class="mt-2 px-3 py-2 rounded-lg bg-white border-2 border-amber-200 font-bold toggle-exp">×”×¡×‘×¨</button>
          <div class="exp mt-3 hidden text-gray-800">${escapeHtml(exp)}</div>
        `;
        const btn = card.querySelector('.toggle-exp');
        const expDiv = card.querySelector('.exp');
        btn.addEventListener('click', ()=>{ expDiv.classList.toggle('hidden'); });
        box.appendChild(card);
      });
    }

    /* ========= Modals Trap ========= */
    function trapDialog(modalSel){
      const modal=$(modalSel); if(!modal) return;
      const getF=()=>modal.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])');
      function onKey(e){
        if(e.key==='Escape'){ modal.classList.add('hidden'); modal.removeEventListener('keydown',onKey); return; }
        if(e.key!=='Tab') return;
        const f=[...getF()]; if(!f.length) return;
        const first=f[0], last=f[f.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      modal.addEventListener('keydown',onKey);
      requestAnimationFrame(()=>{ const f=getF()[0]; f && f.focus(); });
    }

    /* ========= Profile ========= */
    function showProfile(){ showScreen('profileScreen'); renderProfile(); focusTop('#profileScreen .text-indigo-600'); updateStatus(''); }
    function setSwitchBtnDisabled(disabled){ const btn=$('#profileSwitchBtn'); if(!btn) return; btn.disabled=disabled; btn.classList.toggle('opacity-50', disabled); btn.classList.toggle('cursor-not-allowed', disabled); }
    function renderProfile(){
      const prof=getActiveProfile(); const header=$('#profileHeader'); const totalUsers=profilesArr().length;
      setSwitchBtnDisabled(totalUsers<=1);
      if(!prof){
        header.textContent='××™×Ÿ ××©×ª××© ×¤×¢×™×œ. × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××©×ª××© ×—×“×© ××• ×œ×”×—×œ×™×£ ×œ××©×ª××© ×§×™×™×.';
        $('#kpiSets').textContent='0'; $('#kpiAccuracy').textContent='0%'; $('#kpiAvg').textContent='0s';
        $('#byTopicGrid').innerHTML=''; $('#historyList').innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>';
        return;
      }
      header.innerHTML=`××©×ª××© ×¤×¢×™×œ: <span class="font-extrabold text-gray-900">${escapeHtml(prof.name)}</span>`;
      const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0};
      const acc=tot.questions>0?Math.round((tot.correct/tot.questions)*100):0;
      const avg=tot.questions>0?Math.round(tot.timeSec/tot.questions):0;
      $('#kpiSets').textContent=String(tot.sets||0);
      $('#kpiAccuracy').textContent=acc+'%';
      $('#kpiAvg').textContent=(avg||0)+'s';

      const grid=$('#byTopicGrid'); grid.innerHTML='';
      Topics.forEach(t=>{
        const b=prof.byTopic?.[t.key]||{sets:0,questions:0,correct:0,timeSec:0};
        const a=b.questions?Math.round(b.correct/b.questions*100):0;
        const card=document.createElement('div');
        card.className='p-4 rounded-2xl border-2 border-gray-200 bg-gray-50';
        card.innerHTML=`<div class="font-extrabold mb-2">${t.emoji} ${t.label}</div>
          <div class="text-sm text-gray-600 mb-1">×¡×˜×™×: <span class="ltr">${b.sets||0}</span></div>
          <div class="text-sm text-gray-600 mb-1">×“×™×•×§: <span class="ltr">${a}%</span></div>
          <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div style="width:${a}%" class="h-2 bg-blue-500"></div></div>`;
        grid.appendChild(card);
      });

      const h=prof.history||[]; const list=$('#historyList'); list.innerHTML='';
      if(h.length===0){
        list.innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>';
      }else{
        h.slice(0,12).forEach(item=>{
          const pct=Math.round((item.correct/item.count)*100);
          const row=document.createElement('div');
          row.className='p-3 border-2 border-gray-200 rounded-xl bg-white flex items-center justify-between gap-3';
          const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'});
          row.innerHTML=`<div>
              <div class="text-sm text-gray-500">${date}</div>
              <div class="text-gray-800">${item.topics.map(k=> Topics.find(t=>t.key===k)?.label || k).join(' - ')}</div>
              <div class="text-sm text-gray-500">×¨××”: ${item.diff} - ×©××œ×•×ª: ${item.count}</div>
            </div>
            <div class="text-right">
              <div class="text-xl font-extrabold ${pct===100?'text-green-600': pct>=60?'text-blue-600':'text-orange-600'} ltr">${pct}%</div>
            </div>`;
          list.appendChild(row);
        });
      }
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    /* ========= Wiring ========= */
    function bindUI(){
      window.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });
      window.addEventListener('touchend',   unlockAudioOnce, { once:true, passive:true });
      window.addEventListener('pointerdown',unlockAudioOnce, { once:true, capture:true });
      window.addEventListener('click',      unlockAudioOnce, { once:true, capture:true });

      $('#startBtn')?.addEventListener('click', e=>{ e.preventDefault(); unlockAudioOnce(); showNameInput(); });
      $('#nameForm')?.addEventListener('submit', e=>{ e.preventDefault(); unlockAudioOnce(); showTopics(); });

      $('#profileOrSwitchBtn')?.addEventListener('click',()=>{ const arr=profilesArr(); if(arr.length>1) showUserPicker(); else showProfile(); });
      $('#profileBtn')?.addEventListener('click',()=> showProfile());
      $('#profileFromResultsBtn')?.addEventListener('click',()=> showProfile());

      $('#userPickerCancel')?.addEventListener('click',()=>{ $('#userPickerModal').classList.add('hidden'); });
      $('#newUserBtn')?.addEventListener('click',()=>{ $('#userPickerModal').classList.add('hidden'); $('#playerName').value=''; $('#playerName').focus(); });

      $('#profileStartBtn')?.addEventListener('click',()=>{
        const prof=getActiveProfile();
        if(!prof){ showNameInput(); return; }
        playerName=prof.name;
        showTopics();
      });
      $('#profileSwitchBtn')?.addEventListener('click',()=>{ if(profilesArr().length>1) showUserPicker(); });
      $('#profileNewBtn')?.addEventListener('click',()=>{ store.activeId=null; saveStore(); showNameInput(); });

      $('#topicsMore')?.addEventListener('click',()=> setTopicsExpanded(!isTopicsExpanded));
      window.addEventListener('resize', refreshTopicsOverflow);

      $('#topicsNext')?.addEventListener('click',()=> showProgram());
      $('#programNext')?.addEventListener('click',()=> showSettings());

      // settings: count & difficulty (××™×Ÿ ×‘×¨×™×¨×ª ××—×“×œ)
      $('#countChips')?.addEventListener('click', e=>{
        const chip = e.target.closest('.chip'); if(!chip) return;
        $$('#countChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
        chip.classList.add('selected'); chip.setAttribute('aria-pressed','true');
        selectedCount = parseInt(chip.getAttribute('data-count'),10);
        updateSettingsNext();
      });
      $('#difficultyChips')?.addEventListener('click', e=>{
        const chip = e.target.closest('.chip'); if(!chip) return;
        $$('#difficultyChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
        chip.classList.add('selected'); chip.setAttribute('aria-pressed','true');
        selectedDifficulty = chip.getAttribute('data-diff');
        updateSettingsNext();
      });
      $('#settingsNext')?.addEventListener('click',()=> startGame());

      // game
      $('#restartBtn')?.addEventListener('click',()=> showNameInput());

      // results actions
      $('#retryBtn')?.addEventListener('click',()=> startGame());
      $('#altBtn')?.addEventListener('click',()=> showTopics());
      $('#learnBtn')?.addEventListener('click',()=>{
        showScreen('mistakesScreen');
        renderMistakes();
      });
      $('#backToResultsBtn')?.addEventListener('click',()=> showScreen('resultsScreen'));
      $('#fromMistakesStartBtn')?.addEventListener('click',()=> showTopics());

      initAudioToggle();
    }

    function showNameInput(){
      const prof=getActiveProfile();
      showScreen('nameScreen');
      const subtitle=$('#nameSubtitle');
      if(prof){ $('#playerName').value=prof.name; subtitle.textContent=`× ×¢×™× ×œ×¨××•×ª×š ×©×•×‘, ${prof.name}`; subtitle.classList.remove('hidden'); }
      else{ $('#playerName').value=''; subtitle.classList.add('hidden'); }
      focusTop('#nameTitle'); updateStatus('');
    }
    function showUserPicker(){
      const list=$('#userList'); list.innerHTML='';
      const arr=profilesArr();
      if(arr.length<=1){ $('#userPickerModal').classList.add('hidden'); showProfile(); return; }
      arr.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='w-full text-right p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 flex items-center justify-between';
        btn.innerHTML=`<span class="font-extrabold text-gray-800">${escapeHtml(p.name)}</span><span class="text-sm text-gray-500 ltr">${new Date(p.lastSeen||Date.now()).toLocaleDateString('he-IL')}</span>`;
        btn.onclick=()=>{ setActiveProfile(p.id); $('#playerName').value=p.name; $('#userPickerModal').classList.add('hidden'); if(!$('#profileScreen').classList.contains('hidden')) renderProfile(); };
        list.appendChild(btn);
      });
      $('#userPickerModal').classList.remove('hidden');
      trapDialog('#userPickerModal');
    }
    function showTopics(){
      let name='';
      const prof=getActiveProfile();
      if (prof && prof.name) name=prof.name.trim();
      else {
        const inp=$('#playerName'); const typed=(inp?.value||'').trim();
        if(!typed){ alert('×× × ×”×›× ×™×¡×• ××ª ×©××›×'); inp?.focus(); return; }
        name=typed;
      }
      playerName=name;
      ensureProfileByName(name);

      showScreen('topicsScreen');
      selectedTopics = new Set(); selectedProgram=null; selectedCount=null; selectedDifficulty=null;
      renderTopics();
      $('#topicsNext').disabled=true; $('#topicsNext').setAttribute('aria-disabled','true');
      setTopicsExpanded(false);
      focusTop('#topicsTitle'); updateStatus('');
    }
    function showProgram(){
      showScreen('programScreen');
      selectedProgram = null;
      renderPrograms();
      updateProgramNext();
      focusTop('#programScreen h2');
    }
    function showSettings(){
      showScreen('settingsScreen');
      selectedCount = null; selectedDifficulty = null;

      // × ×§×” ×‘×—×™×¨×•×ª ×§×™×™××•×ª
      $$('#countChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });
      $$('#difficultyChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); });

      updateSettingsNext();
      focusTop('#settingsScreen h2');
    }
    function updateSettingsNext(){
      const ready = !!selectedCount && !!selectedDifficulty;
      const btn = $('#settingsNext');
      btn.disabled = !ready;
      btn.setAttribute('aria-disabled', ready?'false':'true');
    }

    /* ========= Init ========= */
    function init(){
      storeInit();
      bindUI();
      showScreen('welcomeScreen');
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
