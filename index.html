<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>מדעונצ'יק - חידון מדעים עם שופי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
    :root{
      --ink:#111827; --ink-soft:#4b5563; --bg-a:#dbeafe; --bg-b:#f5d0fe; --bg-c:#d1fae5;
      --card:#ffffff; --ring:#2563eb; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --muted:#e5e7eb;
      --radius:20px;
    }
    html,body{height:100%}
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,var(--bg-a),var(--bg-b),var(--bg-c));min-height:100vh;color:var(--ink)}
    /* shared */
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .no-focus-outline:focus{outline:none!important;box-shadow:none!important}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}
    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.96);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}
    .chip{min-width:68px;min-height:52px;display:inline-flex;align-items:center;justify-content:center;border:2px solid #e5e7eb;background:#fff;border-radius:1rem;padding:.32rem .9rem;font-weight:700;font-size:1.1rem;cursor:pointer;transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.18)}
    .choice-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;background:rgba(255,255,255,.96);border:2px solid transparent;border-radius:1.25rem;padding:1.15rem;box-shadow:0 10px 26px rgba(0,0,0,.12);transition:.18s;cursor:pointer;outline:none;user-select:none}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    /* floating controls like screenshot */
    #floatingControls{position:fixed;left:16px;top:16px;z-index:50;display:flex;flex-direction:column;gap:10px}
    .circle-btn{width:40px;height:40px;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(0,0,0,.12);display:grid;place-items:center}
    .circle-btn[aria-pressed="true"] .muted{display:inline}
    .circle-btn[aria-pressed="true"] .unmuted{display:none}
    .circle-btn[aria-pressed="false"] .muted{display:none}
    .circle-btn[aria-pressed="false"] .unmuted{display:inline}
    /* card shell */
    .shell{background:#fff;border-radius:var(--radius);box-shadow:0 18px 50px rgba(0,0,0,.12)}
    .site-signature{text-align:center;color:#6b7280;font-size:.9rem;line-height:1.6;margin-top:1.25rem;margin-bottom:1.25rem}
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}
    @media (prefers-reduced-motion: reduce){ .owl-blink{animation:none} }
  </style>
</head>
<body>

  <!-- Floating controls -->
  <div id="floatingControls" aria-label="בקרות מהירות">
    <button id="audioToggle" type="button" class="circle-btn" aria-label="מצב צליל" aria-pressed="false" title="הצליל פעיל">
      <span class="unmuted" aria-hidden="true">🔊</span>
      <span class="muted" aria-hidden="true">🔇</span>
    </button>
    <button id="profileBtn" type="button" class="circle-btn" aria-label="אזור אישי" title="אזור אישי">👤</button>
  </div>

  <!-- Welcome -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center shell p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">🦉</div>
      <h1 id="welcomeTitle" tabindex="-1" class="no-focus-outline text-4xl font-bold text-purple-600 mb-4">מדעונצ'יק</h1>
      <p class="text-2xl text-gray-700 mb-8">בואו ללמוד מדעים עם שופי הינשוף</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">התחל משחק</button>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center shell p-8 max-w-md w-full">
      <div class="text-5xl mb-4">👋</div>
      <h2 id="nameTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-2">איך קוראים לך?</h2>
      <p id="nameSubtitle" class="text-gray-600 mb-4 hidden"></p>
      <input type="text" id="playerName" name="playerName" required placeholder="הכניסו שם פרטי" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none font-normal">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="underline font-bold text-gray-800">החלפת משתמש או אזור אישי</button>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">המשך</button>
    </form>
  </div>

  <!-- User Picker -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-3">בחרו משתמש</h3>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">סגור</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">משתמש חדש</button>
      </div>
    </div>
  </div>

  <!-- Topic -->
  <div id="topicScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center shell p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">🔬</div>
      <h2 id="topicTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">איזה נושא נלמד היום?</h2>
      <p class="text-gray-700 font-normal mb-6">בחרו נושא, מספר שאלות ורמת קושי. אחר כך משחקים.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="topicGrid">
        <!-- topics inserted by JS -->
      </div>

      <div class="mb-6">
        <div class="font-extrabold text-gray-800 mb-2">כמה שאלות בסט?</div>
        <div id="countChips" class="flex flex-wrap gap-2 justify-center">
          <button type="button" class="chip" data-count="6">6</button>
          <button type="button" class="chip" data-count="8">8</button>
          <button type="button" class="chip" data-count="10">10</button>
        </div>
      </div>

      <div class="mb-2">
        <div class="font-extrabold text-gray-800 mb-2">רמת קושי</div>
        <div id="diffChips" class="flex flex-wrap gap-2 justify-center">
          <button type="button" class="chip" data-diff="easy">קל</button>
          <button type="button" class="chip" data-diff="medium">בינוני</button>
          <button type="button" class="chip" data-diff="hard">מתקדם</button>
        </div>
      </div>

      <div class="mt-6">
        <button id="topicNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg" disabled aria-disabled="true">המשך</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="shell p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4">
        <div class="text-2xl font-bold text-purple-600">שאלה <span id="currentQuestion" class="ltr tabular-nums">1</span> מתוך <span id="totalQuestions" class="ltr tabular-nums">6</span></div>
        <div class="text-xl text-gray-700 font-normal">שלום <span id="gamePlayerName" class="font-bold"></span>! 👋</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
      </div>
      <div id="statusMsg" class="sr-only" aria-live="polite"></div>
    </div>

    <div class="shell p-6 mb-6 mx-auto max-w-3xl text-center">
      <div class="text-5xl mb-4 owl-blink">🦉</div>
      <div id="questionText" tabindex="-1" class="no-focus-outline text-3xl font-bold text-gray-900 mb-6">טוען...</div>
      <div class="text-gray-700 font-normal mb-4">בחרו את התשובה הנכונה</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-2 gap-4 max-w-3xl mx-auto px-4 mb-4">
      <!-- 4 answer cards inserted by JS -->
    </div>

    <div class="max-w-3xl mx-auto text-center space-y-4 pb-6">
      <div id="hintBox" class="hidden bg-blue-50 border-2 border-blue-200 text-blue-700 rounded-2xl px-4 py-3 max-w-2xl mx-auto text-right"></div>
      <div class="flex items-center gap-3 justify-center flex-wrap">
        <button id="hintBtn" class="px-5 py-3 rounded-full bg-blue-600 text-white font-bold disabled:opacity-50" type="button" disabled>הצג רמז</button>
        <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold disabled:opacity-50" disabled aria-disabled="true">אשר תשובה</button>
        <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold">התחלה מחדש</button>
      </div>
    </div>

    <!-- Final feedback only -->
    <div id="finalModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="finalText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div class="text-8xl mb-4">🏁</div>
        <div id="finalText" class="text-2xl font-bold mb-6">סיימנו את הסט</div>
        <button id="goToSummary" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">לסיכום התוצאות</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center shell p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">🏆</div>
      <h2 id="resultsTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-green-600 mb-4">כל הכבוד!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">הביצועים שלך:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Performance indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">✓ נכונות: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">✗ שגויות: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6 font-normal">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">סיימת את הסט. יפה מאוד.</div>
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">זמן ממוצע לשאלה: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> שניות</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אני רוצה סט חדש</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">ללמוד מהטעויות</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">בא לי נושא אחר</button>
        <button id="profileFromResultsBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">אזור אישי</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Mistakes -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="shell p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">📚</div>
        <h2 id="mistakesTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-orange-600 mb-4">לומדים מהטעויות</h2>
        <p class="text-lg text-gray-600 font-normal">לחצו על כל שאלה כדי לראות הסבר קצר.</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold">חזרה לתוצאות</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold">התחלה מחדש</button>
      </div>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorialScreen" class="hidden min-h-screen p-6">
    <div class="shell p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎓</div>
        <h2 id="tutorialTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-4">בואו נבין יחד</h2>
        <p class="text-lg text-gray-600 font-normal">הסבר קצר ופשוט.</p>
      </div>
      <div id="tutorialSteps" class="space-y-6"></div>
      <div class="text-center mt-6">
        <button id="backToMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold">חזרה לרשימת הטעויות</button>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="shell p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <h2 class="text-3xl font-bold text-indigo-600">האזור האישי</h2>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">התחל משחק</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">החלפת משתמש</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">משתמש חדש</button>
        </div>
      </div>

      <div id="profileHeader" class="mb-6 text-lg text-gray-700 font-normal"></div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">סטים שבוצעו</div>
          <div id="kpiSets" class="text-3xl font-extrabold text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">דיוק מצטבר</div>
          <div id="kpiAccuracy" class="text-3xl font-extrabold text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">זמן ממוצע לשאלה</div>
          <div id="kpiAvg" class="text-3xl font-extrabold text-gray-900 ltr">0s</div>
        </div>
      </div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">סטטיסטיקות לפי נושא</h3>
        <div id="byTopicGrid" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8"></div>
      </div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">היסטוריית סטים</h3>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State ========= */
    let currentTopic=null, currentDifficulty='easy', currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let questionCount=null;
    let lastFocusEl=null;

    /* ========= Store (profiles) ========= */
    const STORE_KEY='mdn_profiles_v1';
    let store=null; let memOnly=false;
    function uuid(){return'xxxxxxxyxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}
    function storeInit(){
      try{ store=JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }catch{ store=null; memOnly=true; }
      if(!store){ store={version:1,installedAt:Date.now(),activeId:null,profiles:{}}; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    }
    function saveStore(){ if(memOnly)return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
    function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null; }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){
      const norm=(name||'').trim(); if(!norm) return null;
      const existing=profilesArr().find(p=>p.name.trim()===norm);
      if(existing){ setActiveProfile(existing.id); return existing; }
      const id=uuid();
      store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
        totals:{sets:0,questions:0,correct:0,timeSec:0}, byTopic:{}, history:[], seenIds:[] };
      setActiveProfile(id);
      return {id, ...store.profiles[id]};
    }

    function logSessionToProfile(topicLabel){
      const prof=getActiveProfile(); if(!prof) return;
      const entry={ id:uuid(), ts:Date.now(), topic:currentTopic, topicLabel:topicLabel,
        diff:currentDifficulty, count:totalQuestions, correct:correctCount,
        avgSec:Math.max(1,Math.round(totalTime/Math.max(1,totalQuestions))),
        mistakesCount:mistakes.length };
      prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop();

      prof.totals.sets+=1; prof.totals.questions+=totalQuestions; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);

      const tkey=currentTopic||'כללי';
      if(!prof.byTopic[tkey]) prof.byTopic[tkey]={label:topicLabel,sets:0,questions:0,correct:0,timeSec:0};
      const bt=prof.byTopic[tkey];
      bt.sets+=1; bt.questions+=totalQuestions; bt.correct+=correctCount; bt.timeSec+=Math.round(totalTime);

      saveStore();
    }

    /* ========= Topics ========= */
    const TOPICS=[
      {key:'motion', label:'תנועה וכוחות', emoji:'🚗'},
      {key:'waves', label:'קול ואור', emoji:'🔊'},
      {key:'electric', label:'חשמל ומגנטים', emoji:'⚡'},
      {key:'heat', label:'חום וחומרים', emoji:'🔥'},
      {key:'earth', label:'כדור הארץ וחלל', emoji:'🌍'},
      {key:'everyday', label:'מדע ביום יום', emoji:'🧪'}
    ];

    /* ========= Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    function shuffle(a){const c=a.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]];}return c}
    function focusTop(selector){
      const el=typeof selector==='string'?document.querySelector(selector):selector;
      const target=el||document.body;
      if(target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      requestAnimationFrame(()=>{
        window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        try{ target && target.focus({preventScroll:true}); }catch{}
      });
    }
    function updateStatus(msg){ const el=$('#statusMsg'); if(el) el.textContent=msg||''; }

    /* ========= Audio ========= */
    let isMuted=false, audioCtx=null, audioUnlocked=false;
    function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
    function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; try{ const buffer=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); const g=ctx.createGain(); g.gain.value=0.0001; src.buffer=buffer; src.connect(g); g.connect(ctx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); g.disconnect(); }catch{} audioUnlocked=true; },0); }catch{} }
    function tone(freq,dur,t,type='sine',gain=0.22){ if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
    function playTick(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520,.08,t,'triangle',.18); }
    function playSuccess(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,.10,t,'sine',.18); tone(659.25,.10,t+.09,'sine',.16); tone(783.99,.12,t+.18,'sine',.14); }
    function playError(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,.10,t,'square',.18); tone(180,.10,t+.09,'square',.16); }
    function initAudioToggle(){
      const btn=$('#audioToggle'); if(!btn) return;
      try{ isMuted=localStorage.getItem('mdn_sound_muted')==='true'; }catch{ isMuted=false; }
      btn.setAttribute('aria-pressed', isMuted?'true':'false');
      btn.addEventListener('click',()=>{ isMuted=!isMuted; btn.setAttribute('aria-pressed', isMuted?'true':'false'); try{ localStorage.setItem('mdn_sound_muted', String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); playTick(); });
    }
    window.addEventListener('pointerdown', unlockAudioOnce, { once:true, capture:true });
    window.addEventListener('click', unlockAudioOnce, { once:true, capture:true });

    /* ========= Topic grid render ========= */
    function renderTopics(){
      const g=$('#topicGrid'); g.innerHTML='';
      TOPICS.forEach(t=>{
        const b=document.createElement('button');
        b.type='button'; b.className='choice-card'; b.setAttribute('data-topic',t.key);
        b.innerHTML=`<div class="text-3xl">${t.emoji}</div><div class="text-lg font-bold text-gray-800">${t.label}</div>`;
        b.addEventListener('click',()=>{ $$('#topicGrid .choice-card').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); currentTopic=t.key; updateTopicNextState(); playTick(); });
        g.appendChild(b);
      });
    }
    function updateTopicNextState(){
      const btn=$('#topicNext'); const enabled=!!currentTopic && !!questionCount && !!currentDifficulty;
      btn.disabled=!enabled; btn.setAttribute('aria-disabled', enabled?'false':'true');
    }
    function chipSelect(containerSel, attr, onVal){
      const cont=$(containerSel); if(!cont) return;
      cont.addEventListener('click', e=>{
        const btn=e.target.closest('.chip'); if(!btn||!cont.contains(btn)) return;
        $$(containerSel+' .chip').forEach(c=>c.classList.remove('selected'));
        btn.classList.add('selected');
        const v=btn.getAttribute(attr); onVal && onVal(v);
        playTick(); updateTopicNextState();
      });
    }

    /* ========= Question generator ========= */
    // תבניות רבות לפי נושא; כל תבנית מחזירה שאלה אחת או יותר עם מזהה ייחודי
    const TEMPLATES={
      motion:[
        ()=>mk('מה מאט גלגול של כדור על הדשא?', ['חיכוך','כוח המשיכה','רוח קבועה','אור'], 0, 'החיכוך מתנגד לתנועה.'),
        ()=>mk('כשזורקים כדור למעלה, מה יקרה?', ['יעלה ואז ירד','יישאר למעלה','יעצור באוויר','ייעלם'], 0, 'כוח המשיכה מחזיר אותו.'),
        ()=>mk('איזה כוח מושך אותנו לקרקע?', ['כוח המשיכה','דחיפה','חשמל סטטי','קפיץ'], 0, 'כוח המשיכה של כדור הארץ.'),
        ()=>mk('במסלול אופניים עקום, לאן פונה הכוח המרכזי?', ['למרכז המסלול','החוצה','למעלה','למטה'], 0, 'כוח צנטריפטלי פונה למרכז.'),
      ],
      waves:[
        ()=>mk('מה נע מהר יותר?', ['אור','קול','רוח','מים'], 0, 'האור מהיר מאוד, הקול איטי ממנו.'),
        ()=>mk('כשתגדיל עוצמת קול, מה יקרה?', ['הקול יישמע חזק יותר','הצליל יהיה גבוה יותר','מהירות הקול תשתנה','שום דבר'], 0, 'עוצמה גבוהה נשמעת חזקה.'),
        ()=>mk('למה רואים ברק לפני ששומעים רעם?', ['האור מהיר מהקול','הקול מהיר מהאור','זה קורה יחד','תלוי בעננים'], 0, 'האור מגיע קודם.'),
        ()=>mk('איך נקרא החזר של קול מקיר?', ['הד','סינוס','שבירה','משרעת'], 0, 'קול החוזר יוצר הד.'),
      ],
      electric:[
        ()=>mk('מה יקרה במעגל סגור עם סוללה ונורה?', ['הנורה תדלק','שום דבר','הסוללה תיעלם','יהיה צליל'], 0, 'זרם נע במעגל סגור.'),
        ()=>mk('מה מושכים מגנטים?', ['ברזל','עץ','זכוכית','נייר'], 0, 'מגנט מושך חומרים מסוימים כמו ברזל.'),
        ()=>mk('איזה חומר מוליך חשמל טוב?', ['נחושת','פלסטיק','עץ','זכוכית'], 0, 'מתכות מוליכות חשמל.'),
        ()=>mk('מה גורם לחשמל סטטי בשיער?', ['חיכוך','מים','חום','רעש'], 0, 'שפשוף יוצר מטענים.'),
      ],
      heat:[
        ()=>mk('מה מודד מדחום?', ['טמפרטורה','מסה','לחץ','אורך'], 0, 'כמה חם או קר.'),
        ()=>mk('הפשרת קרח היא מעבר מ...', ['מוצק לנוזל','נוזל לגז','גז לנוזל','נוזל למוצק'], 0, 'קרח נמס לנוזל.'),
        ()=>mk('מה קורה לאוויר חם?', ['עולה למעלה','יורד למטה','נשאר במקום','נעלם'], 0, 'אוויר חם קל וצף למעלה.'),
        ()=>mk('כשמשפשפים ידיים, מה מתחמם?', ['הידיים בגלל חיכוך','האוויר','המים','האור'], 0, 'חיכוך יוצר חום.'),
      ],
      earth:[
        ()=>mk('למה יש לנו עונות?', ['כי כדור הארץ נוטה על צירו','כי השמש מתקרבת','כי הירח מסתיר','כי הימים קצרים'], 0, 'הנטייה גורמת לשינוי בזווית השמש.'),
        ()=>mk('מה מושך את הים וגורם לגאות?', ['הירח','כוכבים','רוח','גשם'], 0, 'כבידת הירח.'),
        ()=>mk('מהו כוכב הלכת שעליו אנו חיים?', ['כדור הארץ','מאדים','נוגה','שבתאי'], 0, 'אנחנו על כדור הארץ.'),
        ()=>mk('למה השמש “שוקעת”?', ['כדור הארץ מסתובב','השמש זזה סביבנו','עננים דוחפים','הירח מושך'], 0, 'הסיבוב יוצר יום ולילה.'),
      ],
      everyday:[
        ()=>mk('מדוע ספינה יכולה לצוף?', ['צפיפותה נמוכה ממים','יש לה מנוע','כי היא כבדה','כי יש רוחות'], 0, 'צפיפות נמוכה גורמת לציפה.'),
        ()=>mk('כשפותחים מצנח, למה מאטים?', ['גרר אוויר','מגנט','מנוע','ציפה'], 0, 'שטח גדול מגדיל התנגדות.'),
        ()=>mk('מה יקרה לנר בלי חמצן?', ['יכבה','יתעצם','יקפא','יזרח'], 0, 'בעירה צריכה חמצן.'),
        ()=>mk('מדוע משקפיים מתכסות באדים?', ['עיבוי אדי מים','אבק','מגנטיות','חשמל'], 0, 'אדים מתעבים על משטח קריר.'),
      ],
    };

    function mk(q, choices, correctIndex, hint, steps){
      return { q, choices, correct:correctIndex, hint:hint||'', steps:steps||[], topic:currentTopic, level:currentDifficulty };
    }

    // הגדלת מגוון: מייצרים וריאציות מספריות פשוטות כדי להגיע למאות פריטים ייחודיים
    function numericVariants(){
      const arr=[];
      // נפילה חופשית זמן-גובה (קונספטואלית, בלי חישוב)
      for(let h of [2,5,10,20]){
        arr.push(mk(`כדור נופל מגובה ${h} מטר. מה ימשוך אותו למטה?`, ['כוח המשיכה','רוח','מגנט','אור'], 0, 'כוח המשיכה תמיד מושך לקרקע.'));
      }
      // ציפה: גופים שונים
      ['עץ','ברזל','פלסטיק','קרח'].forEach(mat=>{
        const ans = mat==='ברזל' ? 'ישטוף וירד' : 'יצוף';
        arr.push(mk(`גוש ${mat} במים, מה יקרה?`, [mat==='ברזל'?'ישקע':'יצוף','יישאר באמצע','יעוף','יתמוסס'], 0, 'צפיפות קובעת ציפה.'));
      });
      // חשמל: חיבור-ניתוק
      ['מפסק כבוי','חוט קרוע','סוללה ריקה'].forEach(bug=>{
        arr.push(mk(`במעגל עם ${bug}, מה יקרה לנורה?`, ['לא תדלק','תדלק חזק יותר','תשנה צבע','תזמזם'], 0, 'מעגל לא סגור לא עובד.'));
      });
      return arr;
    }

    function buildBigBank(){
      let bank=[];
      Object.keys(TEMPLATES).forEach(k=>{
        // בסיס
        TEMPLATES[k].forEach(f=>{ currentTopic=k; bank.push(f()); });
      });
      // וריאציות כלליות
      currentTopic='motion'; bank=bank.concat(numericVariants());
      // הכפל מגוון עם ניסוחים
      const phrasings=[
        ['מה יגרום ל...','מה גורם ל...','מה הסיבה ל...'],
        ['בחרו תשובה נכונה','מה נכון?','מה הכי נכון?']
      ];
      bank = bank.map((it,i)=>{
        if(i%3===0){ it.q = it.q.replace('מה', phrasings[0][randInt(0,2)]); }
        return it;
      });
      // כפולים? ננקה בעזרת מפה לפי שאלה+תשובה נכונה
      const map={}; const uniq=[];
      bank.forEach(b=>{ const id=b.q+'|'+b.choices[b.correct]; if(!map[id]){ map[id]=1; uniq.push(b); }});
      // 220 מינימום: אם חסר, נשכפל וריאציות עם סדר תשובות שונה
      while(uniq.length<220){
        const src=uniq[randInt(0,uniq.length-1)];
        const mix=shuffle(src.choices.slice());
        uniq.push({ q:src.q, choices:mix, correct:mix.indexOf(src.choices[src.correct]), hint:src.hint, steps:src.steps, topic:src.topic, level:src.level });
      }
      return uniq;
    }

    const BIG_BANK = buildBigBank();

    /* ========= Build session with anti-repeats ========= */
    function pickSession(topicKey, diff, count){
      // סינון נושא
      let pool = BIG_BANK.filter(q=> topicKey ? (q.topic===topicKey) : true);
      // מעט דיפרנציאציה לפי קושי: דילול טקסטים ארוכים לקל, השאר למדורג
      if(diff==='easy'){ pool = pool.filter(q=> q.q.length<=55); }
      if(diff==='hard'){ pool = pool.concat(shuffle(BIG_BANK).slice(0,30)); } // מוסיף שונות
      // אנטי חזרתיות בין סטים למשתמש
      const prof=getActiveProfile();
      const seen=new Set(prof?.seenIds||[]);
      const fresh=pool.filter((q,idx)=> !seen.has(makeQid(q,idx)));
      const src = fresh.length>=count ? fresh : pool;
      // בוחרים בלי כפילויות בסט
      const chosen=[]; const used=new Set();
      const tryFrom = shuffle(src);
      for(const q of tryFrom){
        const id=makeQid(q);
        if(used.has(id)) continue;
        chosen.push(cloneQ(q));
        used.add(id);
        if(chosen.length===count) break;
      }
      // לעדכון seenIds
      if(prof){
        const arr=prof.seenIds||[]; chosen.forEach((q,i)=>arr.unshift(makeQid(q,i)));
        while(arr.length>400) arr.pop();
        prof.seenIds=arr; saveStore();
      }
      return chosen;
    }
    function makeQid(q, salt){ return (q.q+'|'+(q.choices[q.correct]||'')+'|'+(q.topic||'')+'|'+(salt||'')); }
    function cloneQ(q){
      const mix=q.choices.map((txt,i)=>({txt,i})); const sh=shuffle(mix);
      return { q:q.q, choices: sh.map(c=>c.txt), correct: sh.findIndex(c=>c.i===q.correct),
        hint: q.hint||'', steps: Array.isArray(q.steps)? q.steps.slice() : [],
        topic: q.topic||currentTopic, level: q.level||currentDifficulty };
    }

    /* ========= Screens ========= */
    const SCREENS=['welcomeScreen','nameScreen','topicScreen','gameScreen','resultsScreen','mistakesScreen','tutorialScreen','profileScreen'];
    function showScreen(id){ SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden')); $('#'+id)?.classList.remove('hidden'); window.scrollTo({top:0,left:0,behavior:'auto'}); }

    /* ========= Flow ========= */
    function showNameInput(){
      const prof=getActiveProfile();
      showScreen('nameScreen');
      const subtitle=$('#nameSubtitle');
      if(prof){ $('#playerName').value=prof.name; subtitle.textContent=`נעים לראותך שוב, ${prof.name}!`; subtitle.classList.remove('hidden'); }
      else{ $('#playerName').value=''; subtitle.classList.add('hidden'); }
      focusTop('#nameTitle'); updateStatus('');
    }

    function showUserPicker(){
      const list=$('#userList'); list.innerHTML='';
      const arr=profilesArr();
      if(arr.length<=1){ $('#userPickerModal').classList.add('hidden'); showProfile(); return; }
      arr.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='w-full text-right p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 flex items-center justify-between';
        btn.innerHTML=`<span class="font-bold text-gray-800">${p.name}</span><span class="text-sm text-gray-500 ltr">${new Date(p.lastSeen||Date.now()).toLocaleDateString('he-IL')}</span>`;
        btn.onclick=()=>{ setActiveProfile(p.id); $('#playerName').value=p.name; $('#userPickerModal').classList.add('hidden'); if(!$('#profileScreen').classList.contains('hidden')) renderProfile(); lastFocusEl && lastFocusEl.focus(); };
        list.appendChild(btn);
      });
      lastFocusEl = document.activeElement;
      $('#userPickerModal').classList.remove('hidden');
    }
    $('#userPickerCancel')?.addEventListener('click',()=>{ $('#userPickerModal').classList.add('hidden'); lastFocusEl && lastFocusEl.focus(); });
    $('#newUserBtn')?.addEventListener('click',()=>{ $('#userPickerModal').classList.add('hidden'); $('#playerName').value=''; $('#playerName').focus(); });

    function showTopicSelect(){
      let name=''; const prof=getActiveProfile();
      if(prof && prof.name) name=prof.name.trim();
      else {
        const inp=$('#playerName'); const typed=(inp?.value||'').trim();
        if(!typed){ alert('אנא הכניסו שם'); inp?.focus(); return; }
        name=typed;
      }
      playerName=name; ensureProfileByName(name);
      showScreen('topicScreen'); renderTopics();
      currentTopic=null; questionCount=null; currentDifficulty='easy';
      $$('#countChips .chip').forEach(c=>c.classList.remove('selected'));
      $$('#diffChips .chip').forEach(c=>c.classList.remove('selected'));
      focusTop('#topicTitle'); updateStatus('');
    }

    function startGame(){
      try{
        selectedAnswer=null; mistakes=[]; correctCount=0; totalTime=0; currentQuestionIndex=0;
        const topicLabel = TOPICS.find(t=>t.key===currentTopic)?.label || 'כללי';
        questions = pickSession(currentTopic, currentDifficulty, questionCount||6);
        if(!questions.length){ alert('לא הצלחנו לבנות סט, נסו נושא אחר.'); return; }
        totalQuestions=questions.length; $('#totalQuestions').textContent=totalQuestions; $('#resultsTotal').textContent=totalQuestions;
        showScreen('gameScreen');
        $('#gamePlayerName').textContent=playerName;
        const pb=$('#progressBar'); pb.style.width='0%'; pb.setAttribute('aria-valuenow','0');
        showQuestion();
        focusTop('#questionText');
        updateStatus(`נושא: ${topicLabel}. בהצלחה!`);
      }catch(err){ console.error(err); alert('אירעה תקלה בהפעלת המשחק. נסו שוב.'); }
    }

    /* ========= Game ========= */
    function renderAnswers(opts){
      const grid=$('#answersGrid'); grid.innerHTML='';
      opts.forEach((txt,i)=>{
        const d=document.createElement('div');
        d.className='answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4';
        d.setAttribute('data-value',String(i));
        d.setAttribute('tabindex','0'); d.setAttribute('role','button'); d.setAttribute('aria-selected','false');
        d.innerHTML=`<div class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight ltr tabular-nums">${txt}</div>`;
        d.addEventListener('click',()=>chooseItem(d,i));
        d.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); chooseItem(d,i); }});
        grid.appendChild(d);
      });
    }

    function chooseItem(item, idx){
      $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
      item.classList.add('selected'); item.setAttribute('aria-selected','true');
      selectedAnswer=idx; $('#confirmButton').disabled=false; $('#confirmButton').setAttribute('aria-disabled','false'); playTick();
    }

    function updateProgress(){
      const answered=currentQuestionIndex; // מספר שאלות שכבר אושרו
      const pct=Math.round((answered/totalQuestions)*100);
      const pb=$('#progressBar'); pb.style.width=pct+'%'; pb.setAttribute('aria-valuenow',String(pct));
      $('#currentQuestion').textContent=currentQuestionIndex+1;
    }

    function showQuestion(){
      updateProgress();
      const q=questions[currentQuestionIndex];
      $('#questionText').textContent=q.q;
      renderAnswers(q.choices);
      $('#hintBox').classList.add('hidden'); $('#hintBox').textContent='';
      $('#hintBtn').disabled = !((q.steps&&q.steps.length) || q.hint);
      $('#hintBtn').textContent = (q.steps && q.steps.length) ? 'הצג צעד' : 'הצג רמז';
      hintIndex=-1; $('#confirmButton').disabled=true; $('#confirmButton').setAttribute('aria-disabled','true');
      startTime=Date.now();
    }

    let hintIndex=-1;
    $('#hintBtn').addEventListener('click',()=>{
      const q=questions[currentQuestionIndex]; if(!q) return;
      if(q.steps && q.steps.length){
        hintIndex++; const i=Math.min(hintIndex, q.steps.length-1);
        $('#hintBox').textContent=q.steps[i]; $('#hintBox').classList.remove('hidden');
        $('#hintBtn').textContent = i < q.steps.length-1 ? 'הצעד הבא' : 'סיום צעדים';
        if(i>=q.steps.length-1) $('#hintBtn').disabled=true;
      }else if(q.hint){
        $('#hintBox').textContent=q.hint; $('#hintBox').classList.remove('hidden'); $('#hintBtn').disabled=true;
      }
      playTick();
    });

    function confirmAnswer(){
      if(selectedAnswer===null) return;
      const q=questions[currentQuestionIndex];
      const end=Date.now();
      totalTime=Math.max(0,totalTime+(end-startTime)/1000);

      const isCorrect = selectedAnswer===q.correct;
      if(isCorrect){ correctCount++; playSuccess(); }
      else{
        mistakes.push({ question:q, userAnswer:q.choices[selectedAnswer], correctAnswer:q.choices[q.correct], reviewed:false });
        playError();
        if(q.hint){ $('#hintBox').textContent=q.hint; $('#hintBox').classList.remove('hidden'); }
      }

      currentQuestionIndex++;
      updateProgress();

      if(currentQuestionIndex>=totalQuestions){
        // מלא 100%
        const pb=$('#progressBar'); pb.style.width='100%'; pb.setAttribute('aria-valuenow','100');
        // מודאל סיום בלבד
        lastFocusEl = document.activeElement;
        $('#finalModal').classList.remove('hidden');
        $('#goToSummary').focus();
      }else{
        showQuestion();
        $('#confirmButton').disabled=true; $('#confirmButton').setAttribute('aria-disabled','true');
      }
    }

    function closeFinalAndShowResults(){
      $('#finalModal').classList.add('hidden');
      showResults();
      lastFocusEl && lastFocusEl.focus();
    }

    /* ========= Results ========= */
    function getResultsTitleCopy(name,pct){
      if(pct===0) return `לא נורא ${name}, בפעם הבאה נצליח יחד עם שופי`;
      else if(pct<=59) return `${name} רואים התקדמות, ממשיכים לתרגל עם שופי`;
      else if(pct<=79) return `${name} עבודה טובה, עוד קצת וזה מושלם`;
      else if(pct<=89) return `ואוו ${name}, שליטה יפה`;
      return `כל הכבוד ${name}!`;
    }

    function showResults(){
      showScreen('resultsScreen');
      const incorrect=totalQuestions-correctCount;
      const pct=Math.round((correctCount/totalQuestions)*100);
      const prof=getActiveProfile(); const displayName=prof?prof.name:playerName;
      $('#resultsTitle').textContent=getResultsTitleCopy(displayName,pct);

      const msg=$('#performanceMessage'), icon=$('#resultsScreen .text-8xl');
      if(correctCount===totalQuestions){ msg.textContent='מושלם! ענית נכון על כל השאלות. 🌟'; msg.className='mb-4 font-medium text-lg text-green-600'; icon.textContent='🏆'; }
      else if(pct<50){ msg.textContent='נעבור על ההסברים ואחר כך ננסה שוב.'; msg.className='mb-4 font-medium text-lg text-orange-600'; icon.textContent='💪'; }
      else{ msg.textContent=`ענית נכון על ${correctCount} מתוך ${totalQuestions}. כל הכבוד!`; msg.className='mb-4 font-medium text-lg text-blue-600'; icon.textContent='🏆'; }

      updatePerformanceBar(correctCount,incorrect,pct);
      $('#correctAnswers').textContent=String(correctCount);
      $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions)));
      $('#mistakesButton').classList.toggle('hidden', mistakes.length===0);

      const topicLabel = TOPICS.find(t=>t.key===currentTopic)?.label || 'כללי';
      logSessionToProfile(topicLabel);
      focusTop('#resultsTitle');
    }

    function updatePerformanceBar(correct,incorrect,pct){
      $('#correctBar').style.width=(correct/totalQuestions*100)+'%';
      $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%';
      $('#performancePercentage').textContent=pct+'%';
      $('#correctCount').textContent=String(correct);
      $('#incorrectCount').textContent=String(incorrect);
    }

    /* ========= Mistakes & Tutorial ========= */
    function showMistakes(){
      showScreen('mistakesScreen');
      const list=$('#mistakesList'); list.innerHTML='';
      if(mistakes.length===0){
        list.innerHTML='<div class="text-center p-8"><div class="text-6xl mb-4">🎉</div><h3 class="text-2xl font-bold text-green-600">מעולה!</h3><p class="text-lg text-gray-600 font-normal">לא היו טעויות במשחק הזה.</p></div>'; return;
      }
      mistakes.forEach((m,i)=>{
        const d=document.createElement('div');
        d.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 cursor-pointer hover:bg-orange-100 transition-colors';
        d.onclick=()=>showTutorial(m);
        d.innerHTML=`
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
              <h3 class="text-xl font-bold text-orange-600">שאלה ${(i+1)}</h3>
            </div>
            <div class="text-2xl">🤔</div>
          </div>
          <div class="text-2xl font-bold text-gray-800 mb-4">${m.question.q}</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div class="bg-red-100 border-2 border-red-300 rounded-xl p-4">
              <div class="text-sm text-red-600 font-bold mb-1">התשובה שלך:</div>
              <div class="text-xl font-bold text-red-700">${m.userAnswer}</div>
            </div>
            <div class="bg-green-100 border-2 border-green-300 rounded-xl p-4">
              <div class="text-sm text-green-600 font-bold mb-1">התשובה הנכונה:</div>
              <div class="text-xl font-bold text-green-700">${m.correctAnswer}</div>
            </div>
          </div>
          <div class="text-sm text-gray-600 mb-2">${m.question.hint?('טיפ: '+m.question.hint):''}</div>
          <div class="text-center text-blue-600 font-bold">לחצו כדי ללמוד</div>`;
        list.appendChild(d);
      });
      focusTop('#mistakesTitle'); updateStatus('בחרו שאלה כדי לראות הסבר פשוט.');
    }

    function showTutorial(m){
      showScreen('tutorialScreen');
      $('#tutorialTitle').textContent=m.question.q;
      const c=$('#tutorialSteps'); c.innerHTML='';
      const steps=(m.question.steps&&m.question.steps.length? m.question.steps : defaultStepsFor(m.question)) || [];
      steps.forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='bg-blue-50 border-2 border-blue-200 rounded-2xl p-6';
        d.innerHTML=`<div class="flex items-center mb-3"><div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4">${i+1}</div><h3 class="text-xl font-bold text-blue-600">${stepTitle(i)}</h3></div><p class="text-gray-700 text-lg font-normal">${s}</p>`;
        c.appendChild(d);
      });
    }
    function stepTitle(i){ return ['הבנת השאלה','רמז שימושי','סיכום קצר'][Math.min(i,2)]; }
    function defaultStepsFor(q){
      if(q.hint) return [q.hint,'עברו על התשובות והוציאו את הפחות מתאימות.','בחרו לאט ושימו לב למילים מבלבלות.'];
      return ['קראו את השאלה לאט.','חפשו מילה שמכוונת לתשובה.','בדקו אם נשארה אפשרות הגיונית אחת.'];
    }

    /* ========= Profile ========= */
    function showProfile(){ showScreen('profileScreen'); renderProfile(); updateStatus(''); }
    function setSwitchBtnDisabled(disabled){ const btn=$('#profileSwitchBtn'); if(!btn) return; btn.disabled=disabled; btn.classList.toggle('opacity-50', disabled); }
    function renderProfile(){
      const prof=getActiveProfile(); const header=$('#profileHeader'); const totalUsers=profilesArr().length;
      setSwitchBtnDisabled(totalUsers<=1);
      if(!prof){
        header.textContent='אין משתמש פעיל. צרו משתמש חדש או עברו למשתמש קיים.';
        $('#kpiSets').textContent='0'; $('#kpiAccuracy').textContent='0%'; $('#kpiAvg').textContent='0s';
        $('#byTopicGrid').innerHTML=''; $('#historyList').innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">אין היסטוריית סטים עדיין.</div>';
        return;
      }
      header.innerHTML=`משתמש פעיל: <span class="font-bold text-gray-900">${prof.name}</span>`;
      const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0};
      const acc=tot.questions>0?Math.round((tot.correct/tot.questions)*100):0;
      const avg=tot.questions>0?Math.round(tot.timeSec/tot.questions):0;
      $('#kpiSets').textContent=String(tot.sets||0);
      $('#kpiAccuracy').textContent=acc+'%';
      $('#kpiAvg').textContent=(avg||0)+'s';

      const grid=$('#byTopicGrid'); grid.innerHTML='';
      Object.entries(prof.byTopic||{}).forEach(([key,stat])=>{
        const a=stat.questions?Math.round((stat.correct/stat.questions)*100):0;
        const card=document.createElement('div');
        card.className='p-4 rounded-2xl border-2 border-gray-200 bg-gray-50';
        card.innerHTML=`<div class="font-bold mb-2">${stat.label||key}</div>
          <div class="text-sm text-gray-600 mb-1">סטים: <span class="ltr">${stat.sets}</span></div>
          <div class="text-sm text-gray-600 mb-1">דיוק: <span class="ltr">${a}%</span></div>
          <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div style="width:${a}%" class="h-2 bg-blue-500"></div></div>`;
        grid.appendChild(card);
      });

      const h=prof.history||[]; const list=$('#historyList'); list.innerHTML='';
      if(h.length===0){
        list.innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">אין היסטוריית סטים עדיין.</div>';
      }else{
        h.slice(0,12).forEach(item=>{
          const pct=Math.round((item.correct/item.count)*100);
          const row=document.createElement('div');
          row.className='p-3 border-2 border-gray-200 rounded-xl bg-white flex items-center justify-between gap-3';
          const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'});
          row.innerHTML=`<div>
              <div class="text-sm text-gray-500">${date}</div>
              <div class="text-gray-800">${item.topicLabel||'כללי'}</div>
              <div class="text-sm text-gray-500">רמה: ${item.diff} · שאלות: ${item.count}</div>
            </div>
            <div class="text-right">
              <div class="text-xl font-extrabold ${pct===100?'text-green-600': pct>=60?'text-blue-600':'text-orange-600'} ltr">${pct}%</div>
              <div class="text-sm text-gray-500">טעויות: ${item.mistakesCount}</div>
            </div>`;
          list.appendChild(row);
        });
      }
    }

    /* ========= Bindings ========= */
    function bindUI(){
      $('#startBtn')?.addEventListener('click',()=>{ unlockAudioOnce(); showNameInput(); });
      $('#nameForm')?.addEventListener('submit', e=>{ e.preventDefault(); unlockAudioOnce(); showTopicSelect(); });
      $('#profileOrSwitchBtn')?.addEventListener('click',()=>{ const arr=profilesArr(); if(arr.length>1) showUserPicker(); else showProfile(); });
      $('#profileBtn')?.addEventListener('click',()=> showProfile());

      chipSelect('#countChips','data-count',v=>{ questionCount=parseInt(v,10); });
      chipSelect('#diffChips','data-diff',v=>{ currentDifficulty=v; });
      $('#topicNext')?.addEventListener('click',()=> startGame());

      $('#confirmButton')?.addEventListener('click',confirmAnswer);
      $('#restartBtn')?.addEventListener('click',()=> showNameInput());

      $('#retryBtn')?.addEventListener('click',()=> startGame());
      $('#mistakesButton')?.addEventListener('click',()=> showMistakes());
      $('#altBtn')?.addEventListener('click',()=> showTopicSelect());
      $('#profileFromResultsBtn')?.addEventListener('click',()=> showProfile());

      $('#backToResults')?.addEventListener('click',()=> showResults());
      $('#restartFromMistakes')?.addEventListener('click',()=> showNameInput());
      $('#backToMistakes')?.addEventListener('click',()=> showMistakes());

      $('#goToSummary')?.addEventListener('click', closeFinalAndShowResults);

      $('#profileStartBtn')?.addEventListener('click',()=>{
        const prof=getActiveProfile();
        if(!prof){ showNameInput(); return; }
        playerName=prof.name; showTopicSelect();
      });
      $('#profileSwitchBtn')?.addEventListener('click',()=>{ if(profilesArr().length>1) showUserPicker(); });
      $('#profileNewBtn')?.addEventListener('click',()=>{ store.activeId=null; saveStore(); showNameInput(); });

      // עטיפת קליקים לנעילת אודיו + טיקט קולי
      document.addEventListener('click',e=>{
        const el=e.target.closest('button,.choice-card,.chip,.answer-item'); if(!el||el.id==='audioToggle') return;
        if(el.disabled||el.getAttribute('aria-disabled')==='true') return;
        playTick();
      });
      document.addEventListener('keydown',e=>{
        // אין קיצורי מקלדת לבחירה; רק Space/Enter על פוקוס כפתור
        if((e.key==='Enter'||e.key===' ') && document.activeElement?.closest('button,.answer-item,.chip,.choice-card')) playTick();
      });
    }

    function init(){
      storeInit();
      initAudioToggle();
      bindUI();
      showScreen('welcomeScreen');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
