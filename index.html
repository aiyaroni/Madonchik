<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××“×¢×•× ×¦'×™×§ - ××©×—×§ ××“×¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap');
    :root{
      --ink:#1f2937; --ink-soft:#6b7280; --bg:linear-gradient(135deg,#dbeafe,#fce7f3 40%,#dcfce7);
      --card:rgba(255,255,255,.96); --muted:#e5e7eb;
      --accent:#6366f1; --accent2:#22c55e; --warn:#f59e0b; --error:#ef4444;
      --r:1.25rem; --shadow:0 12px 30px rgba(0,0,0,.12);
    }
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg);}    
    .ltr{direction:ltr;unicode-bidi:embed;display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}

    .choice-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;background:var(--card);border:2px solid transparent;border-radius:1.25rem;padding:1.15rem;box-shadow:var(--shadow);transition:.18s;cursor:pointer;outline:none;user-select:none}
    .choice-card .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1.25rem 1.25rem 0;opacity:.55;pointer-events:none}
    .choice-card[data-tint="green"]{--tint:#22c55e}
    .choice-card[data-tint="blue"]{--tint:#3b82f6}
    .choice-card[data-tint="purple"]{--tint:#a855f7}
    .choice-card[data-tint="orange"]{--tint:#f59e0b}
    .choice-card[data-tint="pink"]{--tint:#ec4899}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card:active{transform:scale(.98)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .choice-card.selected .accent{display:block; background:var(--tint,#3b82f6)}
    .choice-card .emoji{font-size:2rem}

    .chip{min-width:68px;min-height:52px;display:inline-flex;align-items:center;justify-content:center;border:2px solid #e5e7eb;background:white;border-radius:1rem;padding:.3rem .8rem;font-weight:800;font-size:1.1rem;cursor:pointer;transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.20)}

    .answer-item{position:relative;transition:transform .14s,box-shadow .14s,border-color .14s;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;background:rgba(255,255,255,.96);border-radius:1rem;border:2px solid transparent;outline:none}
    .answer-item::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:var(--tint,transparent);opacity:.08}
    .answer-item .accent{display:none;position:absolute;right:0;top:0;bottom:0;width:8px;border-radius:0 1rem 1rem 0;opacity:.55;background:var(--tint);pointer-events:none}
    .answer-item[data-idx="0"]{--tint:#f87171}
    .answer-item[data-idx="1"]{--tint:#60a5fa}
    .answer-item[data-idx="2"]{--tint:#4ade80}
    .answer-item[data-idx="3"]{--tint:#facc15}
    .answer-item:active{transform:scale(.98)}
    .answer-item.selected{border-color:#2563eb;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .answer-item.selected .accent{display:block}

    .confirm-button{transition:all .25s}
    .confirm-button[disabled]{opacity:.5;cursor:not-allowed}

    /* Overflow fade */
    #topicsWrapper{position:relative}
    .topics-collapsed{max-height:min(45vh, 360px); overflow:hidden;}
    #topicsFade{position:absolute;inset-inline:0;bottom:0;height:64px;background:linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));pointer-events:none}

    .site-signature{ text-align:center;color:#6b7280;font-size:.875rem;line-height:1.6; margin-top:1.25rem;margin-bottom:1.25rem }
    @media (min-width:640px){ .site-signature{font-size:1rem;margin-top:2rem;margin-bottom:2rem} }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}

    .no-focus-outline:focus{outline:none !important; box-shadow:none !important}
    .owl-blink{animation:blink 2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}
    @media (prefers-reduced-motion: reduce){ .owl-blink{ animation:none } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 via-purple-50 to-green-100">

  <!-- Floating controls -->
  <div id="floatingControls" class="fixed left-4 top-4 z-50 flex flex-col gap-2">
    <button id="audioToggle" type="button" aria-label="×”×—×œ×¤×ª ××¦×‘ ×¦×œ×™×œ" aria-pressed="false" title="×”×¦×œ×™×œ ×¤×¢×™×œ" class="px-3 py-2 rounded-full bg-white/90 border border-gray-200 shadow-lg">
      <span class="unmuted" aria-hidden="true">ğŸ”Š</span>
      <span class="muted hidden" aria-hidden="true">ğŸ”‡</span>
    </button>
    <button id="profileBtn" type="button" aria-label="××–×•×¨ ××™×©×™" title="××–×•×¨ ××™×©×™" class="px-3 py-2 rounded-full bg-white/90 border border-gray-200 shadow-lg">ğŸ‘¤</button>
  </div>

  <!-- Welcome -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-4 owl-blink">ğŸ¦‰</div>
      <h1 id="welcomeTitle" tabindex="-1" class="no-focus-outline text-4xl font-extrabold text-purple-600 mb-3">××“×¢×•× ×¦'×™×§</h1>
      <p class="text-2xl text-gray-700 mb-6">×œ×•××“×™× ××“×¢ ×¢× ×©×•×¤×™ ×”×™× ×©×•×£</p>
      <p class="text-gray-600 mb-6">×›×œ ×¤×¢× ×¡×˜ ×—×“×© ×•×©×•× ×”. ×‘×œ×™ ××§×œ×“×ª, ×¨×§ ××’×¢ ××• ×¢×›×‘×¨.</p>
      <button type="button" id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×™××œ×œ×” ××ª×—×™×œ×™×</button>
    </div>
    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Name -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-4">ğŸ‘‹</div>
      <h2 id="nameTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-blue-600 mb-2">××™×š ×§×•×¨××™× ×œ×š?</h2>
      <p id="nameSubtitle" class="text-gray-600 mb-4 hidden"></p>
      <input type="text" id="playerName" name="playerName" required placeholder="×”×›× ×¡ ××ª ×©××š ×›××Ÿ" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="underline font-extrabold">×”×—×œ×£ ××©×ª××© ××• ×œ××–×•×¨ ××™×©×™</button>
      </div>
      <button type="submit" class="bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">×”××©×š</button>
    </form>
  </div>

  <!-- User Picker Modal -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-3">×‘×—×¨×• ××©×ª××©</h3>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">×¡×’×•×¨</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">××©×ª××© ×—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Topics -->
  <div id="topicsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">ğŸ“š</div>
      <h2 id="topicsTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-green-600 mb-2 leading-tight">×‘×—×¨×• ×ª×—×•××™ ××“×¢</h2>
      <p class="text-lg text-gray-700 mb-6">××¤×©×¨ ×œ×‘×—×•×¨ ××—×“ ××• ×›××”. ×× ×œ× ×‘×•×—×¨×™× ×›×œ×•× × ×§×‘×œ ×¡×˜ ××’×•×•×Ÿ.</p>

      <div id="topicsWrapper" class="relative mb-6">
        <div id="topicsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 topics-collapsed"></div>
        <div id="topicsFade" class="hidden"></div>
      </div>
      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="topicsMore" type="button" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold hidden" aria-expanded="false">×”×¦×’ ×¢×•×“</button>
        <button id="topicsNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×”××©×š</button>
      </div>
    </div>
  </div>

  <!-- Difficulty + Count -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-4">âš¡</div>
      <h2 id="diffTitle" tabindex="-1" class="no-focus-outline text-3xl md:text-4xl font-extrabold text-blue-600 mb-2 leading-tight">×‘×—×¨×• ×¨××ª ×§×•×©×™ ×•×›××” ×©××œ×•×ª</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <button type="button" data-diff="easy" class="choice-card diff-btn" data-tint="green" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">ğŸŒ±</div>
          <div class="text-xl font-bold">×§×œ</div>
        </button>
        <button type="button" data-diff="medium" class="choice-card diff-btn" data-tint="orange" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">ğŸ”¥</div>
          <div class="text-xl font-bold">×‘×™× ×•× ×™</div>
        </button>
        <button type="button" data-diff="hard" class="choice-card diff-btn" data-tint="purple" aria-pressed="false">
          <span class="accent" aria-hidden="true"></span>
          <div class="emoji">âš¡</div>
          <div class="text-xl font-bold">××ª×§×“×</div>
        </button>
      </div>

      <div class="mb-2">
        <div class="text-lg font-extrabold text-gray-800 mb-3">××¡×¤×¨ ×©××œ×•×ª ×‘×¡×˜</div>
        <div id="countChips" class="flex flex-wrap gap-2 justify-center">
          <button type="button" class="chip" data-count="6" aria-pressed="false">6</button>
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
        </div>
      </div>

      <div class="mt-6">
        <button id="diffNext" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50" disabled aria-disabled="true">×™×¦×™××” ×œ×“×¨×š</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
        <div class="text-2xl font-bold text-purple-600">×©××œ×” <span id="currentQuestion" class="ltr">1</span> ××ª×•×š <span id="totalQuestions" class="ltr">6</span></div>
        <div class="text-xl text-gray-600">×©×œ×•× <span id="gamePlayerName"></span>! ğŸ‘‹</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width:0%"></div>
      </div>
      <div id="statusMsg" class="sr-only" aria-live="polite"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-2xl text-center">
      <div class="text-5xl mb-4 owl-blink">ğŸ¦‰</div>
      <div id="questionText" tabindex="-1" class="no-focus-outline text-2xl sm:text-3xl font-bold text-gray-800 mb-4">×©××œ×” × ×˜×¢× ×ª...</div>
      <div id="hintBox" class="hidden bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 text-right text-gray-700 mb-3"></div>
      <div class="flex gap-2 justify-center mb-2">
        <button id="hintBtn" type="button" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold disabled:opacity-50" disabled>×¨××–</button>
      </div>
      <div class="text-base text-gray-600">×‘×—×¨×• ×ª×©×•×‘×” ××—×ª × ×›×•× ×”</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto px-4 mb-6">
      <!-- answers injected here -->
    </div>

    <div class="text-center space-y-4 pb-6">
      <button id="confirmButton" class="confirm-button bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold transition-all duration-200 shadow-lg" disabled aria-disabled="true">××©×¨ ×ª×©×•×‘×”</button>
      <button type="button" id="restartBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div role="dialog" aria-modal="true" aria-labelledby="feedbackText" class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
        <div id="feedbackIcon" class="text-8xl mb-4">ğŸ‰</div>
        <div id="feedbackText" aria-live="polite" class="text-2xl font-bold mb-6">×›×œ ×”×›×‘×•×“!</div>
        <button id="nextButton" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×¡×™×›×•× ×”×ª×•×¦××•×ª</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative overflow-hidden">
      <div class="text-8xl mb-4">ğŸ†</div>
      <h2 id="resultsTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-green-600 mb-4">×›×œ ×”×›×‘×•×“!</h2>
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">×”×‘×™×¦×•×¢×™× ×©×œ×š:</span>
          <span id="performancePercentage" class="text-sm font-bold text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="performanceBar" class="h-6 rounded-full transition-all duration-1000 flex" aria-label="Progress indicator">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-600 font-medium">âœ“ × ×›×•× ×•×ª: <span id="correctCount" class="ltr">0</span></span>
          <span class="text-orange-600 font-medium">âœ— ×©×’×•×™×•×ª: <span id="incorrectCount" class="ltr">0</span></span>
        </div>
      </div>
      <div class="text-xl text-gray-700 mb-6">
        <div id="performanceMessage" class="mb-4 font-medium text-lg">×¡×™×™××ª ××ª ×”×¡×˜</div>
        <div class="mb-2">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span id="correctAnswers" class="font-bold text-green-600 ltr">0</span>/<span id="resultsTotal" class="ltr">6</span></div>
        <div class="mb-4">×–××Ÿ ×××•×¦×¢: <span id="averageTime" class="font-bold text-blue-600 ltr">0</span> ×©× ×™×•×ª</div>
      </div>
      <div class="flex flex-col gap-4">
        <button id="retryBtn" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×× ×™ ×¨×•×¦×” ×¡×˜ ×—×“×©</button>
        <button id="mistakesButton" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×œ×œ××•×“ ××”×˜×¢×•×™×•×ª</button>
        <button id="altBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×‘×—×™×¨×” ××—×¨×ª</button>
        <button id="profileFromResultsBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">××–×•×¨ ××™×©×™</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>Â© 2025 yaroni studio - ×ª×•×›×Ÿ ×—×–×§, ×¢×•×‘×“ ×—×›× ×•××‘×•×¡×¡ ×¢×œ ×‘×™× ×”</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- Mistakes -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ“š</div>
        <h2 id="mistakesTitle" tabindex="-1" class="no-focus-outline text-3xl font-bold text-orange-600 mb-4">×œ××“ ××”×˜×¢×•×™×•×ª</h2>
        <div class="mb-6 max-w-md mx-auto">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-3">
            <div id="mistakesPerformanceBar" class="h-4 rounded-full transition-all duration-1000 flex" aria-label="Performance summary">
              <div id="mistakesCorrectBar" class="bg-gradient-to-r from-green-400 to-green-500 transition-all duration-1000" style="width: 0%"></div>
              <div id="mistakesIncorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
          <div id="mistakesMessage" class="text-lg text-gray-700 mb-4">×”×˜×¢×•×™×•×ª ×©×œ×š ××•×¦×’×•×ª ×›××Ÿ</div>
        </div>
        <p class="text-lg text-gray-600">×œ×—×¦×• ×¢×œ ×›×œ ×©××œ×” ×›×“×™ ×œ×§×‘×œ ×¨××–×™× ××“×•×¨×’×™×.</p>
      </div>
      <div id="mistakesList" class="space-y-6 mb-8"></div>
      <div class="text-center space-y-4">
        <button id="backToResults" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-full text-xl font-bold hover:scale-105 transition-all duration-200 shadow-lg">×—×–×•×¨ ×œ×ª×•×¦××•×ª</button>
        <button type="button" id="restartFromMistakes" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold hover:scale-105 transition-all duration-200 shadow-lg">×”×ª×—×œ ××—×“×©</button>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
        <h2 class="text-3xl font-bold text-indigo-600">×”××–×•×¨ ×”××™×©×™</h2>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">×”×ª×—×œ ××©×—×§</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">×”×—×œ×£ ××©×ª××©</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold">××©×ª××© ×—×“×©</button>
        </div>
      </div>

      <div id="profileHeader" class="mb-6 text-lg text-gray-700"></div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">×¡×˜×™× ×©×‘×•×¦×¢×•</div>
          <div id="kpiSets" class="text-3xl font-extrabold text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">×“×™×•×§ ××¦×˜×‘×¨</div>
          <div id="kpiAccuracy" class="text-3xl font-extrabold text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">×–××Ÿ ×××•×¦×¢ ×œ×©××œ×”</div>
          <div id="kpiAvg" class="text-3xl font-extrabold text-gray-900 ltr">0s</div>
        </div>
      </div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">×¡×˜×˜×™×¡×˜×™×§×” ×œ×¤×™ ×ª×—×•×</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="byTopicGrid"></div>
      </div>

      <div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™×</h3>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State & Storage ========= */
    let currentDifficulty='easy', questionCount=6, currentQuestionIndex=0;
    let correctCount=0, totalQuestions=6, questions=[], mistakes=[];
    let startTime=0, totalTime=0, playerName='', selectedAnswer=null;
    let selectedTopics = new Set();

    // Profiles
    const STORE_KEY='mad_profiles_v1';
    let store=null; let memOnly=false; let lastFocusEl=null;

    function uuid(){return 'xxxxxxxyxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
    function storeInit(){
      try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }catch{ store=null; memOnly=true; }
      if(!store){ store={version:1,installedAt:Date.now(),activeId:null,profiles:{},recentIds:[]}; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; }}
    }
    function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
    function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})) }
    function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null }
    function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
    function ensureProfileByName(name){ const norm=(name||'').trim(); if(!norm) return null; const existing=profilesArr().find(p=>p.name.trim()===norm); if(existing){ setActiveProfile(existing.id); return existing; } const id=uuid(); store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(), totals:{sets:0,questions:0,correct:0,timeSec:0}, byTopic:{}, history:[] }; setActiveProfile(id); return {id, ...store.profiles[id]}; }

    function logSessionToProfile(topicsUsed){ const prof=getActiveProfile(); if(!prof) return; const entry={ id:uuid(), ts:Date.now(), topics:[...topicsUsed], diff:currentDifficulty, count:totalQuestions, correct:correctCount, avgSec:Math.max(1,Math.round(totalTime/Math.max(1,totalQuestions))), mistakesCount:mistakes.length }; prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop(); prof.totals.sets+=1; prof.totals.questions+=totalQuestions; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);
      topicsUsed.forEach(t=>{ if(!prof.byTopic[t]) prof.byTopic[t]={sets:0,questions:0,correct:0,timeSec:0}; prof.byTopic[t].sets+=1; prof.byTopic[t].questions+=totalQuestions; prof.byTopic[t].correct+=correctCount; prof.byTopic[t].timeSec+=Math.round(totalTime); }); saveStore(); }

    /* ========= Audio ========= */
    let isMuted=false, audioCtx=null, audioUnlocked=false;
    function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
    function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; try{ const buffer=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); const g=ctx.createGain(); g.gain.value=0.0001; src.buffer=buffer; src.connect(g); g.connect(ctx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); g.disconnect(); }catch{} audioUnlocked=true; },0); }catch{} }
    function tone(freq,dur,t,type='sine',gain=0.22){ if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
    function playSelectTick(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520,0.10,t,'triangle',0.20); }
    function playSuccessSound(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.20); tone(659.25,0.12,t+0.1,'sine',0.18); tone(783.99,0.14,t+0.2,'sine',0.16); }
    function playErrorSound(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,0.12,t,'square',0.20); tone(180,0.12,t+0.1,'square',0.18); }
    function initAudioToggle(){ const btn=document.getElementById('audioToggle'); if(!btn) return; try{ isMuted=localStorage.getItem('mad_sound_muted')==='true'; }catch{ isMuted=false; } btn.setAttribute('aria-pressed', isMuted?'true':'false'); btn.querySelector('.unmuted').classList.toggle('hidden', isMuted); btn.querySelector('.muted').classList.toggle('hidden', !isMuted); btn.addEventListener('click',()=>{ isMuted=!isMuted; btn.setAttribute('aria-pressed', isMuted?'true':'false'); btn.querySelector('.unmuted').classList.toggle('hidden', isMuted); btn.querySelector('.muted').classList.toggle('hidden', !isMuted); try{ localStorage.setItem('mad_sound_muted', String(isMuted)); }catch{} if(!isMuted) unlockAudioOnce(); playSelectTick(); }); }
    window.addEventListener('pointerdown', unlockAudioOnce, { once:true, capture:true });

    /* ========= Topics & Questions ========= */
    const TOPICS=[
      {id:'mechanics', label:'×ª× ×•×¢×” ×•×›×•×—×•×ª', emoji:'ğŸƒ'},
      {id:'gravity', label:'×’×¨×‘×™×˜×¦×™×”', emoji:'ğŸª‚'},
      {id:'friction', label:'×—×™×›×•×š', emoji:'ğŸ§½'},
      {id:'energy', label:'×× ×¨×’×™×”', emoji:'âš™ï¸'},
      {id:'sound', label:'×§×•×œ ×•×’×œ×™×', emoji:'ğŸ”Š'},
      {id:'light', label:'××•×¨ ×•×¨××™×™×”', emoji:'ğŸ”¦'},
      {id:'electricity', label:'×—×©××œ ×•××¢×’×œ×™×', emoji:'ğŸ’¡'},
      {id:'magnet', label:'××’× ×˜×™×•×ª', emoji:'ğŸ§²'},
      {id:'matter', label:'×—×•××¨ ×•××¦×‘×™×', emoji:'ğŸ§Š'},
      {id:'weather', label:'××–×’ ××•×•×™×¨', emoji:'â›…'},
      {id:'space', label:'×›×“×•×¨ ×”××¨×¥ ×•×—×œ×œ', emoji:'ğŸŒ'},
      {id:'life', label:'××“×¢×™ ×”×—×™×™× ×‘×¡×™×¡', emoji:'ğŸŒ±'},
      {id:'tools', label:'×›×œ×™× ×•× ×™×¡×•×™', emoji:'ğŸ§ª'}
    ];

    // Base facts (about 70). Each will spawn 3 variants -> >200 items.
    const BASE_FACTS=[
      {topic:'gravity', level:'easy', q:'××” ××•×©×š ×—×¤×¦×™× ×œ×§×¨×§×¢?', correct:'×’×¨×‘×™×˜×¦×™×”', wrong:['×—×™×›×•×š','××’× ×˜×™×•×ª','×¨×•×—'], hint:'×–×” ×”×›×•×— ×©××•×©×š ×”×›×•×œ ×œ××˜×”.', steps:['×—×•×©×‘×™× ×¢×œ ×§×¤×™×¦×” ×‘××•×•×™×¨.','××” ×’×•×¨× ×œ× ×• ×œ×—×–×•×¨ ×œ×§×¨×§×¢?']},
      {topic:'energy', level:'easy', q:'××™×–×• ×× ×¨×’×™×” ×™×© ×œ×ª× ×•×¢×”?', correct:'×× ×¨×’×™×” ×§×™× ×˜×™×ª', wrong:['×× ×¨×’×™×” ×—×©××œ×™×ª','×× ×¨×’×™×” ×ª×¨××™×ª','×× ×¨×’×™×” ××œ×¡×˜×™×ª'], hint:'×§×™× ×˜×™×ª ×¤×™×¨×•×©×• ×ª× ×•×¢×”.', steps:['××–×”×™× ××” ×§×•×¨×” ×›×©××©×”×• ×–×–.','×œ×ª× ×•×¢×” ×™×© ×©× ××™×•×—×“.']},
      {topic:'light', level:'easy', q:'×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×©×©×•××¢×™× ×¨×¢×?', correct:'×”××•×¨ ××”×™×¨ ××”×§×•×œ', wrong:['×”×§×•×œ ××”×™×¨ ××”××•×¨','×–×” ×§×•×¨×” ×™×—×“','×ª×œ×•×™ ×‘×¢× × ×™×'], hint:'×”××•×¨ ××’×™×¢ ×§×•×“×.', steps:['××©×•×•×™× ××”×™×¨×•×ª ××•×¨ ×•×§×•×œ.','××™ ××’×™×¢ ×œ×¢×™×Ÿ ×œ×¤× ×™ ×”××•×–×Ÿ?']},
      {topic:'matter', level:'easy', q:'××” ××•×“×“ ××“×—×•×?', correct:'×˜××¤×¨×˜×•×¨×”', wrong:['××¡×”','×œ×—×¥','××”×™×¨×•×ª'], hint:'×›××” ×—× ××• ×§×¨.', steps:['×—×•×©×‘×™× ×¢×œ ×—×•× ×•×§×•×¨.','×‘××™×–×” ×›×œ×™ ××©×ª××©×™×?']},
      {topic:'friction', level:'easy', q:'××™×–×” ×›×•×— ×××˜ ×ª× ×•×¢×” ×¢×œ ××©×˜×—?', correct:'×—×™×›×•×š', wrong:['×’×¨×‘×™×˜×¦×™×”','×¦×™×¤×”','×—×©××œ'], hint:'×”×•× ××ª× ×’×“ ×œ×ª× ×•×¢×”.', steps:['××—×œ×™×§×™× ×™×“ ×¢×œ ×©×•×œ×—×Ÿ.','××” ××¨×’×™×©×™×?']},
      {topic:'mechanics', level:'easy', q:'××” ×§×•×¨×” ×œ×›×“×•×¨ ×©× ×–×¨×§ ×œ××¢×œ×”?', correct:'×¢×•×œ×” ×•××– ×™×•×¨×“', wrong:['× ×©××¨ ×œ××¢×œ×”','× ×¢×œ×','×¢×•×¦×¨ ×‘××•×•×™×¨'], hint:'×”×›×•×— ×©××—×–×™×¨ ××•×ª×• ×¤×•×¢×œ ×ª××™×“.', steps:['×–×•×¨×§×™× ×•××¡×ª×›×œ×™×.','×œ××” ×”×•× ×—×•×–×¨?']},
      {topic:'magnet', level:'easy', q:'××” ××•×©×š ××¡××¨×™ ×‘×¨×–×œ?', correct:'××’× ×˜', wrong:['× ×—×•×©×ª','×¢×¥','×–×›×•×›×™×ª'], hint:'×—×•××¨ ××™×•×—×“ ××•×©×š ×‘×¨×–×œ.', steps:['×—×•×©×‘×™× ×¢×œ ××’× ×˜×™× ×‘××§×¨×¨.','××” ×”× ××•×©×›×™×?']},
      {topic:'electricity', level:'easy', q:'×‘××¢×’×œ ×¡×’×•×¨ ×¢× ×¡×•×œ×œ×” ×•× ×•×¨×”, ××” ×™×§×¨×”?', correct:'×”× ×•×¨×” ×ª×“×œ×§', wrong:['×©×•× ×“×‘×¨','×”×¡×•×œ×œ×” × ×¢×œ××ª','×™×”×™×” ×¦×œ×™×œ'], hint:'×–×¨× ×–×– ×¨×§ ×‘××¢×’×œ ×¡×’×•×¨.', steps:['×¦×¨×™×š ×—×™×‘×•×¨ ××œ×.','×•××– ×”×–×¨× ×–×•×¨×.']},
      {topic:'light', level:'medium', q:'××™×–×” ×¦×‘×¢ × ×©×‘×¨ ×”×›×™ ×”×¨×‘×” ×‘××™×?', correct:'×¡×’×•×œ', wrong:['××“×•×','×™×¨×•×§','×›×—×•×œ'], hint:'×§×¦×” ×¡×’×œ×’×œ ×©×œ ×”×§×©×ª.', steps:['×–×•×›×¨×™× ××ª ×¡×“×¨ ×”×¦×‘×¢×™× ×‘×§×©×ª.','××™ ×”×›×™ ××ª×¢×§×?']},
      {topic:'weather', level:'easy', q:'××” ××§×•×¨ ×”×× ×¨×’×™×” ×œ×¨×•×—?', correct:'×”×©××© ××—×××ª ×œ× ××—×™×“', wrong:['×”×™×¨×—','××’× ×˜×™×','×¨×¢×©'], hint:'×”×‘×“×œ×™ ×˜××¤×¨×˜×•×¨×” ×•×œ×—×¥.', steps:['×©××© ××—×××ª ××–×•×¨×™× ××—×¨×ª.','×”××•×•×™×¨ × ×¢.']},
      {topic:'weather', level:'medium', q:'××” ×§×•×¨×” ×œ×œ×—×¥ ×”××•×•×™×¨ ×›×©×¢×•×œ×™× ×‘×”×¨?', correct:'×™×•×¨×“', wrong:['×¢×•×œ×”','×§×‘×•×¢','×ª×œ×•×™ ×‘×©×¢×”'], hint:'×¤×—×•×ª ××•×•×™×¨ ××¢×œ×™×š.', steps:['××“××™×™× ×™× ×¢×œ×™×™×” ×œ×’×•×‘×”.','×™×•×ª×¨ ××• ×¤×—×•×ª ××•×•×™×¨?']},
      {topic:'life', level:'easy', q:'××” ×¦×¨×™×š ×œ×‘×¢×™×¨×” ×©×œ × ×¨?', correct:'×—××¦×Ÿ', wrong:['×¤×—××Ÿ ×“×• ×—××¦× ×™','××™×','××•×•×™×¨ ×—× ×‘×œ×‘×“'], hint:'×‘×¢×™×¨×” ×“×•×¨×©×ª ×’×– ××¡×•×™×.', steps:['××” ×™×© ×‘××•×•×™×¨?','××™×–×” ×’×– ×—×©×•×‘ ×œ×©×¨×™×¤×”?']},
      {topic:'matter', level:'easy', q:'××™×–×” ××¦×‘ ×¦×‘×™×¨×” ×™×© ×œ×¢× ×Ÿ?', correct:'×’×– ×¢× ×˜×™×¤×•×ª ×–×¢×™×¨×•×ª', wrong:['× ×•×–×œ ×‘×œ×‘×“','×§×¨×— ×‘×œ×‘×“','×¤×œ×–××”'], hint:'×–×” ××“×™ ××™× ×•×˜×™×¤×•×ª ×§×˜× ×•×ª.', steps:['××¡×ª×›×œ×™× ×œ×©××™×™×.','××“×™× ×•×˜×™×¤×•×ª.']},
      {topic:'sound', level:'easy', q:'×›×©××’×“×™×œ×™× ×××¤×œ×™×˜×•×“×” ×©×œ ×§×•×œ, ××” ×§×•×¨×”?', correct:'×”×§×•×œ ×—×–×§ ×™×•×ª×¨', wrong:['×”×¦×œ×™×œ ×’×‘×•×” ×™×•×ª×¨','×”××”×™×¨×•×ª ××©×ª× ×”','×”×›×•×œ ×™×—×“'], hint:'×××¤×œ×™×˜×•×“×” ×”×™× ×¢×•×¦××”.', steps:['×’×œ ×’×‘×•×” ×™×•×ª×¨.','× ×©××¢ ×—×–×§ ×™×•×ª×¨.']},
      {topic:'mechanics', level:'medium', q:'××” ×’×•×¨× ×œ×ª× ×•×¢×” ××¢×’×œ×™×ª ×‘×—×‘×œ ×¢× ××‘×Ÿ?', correct:'×›×•×— ×¦× ×˜×¨×™×¤×˜×œ×™ ×œ×›×™×•×•×Ÿ ×”××¨×›×–', wrong:['×›×•×— ×”×—×•×¦×”','××™×Ÿ ×›×•×—','×›×•×— ×—×™×›×•×š'], hint:'×”×›×•×— ×¤×•× ×” ×¤× ×™××”.', steps:['××¡×ª×•×‘×‘×™× ×‘××¢×’×œ.','××™×–×” ×›×•×— ×©×•××¨ ×‘××¡×œ×•×œ?']},
      {topic:'tools', level:'easy', q:'×œ××” ××©×ª××©×™× ×‘××©×¤×š ×‘××–×™×’×”?', correct:'×›×“×™ ×œ××¡×•×£ ×•×œ×”×›×•×•×™×Ÿ × ×•×–×œ', wrong:['×›×“×™ ×œ×—×× × ×•×–×œ','×›×“×™ ×œ×§×¨×¨ × ×•×–×œ','×›×“×™ ×œ×©× ×•×ª ×¦×‘×¢'], hint:'×¦×•×¨×” ×©××¦×¨×” ××ª ×”×–×¨×™××”.', steps:['××—×©×‘×™× ××¡×œ×•×œ ×–×¨×™××”.','×¤×—×•×ª ×œ×›×œ×•×š.']},
      {topic:'energy', level:'medium', q:'××™×–×• ×× ×¨×’×™×” × ××’×¨×ª ×‘×§×¤×™×¥ ×“×—×•×¡?', correct:'×¤×•×˜× ×¦×™××œ×™×ª ××œ×¡×˜×™×ª', wrong:['×§×™× ×˜×™×ª','×ª×¨××™×ª','×—×©××œ×™×ª'], hint:'××©×ª×—×¨×¨×ª ×›×©×¢×•×–×‘×™×.', steps:['×“×•×—×¡×™× ×§×¤×™×¥.','×™×© ×× ×¨×’×™×” ××’×•×¨×”.']},
      {topic:'mechanics', level:'easy', q:'××”×• ×× ×•×£?', correct:'××›×©×™×¨ ×©××§×œ ×¢×œ ×”×¨××”', wrong:['×¡×•×’ ×©×œ ××©×§×œ','×™×—×™×“×ª ×›×•×—','×—×‘×œ ××™×•×—×“'], hint:'×›×œ×™ ×¤×©×•×˜ ×œ×™×ª×¨×•×Ÿ ××›× ×™.', steps:['× ×“×‘×¨ ×¢×œ × ×§×•×“×ª ××©×¢×Ÿ.','×”×›×•×— ××ª×—×œ×§.']},
      {topic:'electricity', level:'medium', q:'××” ×™×§×¨×” ×× × ×—×‘×¨ × ×•×¨×” ×‘××§×‘×™×œ ×œ× ×•×¨×” ×§×™×™××ª?', correct:'×”×©×ª×™×™× ×™×§×‘×œ×• ××ª×— ××œ×', wrong:['×©×ª×™×”×Ÿ ×™×›×‘×•','×”×–×¨× ×™×™×¢×œ×','×¨×§ ××—×ª ×ª××™×¨'], hint:'×‘××§×‘×™×œ ×”××ª×— ×–×”×”.', steps:['×–×•×›×¨×™× ×—×™×‘×•×¨×™ ××¢×’×œ.','×‘××§×‘×™×œ ××ª×— ×–×”×”.']},
      {topic:'magnet', level:'medium', q:'××” ×™×§×¨×” ×œ×©× ×™ ×§×˜×‘×™× ×¦×¤×•×Ÿ-×¦×¤×•×Ÿ ×©×œ ××’× ×˜×™×?', correct:'×™×“×—×• ×–×” ××ª ×–×”', wrong:['×™×™××©×›×•','×œ× ×™×©×¤×™×¢×•','×™×”×¤×›×• ×§×•×˜×‘'], hint:'×“×•××™× ×“×•×—×™×.', steps:['×“×•××™× ×“×•×—×™×.','×©×•× ×™× ××•×©×›×™×.']},
      {topic:'light', level:'medium', q:'××” ×§×•×¨×” ×œ××•×¨ ×‘×œ×‘×Ÿ ×©×¢×•×‘×¨ ××™×•× ×œ×©×§×™×¢×”?', correct:'× ×¤×œ×˜ ×•× ×©×‘×¨ ××—×¨×ª ×‘××˜××•×¡×¤×™×¨×”', wrong:['×”×©××© ××ª×§×¨×‘×ª','×”×©××© ×’×“×œ×”','×”×™×¨×— ××¡×ª×™×¨'], hint:'×”××•×•×™×¨ ××¢×§× ×•××¤×–×¨ ××•×¨.', steps:['×”××¡×œ×•×œ ×‘××•×•×™×¨ ××ª××¨×š.','×¤×™×–×•×¨ ×©×•× ×” ×œ×¦×‘×¢×™×.']},
      {topic:'matter', level:'easy', q:'××” ×§×•×¨×” ×œ×§×¨×— ×›×©××—×××™× ××•×ª×•?', correct:'×”×•×¤×š ×œ× ×•×–×œ', wrong:['×”×•×¤×š ×œ×’×– ××™×“','× ×©××¨ ×§×¨×—','× ×”×™×” ××•×¦×§ ×™×•×ª×¨'], hint:'×©×™× ×•×™ ××¦×‘ ×¦×‘×™×¨×”.', steps:['××•×¡×™×¤×™× ×—×•×.','×”×•×¤×š ×œ××™×.']},
      {topic:'tools', level:'medium', q:'×œ××” ××•×“×“×™× ×¢× ×¡×¨×’×œ ×¢×œ ××©×˜×— ×™×©×¨?', correct:'×›×“×™ ×œ×§×‘×œ ××•×¨×š ××“×•×™×§', wrong:['×›×“×™ ×œ×”×•×¡×™×£ ××©×§×œ','×›×“×™ ×œ×©× ×•×ª ×¦×‘×¢','×›×“×™ ×œ××“×•×“ ×˜××¤×¨×˜×•×¨×”'], hint:'××“×™×“×” ×¦×¨×™×›×” ×™×™×©×•×¨.', steps:['××™×™×©×¨×™× ×§×¦×” ×œ×§×¦×”.','×§×•×¨××™× ××¡×¤×¨.']},
      {topic:'space', level:'easy', q:'××” ×’×•×¨× ×œ×™×•× ×•×œ×™×œ×”?', correct:'×¡×™×‘×•×‘ ×›×“×•×¨ ×”××¨×¥', wrong:['×¡×™×‘×•×‘ ×”×©××©','×”×™×¨×— ××›×¡×”','×”×¨×™× ×—×•×¡××™×'], hint:'×”×›×“×•×¨ ××¡×ª×•×‘×‘ ×¡×‘×™×‘ ×¢×¦××•.', steps:['×¤× ×™× ×”×—×•×¦×” ×œ×©××©.','×¦×“ ××•××¨ ×•×¦×“ ×—×©×•×š.']},
      {topic:'weather', level:'medium', q:'××” ××•×“×“ ×‘×¨×•××˜×¨?', correct:'×œ×—×¥ ××•×•×™×¨', wrong:['×˜××¤×¨×˜×•×¨×”','××¡×”','×’×•×‘×”'], hint:'×§×©×•×¨ ×œ××–×’ ××•×•×™×¨.', steps:['×œ×—×¥ ×‘××˜××•×¡×¤×™×¨×”.','×©×™× ×•×™×™ ××–×’ ××•×•×™×¨.']},
      {topic:'sound', level:'medium', q:'×‘××” ×ª×œ×•×™×” ×’×•×‘×” ×”×¦×œ×™×œ (×’×•×‘×” ×ª×“×¨)?', correct:'×‘×ª×“×™×¨×•×ª ×”×’×œ', wrong:['×‘×××¤×œ×™×˜×•×“×”','×‘××”×™×¨×•×ª ×”×§×•×œ','×‘×¦×‘×¢ ×”×§×•×œ'], hint:'×›××” ×¨×˜×˜ ×‘×©× ×™×™×”.', steps:['××”×™×¨×•×ª ×”×¨×˜×˜.','×ª×“×™×¨×•×ª ×’×‘×•×”×” ×¦×œ×™×œ ×’×‘×•×”.']},
      {topic:'mechanics', level:'hard', q:'×‘××” ×ª×œ×•×™ ×—×™×›×•×š ×”×—×œ×§×” ×‘×™×Ÿ ×©× ×™ ××©×˜×—×™×?', correct:'×‘×›×•×— ×”× ×•×¨××œ×™ ×•×‘××§×“× ×”×—×™×›×•×š', wrong:['×‘××”×™×¨×•×ª ×‘×œ×‘×“','×‘×©×˜×— ×”××’×¢ ×‘×œ×‘×“','×‘×—×•× ×‘×œ×‘×“'], hint:'××•×“×œ ×¤×©×•×˜: F=Î¼N.', steps:['××–×”×™× N.','××›×¤×™×œ×™× ×‘××§×“×.']},
      {topic:'electricity', level:'hard', q:'××” ×™×§×¨×” ×œ×–×¨× ×‘××¢×’×œ ×˜×•×¨×™ ×›×©××•×¡×™×¤×™× × ×’×“ × ×•×¡×£?', correct:'×”×–×¨× ×™×§×˜×Ÿ', wrong:['×”×–×¨× ×™×’×“×œ','×œ× ×™×©×ª× ×”','×”× ×•×¨×” ×ª×ª×¤×•×¦×¥'], hint:'×”×ª× ×’×“×•×ª ×©×§×•×œ×” ×’×“×œ×”.', steps:['×¡×›×•× × ×’×“×™×.','I=V/R.']},
      {topic:'light', level:'hard', q:'××” ×§×•×‘×¢ ××ª ×¦×‘×¢ ×”××•×¨?', correct:'×”×ª×“×™×¨×•×ª ××• ×”××•×¨×š ×’×œ', wrong:['×”×××¤×œ×™×˜×•×“×”','×”×¢×•×¦××”','×”×›×™×•×•×Ÿ'], hint:'×§×©×•×¨ ×œ×¨×˜×˜ ×©×œ ×”×©×“×”.', steps:['×¦×‘×¢ ×”×•× ×ª×“×™×¨×•×ª.','××•×¨×š ×’×œ ××©×œ×™×.']},
      {topic:'matter', level:'medium', q:'××” ×¦×¤×™×¤×•×ª ××•××¨×ª ×¢×œ ×¦×™×¤×” ×‘××™×?', correct:'×¤×—×•×ª ×¦×¤×•×£ ×××™× ×™×¦×•×£', wrong:['×™×•×ª×¨ ×¦×¤×•×£ ×™×¦×•×£','×¦×¤×™×¤×•×ª ×œ× ×§×©×•×¨×”','×ª×œ×•×™ ×‘×¦×‘×¢'], hint:'×”×©×•×•××ª ×¦×¤×™×¤×•×™×•×ª.', steps:['××©×•×•×™× ×œ×¦×¤×™×¤×•×ª ××™×.','×¤×—×•×ª ×™×¦×•×£.']},
      {topic:'space', level:'medium', q:'×œ××” ×™×© ×¢×•× ×•×ª?', correct:'×›×™ ×¦×™×¨ ×›×“×•×¨ ×”××¨×¥ × ×˜×•×™', wrong:['×›×™ ×”××¡×œ×•×œ ××©×ª× ×” ×”×¨×‘×”','×›×™ ×”×©××© ×—××” ×™×•×ª×¨ ×‘×§×™×¥','×›×™ ×”×™×¨×— ×§×¨×•×‘'], hint:'×–×•×•×™×ª ××•×œ ×”×©××©.', steps:['× ×˜×™×™×ª ×¦×™×¨.','×©×™× ×•×™ ×‘×–×•×•×™×ª ×§×¨×™× ×”.']},
      {topic:'tools', level:'easy', q:'××”×™ ×”×©×¢×¨×” ×‘× ×™×¡×•×™?', correct:'× ×™×—×•×© ×—×›× ×©××¤×©×¨ ×œ×‘×“×•×§', wrong:['×ª×•×¦××” ×¡×•×¤×™×ª','×—×•×§ ×˜×‘×¢','×˜×¢×•×ª ×‘××“×™×“×”'], hint:'××©×¤×˜ ×©× ×‘×“×§.', steps:['×—×•×©×‘×™× ××” ×™×§×¨×”.','×‘×•×“×§×™× ×‘××¢×©×”.']},
      {topic:'life', level:'easy', q:'××” ×¦××—×™× ×¦×¨×™×›×™× ×›×“×™ ×œ×’×“×•×œ?', correct:'××•×¨, ××™×, ××•×•×™×¨ ×•××“××”', wrong:['×¨×§ ××™×','×¨×§ ×©××©','×¨×§ ×“×©×Ÿ'], hint:'×›××” ×’×•×¨××™× ×™×—×“.', steps:['××•×¨ ×œ×¤×•×˜×•×¡×™× ×ª×–×”.','××™× ×•××™× ×¨×œ×™×.']},
      {topic:'magnet', level:'easy', q:'×”×× ×›×œ ××ª×›×ª × ××©×›×ª ×œ××’× ×˜?', correct:'×œ×, ×¨×§ ××¡×•×™××•×ª ×›××• ×‘×¨×–×œ', wrong:['×›×Ÿ, ×›×•×œ×Ÿ','×¨×§ ×–×”×‘','×¨×§ ××œ×•××™× ×™×•×'], hint:'×œ× ×›×œ ××ª×›×ª ×¤×¨×•××’× ×˜×™×ª.', steps:['×××’× ×˜×™× ×©×•× ×™×.','×‘×¨×–×œ, × ×™×§×œ, ×§×•×‘×œ×˜.']},
      {topic:'electricity', level:'medium', q:'××” ×ª×¤×§×™×“×” ×©×œ ××‘×•×“×“ ×‘××¢×’×œ?', correct:'×œ×¢×¦×•×¨ ×–×¨×™××ª ×–×¨×', wrong:['×œ×”×’×‘×™×¨ ×–×¨×','×œ×”×—×œ×™×£ ×¡×•×œ×œ×”','×œ×”××™×¨ × ×•×¨×”'], hint:'×—×•××¨ ×©×œ× ××•×œ×™×š.', steps:['×—×•×©×‘×™× ×¢×œ ×¤×œ×¡×˜×™×§.','×œ× × ×•×ª×Ÿ ×œ××œ×§×˜×¨×•× ×™× ×œ× ×•×¢.']},
      {topic:'sound', level:'easy', q:'×‘××™×–×” ×ª×• × ×©××¢ ×§×•×œ ×’×‘×•×” ×™×•×ª×¨?', correct:'×‘×ª×“×¨ ×’×‘×•×” ×™×•×ª×¨', wrong:['×‘×ª×“×¨ × ××•×š ×™×•×ª×¨','×‘×¢×•×¦××” ×—×–×§×” ×™×•×ª×¨','×‘××”×™×¨×•×ª ×§×•×œ ×’×‘×•×”×”'], hint:'×’×•×‘×” ×©×•×•×” ×œ×ª×“×¨.', steps:['×›××” ×¤×¢××™× ×¨×•×˜×˜ ×‘×©× ×™×™×”.','×™×•×ª×¨ ×¨×˜×™×˜×•×ª ×™×•×ª×¨ ×’×‘×•×”.']},
      {topic:'weather', level:'easy', q:'××” × ×•×¦×¨ ×›×©××“×™ ××™× ×‘××•×•×™×¨ ××ª×§×¨×¨×™×?', correct:'×¢× × ×™×', wrong:['×¨×•×—','×‘×¨×§','×§×©×ª'], hint:'×˜×™×¤×•×ª ×–×¢×™×¨×•×ª.', steps:['×”×ª×¢×‘×•×ª.','×¢× × ×™×.']},
      {topic:'matter', level:'medium', q:'××” ×”×”×‘×“×œ ×‘×™×Ÿ ××¡×” ×œ××©×§×œ?', correct:'××¡×” ×›××•×ª ×—×•××¨, ××©×§×œ ×›×•×— ×”×›×‘×™×“×” ×¢×œ×™×•', wrong:['××™×Ÿ ×”×‘×“×œ','××¡×” ×”×™× ×›×•×—','××©×§×œ ×”×•× ×›××•×ª ×—×•××¨'], hint:'×›××•×ª ××•×œ ×›×•×—.', steps:['××¡×” ×ª××™×“×™×ª.','××©×§×œ ×ª×œ×•×™ ×‘×›×‘×™×“×”.']},
      {topic:'mechanics', level:'medium', q:'××”×™ ××™× ×¨×¦×™×”?', correct:'× ×˜×™×™×” ×œ×”××©×™×š ×‘××¦×‘ ×ª× ×•×¢×” ×§×™×™×', wrong:['×›×•×— ×©×××™×¥ ×›×œ ×’×•×£','×ª×›×•× ×” ×©×œ × ×•×–×œ×™× ×‘×œ×‘×“','××“×—×£'], hint:'×œ× ××•×”×‘×™× ×©×™× ×•×™.', steps:['×’×•×£ ×‘×× ×•×—×” ×™×™×©××¨ ×›×š.','×•×’× ×‘×ª× ×•×¢×”.']},
      {topic:'light', level:'easy', q:'××” ×™×§×¨×” ×›×©××•×¨ ×¢×•×‘×¨ ×××™×™×œ×” ×œ××•×•×™×¨?', correct:'×™×©×‘×¨ ×•×™×—×œ×™×£ ×›×™×•×•×Ÿ', wrong:['×™×¢×¦×•×¨','×©×•× ×“×‘×¨','×™×”×¤×•×š ×œ×¦×œ×™×œ'], hint:'×©×‘×™×¨×” ×‘×’×‘×•×œ ×—×•××¨×™×.', steps:['×©×™× ×•×™ ××”×™×¨×•×ª.','×›×™×•×•×Ÿ ××©×ª× ×”.']},
      {topic:'tools', level:'medium', q:'×œ××” ×¢×•×©×™× ×—×–×¨×” ×‘××“×™×“×”?', correct:'×›×“×™ ×œ×‘×“×•×§ ×¢×§×‘×™×•×ª ×•×××™× ×•×ª', wrong:['×›×“×™ ×œ×©× ×•×ª ×ª×•×¦××”','×›×“×™ ×œ×§×¦×¨ ×–××Ÿ','×›×“×™ ×œ×‘×œ×‘×œ'], hint:'××“×™×“×” ××—×ª ×œ× ×ª××™×“ ×××™× ×”.', steps:['××•×“×“ ×›××” ×¤×¢××™×.','××©×•×•×™×.']},
      {topic:'energy', level:'easy', q:'××™×–×” ××§×•×¨ ×× ×¨×’×™×” ××ª×—×“×©?', correct:'×©××©', wrong:['×¤×—×','× ×¤×˜','×’×–'], hint:'×‘× ××”×˜×‘×¢ ×›×œ ×”×–××Ÿ.', steps:['×–×•×›×¨×™× ×¨×•×— ×•×©××©.','×œ× × ×’××¨ ××”×¨.']},
      {topic:'space', level:'easy', q:'××” ××¡×ª×•×‘×‘ ×¡×‘×™×‘ ×›×“×•×¨ ×”××¨×¥?', correct:'×”×™×¨×—', wrong:['×”×©××©','××¨×¡','×•× ×•×¡'], hint:'×’×¨××™ ×©××™×™× ×§×¨×•×‘×™×.', steps:['×œ×™×œ×” ×¨×•××™× ×™×¨×—.','×”×•× ×¡×‘×™×‘× ×•.']},
      {topic:'friction', level:'medium', q:'××™×š ××¤×—×™×ª×™× ×—×™×›×•×š ×‘×¦×™×¨?', correct:'××©×× ×™×', wrong:['××—×××™×','×©××™× ×—×•×œ','××’×“×™×œ×™× ×œ×—×¥'], hint:'×©×›×‘×” ×—×œ×§×” ××¤×—×™×ª×” ×—×™×›×•×š.', steps:['×©××Ÿ ××• ×’×¨×™×–.','×™×•×ª×¨ ×”×—×œ×§×”.']},
      {topic:'mechanics', level:'hard', q:'××”×™ ××”×™×¨×•×ª ×××•×¦×¢×ª?', correct:'×“×¨×š ×—×œ×§×™ ×–××Ÿ', wrong:['×ª××•×¦×” ×—×œ×§×™ ×–××Ÿ','×›×•×— ×—×œ×§×™ ××¡×”','×“×¨×š ×—×œ×§×™ ××¡×”'], hint:'× ×•×¡×—×” ×‘×¡×™×¡×™×ª.', steps:['v=s/t.','×™×—×™×“×•×ª ××˜×¨ ×œ×©× ×™×™×”.']},
      {topic:'electricity', level:'hard', q:'××” ×ª×¤×§×™×“ × ×’×“ ×‘×˜×•×¨×™ ××•×œ × ×•×¨×”?', correct:'×œ×”×§×˜×™×Ÿ ×–×¨× ××œ ×”× ×•×¨×”', wrong:['×œ×”×’×“×™×œ ××ª×— ×‘×œ×‘×“','×œ×©× ×•×ª ×¦×‘×¢ × ×•×¨×”','×œ×›×‘×•×ª ××ª ×”××¢×’×œ'], hint:'××©× ×” ××ª R ×”×›×•×œ×œ×ª.', steps:['I=V/R.','×¤×—×•×ª ×–×¨×.']},
      {topic:'magnet', level:'medium', q:'××” ×™×§×¨×” ×œ××’× ×˜ ×× × ×—×¦×” ××•×ª×•?', correct:'×™×”×™×• ×©× ×™ ××’× ×˜×™× ×¢× ×¦×¤×•×Ÿ ×•×“×¨×•×', wrong:['×¦×¤×•×Ÿ ×œ×‘×“ ×•×“×¨×•× ×œ×‘×“','×™××‘×“ ×›×•×—','×™×”×¤×•×š ×œ××ª×›×ª ×¨×’×™×œ×”'], hint:'×›×œ ×—×œ×§ ××§×‘×œ ×©× ×™ ×§×˜×‘×™×.', steps:['×—×•×ª×›×™×.','×¢×“×™×™×Ÿ ×™×© ×©× ×™ ×§×˜×‘×™×.']},
      {topic:'sound', level:'medium', q:'××” ×§×•×‘×¢ ××ª ××”×™×¨×•×ª ×”×§×•×œ?', correct:'×”×—×•××¨ ×©×‘×• ×”×•× × ×¢', wrong:['×”×¢×•×¦××”','×”×ª×“×¨','×”×××¤×œ×™×˜×•×“×”'], hint:'×‘××•×™×¨ ×œ×¢×•××ª ××™×.', steps:['×ª×œ×•×™ ×ª×•×•×š.','××™× ××”×¨ ×™×•×ª×¨ ×××•×•×™×¨.']},
      {topic:'weather', level:'hard', q:'××”×™ ×”×ª×¢×‘×•×ª?', correct:'××¢×‘×¨ ×’×– ×œ× ×•×–×œ', wrong:['× ×•×–×œ ×œ××•×¦×§','××•×¦×§ ×œ×’×–','× ×•×–×œ ×œ×’×–'], hint:'×§×™×¨×•×¨ ××“×™×.', steps:['××“×™ ××™× ××ª×§×¨×¨×™×.','× ×˜×™×¤×•×ª.']},
      {topic:'matter', level:'hard', q:'××™×–×” ×—×œ×§×™×§ × ×•×©× ××˜×¢×Ÿ ×©×œ×™×œ×™?', correct:'××œ×§×˜×¨×•×Ÿ', wrong:['×¤×¨×•×˜×•×Ÿ','× ×™×™×˜×¨×•×Ÿ','×¤×•×–×™×˜×¨×•×Ÿ'], hint:'×‘×—×•××¨ ××•×œ×™×š.', steps:['×‘××˜×•×.','×©×œ×™×œ×™ ×”×•× ××œ×§×˜×¨×•×Ÿ.']},
      {topic:'life', level:'medium', q:'××”×™ ××¢×¨×›×ª ×”× ×©×™××”?', correct:'××¢×¨×›×ª ×©××›× ×™×¡×” ×—××¦×Ÿ ×•××•×¦×™××” ×¤×“"×—', wrong:['××¢×¨×›×ª ××–×•×Ÿ','××¢×¨×›×ª ×—×•×','××¢×¨×›×ª ×¢×¦×‘×™×'], hint:'×¨×™××•×ª ×•××•×•×™×¨.', steps:['× ×©×™××”.','×—×™×œ×•×£ ×’×–×™×.']},
      {topic:'tools', level:'hard', q:'××”×™ ×‘×§×¨×” ××©×ª× ×” ×™×—×™×“×” ×‘× ×™×¡×•×™?', correct:'×©×™× ×•×™ ×’×•×¨× ××—×“ ×‘×œ×‘×“', wrong:['×©×™× ×•×™ ×”×›×œ ×™×—×“','×‘×œ×™ ×‘×™×§×•×¨×ª','××“×™×“×” ××—×ª'], hint:'×©×•××¨×™× ×§×‘×•×¢×™×.', steps:['××©× ×™× ×¨×§ ×’×•×¨× ××—×“.','×‘×•×“×§×™× ×”×©×¤×¢×”.']}
      // ××¤×©×¨ ×œ×”×¨×—×™×‘ ×¢×•×“ ×‘×”××©×š; × ×™×¦×•×¨ ×•×¨×™××¦×™×•×ª ×œ×”×’×¢×” ×œ>200
    ];

    function expandFacts(baseFacts){
      const variants=[];
      baseFacts.forEach((f,idx)=>{
        const forms=[
          f.q,
          '×‘×—×¨×• ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”: ' + f.q,
          '××” × ×›×•×Ÿ? ' + f.q
        ];
        forms.forEach((text,vi)=>{
          const wrong = shuffleArr(f.wrong).slice(0,3);
          const choices = shuffleArr([f.correct, ...wrong]);
          const correctIndex = choices.indexOf(f.correct);
          variants.push({
            id: f.topic + ':' + idx + ':' + vi,
            q: text,
            choices,
            correct: correctIndex,
            hint: f.hint || '',
            steps: f.steps ? f.steps.slice() : [],
            topic: f.topic,
            level: f.level
          });
        });
      });
      return variants;
    }

    function shuffleArr(a){ const c=a.slice(); for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]]; } return c }

    // Build a large bank > 200
    const SCIENCE_BANK = expandFacts(BASE_FACTS);

    /* ========= Recent question memory to avoid repeats ========= */
    function rememberUsed(ids){ const maxKeep = 120; const arr = store.recentIds||[]; const merged = ids.concat(arr); store.recentIds=[...new Set(merged)].slice(0,maxKeep); saveStore(); }
    function filterUnused(bank){ const used = new Set(store.recentIds || []); return bank.filter(q=>!used.has(q.id)); }

    /* ========= UI Helpers ========= */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);
    function focusTop(selector){ const el=typeof selector==='string'?document.querySelector(selector):selector; const target=el||document.body; if(target && !target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1'); requestAnimationFrame(()=>{ window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); try{ target && target.focus({preventScroll:true}); }catch{} }); }

    function selectChoice(containerSel,itemSel,onChange){ const cont=$(containerSel); if(!cont) return; cont.addEventListener('click', e=>{ const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return; $$(containerSel+' '+itemSel).forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); }); btn.classList.add('selected'); btn.setAttribute('aria-pressed','true'); onChange && onChange(btn); }); cont.addEventListener('keydown', e=>{ const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return; if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); } }); }

    /* ========= Screens ========= */
    const SCREENS=['welcomeScreen','nameScreen','topicsScreen','difficultyScreen','gameScreen','resultsScreen','mistakesScreen','profileScreen'];
    function showScreen(id){ SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden')); $('#'+id)?.classList.remove('hidden'); window.scrollTo({top:0,left:0,behavior:'auto'}); }

    /* ========= Topics UI ========= */
    function buildTopicsGrid(){ const grid=$('#topicsGrid'); grid.innerHTML=''; TOPICS.forEach(t=>{ const b=document.createElement('button'); b.type='button'; b.className='choice-card'; b.setAttribute('data-tint','blue'); b.setAttribute('aria-pressed','false'); b.dataset.value=t.id; b.innerHTML=`<span class="accent" aria-hidden="true"></span><div class="emoji">${t.emoji}</div><div class="text-xl font-bold text-gray-800">${t.label}</div>`; b.onclick=()=>{ if(selectedTopics.has(t.id)){ selectedTopics.delete(t.id); b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); } else { selectedTopics.add(t.id); b.classList.add('selected'); b.setAttribute('aria-pressed','true'); } updateTopicsNextState(); }; grid.appendChild(b); }); refreshTopicsOverflow(); }
    function refreshTopicsOverflow(){ const grid=$('#topicsGrid'), more=$('#topicsMore'), fade=$('#topicsFade'); if(!grid||!more||!fade) return; const overflow=grid.scrollHeight>grid.clientHeight+2; more.classList.toggle('hidden', !overflow && !isTopicsExpanded); fade.classList.toggle('hidden', isTopicsExpanded || !overflow); }
    let isTopicsExpanded=false; function setTopicsExpanded(expanded){ isTopicsExpanded=!!expanded; const grid=$('#topicsGrid'), more=$('#topicsMore'); grid.classList.toggle('topics-collapsed', !isTopicsExpanded); more.textContent=isTopicsExpanded?'×”×¦×’ ×¤×—×•×ª':'×”×¦×’ ×¢×•×“'; more.setAttribute('aria-expanded', isTopicsExpanded?'true':'false'); refreshTopicsOverflow(); }
    function updateTopicsNextState(){ const next=$('#topicsNext'); next.disabled=false; next.setAttribute('aria-disabled','false'); }

    /* ========= Game building ========= */
    function buildSessionFromBank(){
      // Filter by selected topics and difficulty
      let pool = SCIENCE_BANK.filter(q=> selectedTopics.size===0 || selectedTopics.has(q.topic));
      pool = pool.filter(q=> q.level===currentDifficulty);
      // Avoid repeats
      const fresh = filterUnused(pool);
      let pickFrom = fresh.length >= questionCount ? fresh : pool; // fallback if not enough fresh
      pickFrom = shuffleArr(pickFrom);
      const chosen = pickFrom.slice(0, questionCount);
      if(chosen.length < questionCount){ alert('×œ× × ××¦× ××¡×¤×™×§ ×©××œ×•×ª ×œ×”×ª×××”. × × ×¡×” ×¢× ×¡×˜ ×›×œ×œ×™.'); pickFrom = shuffleArr(SCIENCE_BANK.filter(q=>q.level===currentDifficulty)); questions = pickFrom.slice(0, questionCount); }
      else { questions = chosen; }
      rememberUsed(questions.map(q=>q.id));

      currentQuestionIndex=0; correctCount=0; totalTime=0; selectedAnswer=null; mistakes=[];
      totalQuestions = questions.length; $('#totalQuestions').textContent=totalQuestions; $('#resultsTotal').textContent=totalQuestions;
      renderQuestion();
    }

    function renderQuestion(){ if(currentQuestionIndex>=questions.length){ showResults(); return; } selectedAnswer=null; const q=questions[currentQuestionIndex]; $('#questionText').textContent=q.q; $('#currentQuestion').textContent=currentQuestionIndex+1; const prog=(currentQuestionIndex/totalQuestions)*100; const pb=$('#progressBar'); const p=Math.max(2,Math.round(prog)); pb.style.width=p+'%'; pb.setAttribute('aria-valuenow',String(p)); const grid=$('#answersGrid'); grid.innerHTML=''; q.choices.forEach((opt,i)=>{ const el=document.createElement('div'); el.className='answer-item shadow-lg flex items-center justify-center min-h-[88px] p-4'; el.setAttribute('data-value',String(i)); el.setAttribute('data-idx',String(i)); el.setAttribute('tabindex','0'); el.setAttribute('role','button'); el.setAttribute('aria-selected','false'); el.innerHTML=`<span class="accent" aria-hidden="true"></span><div class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-tight ltr">${opt}</div>`; el.addEventListener('click',()=>chooseAnswer(i, el)); el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); chooseAnswer(i, el);} }); grid.appendChild(el); }); disableConfirm(); $('#hintBox').classList.add('hidden'); $('#hintBox').textContent=''; const hasAssist=(q.steps && q.steps.length) || q.hint; $('#hintBtn').disabled = !hasAssist; $('#hintBtn').textContent = (q.steps && q.steps.length)?'×¨××– 1':'×¨××–'; startTime=Date.now(); }

    function chooseAnswer(index, el){ $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); }); el.classList.add('selected'); el.setAttribute('aria-selected','true'); selectedAnswer=index; enableConfirm(); playSelectTick(); }

    function enableConfirm(){ const btn=$('#confirmButton'); btn.disabled=false; btn.removeAttribute('disabled'); btn.setAttribute('aria-disabled','false'); }
    function disableConfirm(){ const btn=$('#confirmButton'); btn.disabled=true; btn.setAttribute('disabled',''); btn.setAttribute('aria-disabled','true'); }

    function confirmAnswer(){ const btn=$('#confirmButton'); if(!btn || btn.hasAttribute('disabled')) return; if(selectedAnswer===null) return; disableConfirm(); const q=questions[currentQuestionIndex]; const end=Date.now(); totalTime=Math.max(0,totalTime+(end-startTime)/1000); const isLast=currentQuestionIndex===totalQuestions-1; if(selectedAnswer===q.correct){ correctCount++; playSuccessSound(); } else { mistakes.push({ question:q, userAnswer:q.choices[selectedAnswer], correctAnswer:q.choices[q.correct], reviewed:false }); playErrorSound(); const hb=$('#hintBox'); if(q.steps && q.steps.length){ hb.textContent=q.steps[0]; hb.classList.remove('hidden'); $('#hintBtn').disabled = q.steps.length<=1; $('#hintBtn').textContent = q.steps.length>1?'×¨××– 2':'××™×Ÿ ×¢×•×“ ×¨××–×™×'; currentHintStep=1; } else if(q.hint){ hb.textContent=q.hint; hb.classList.remove('hidden'); $('#hintBtn').disabled=true; }
      }
      if(isLast){ showFinalFeedback(); } else { setTimeout(()=>{ currentQuestionIndex++; renderQuestion(); $('#confirmButton').focus(); }, 900); }
    }

    let currentHintStep=0;
    $('#hintBtn').addEventListener('click',()=>{ const q=questions[currentQuestionIndex]; if(!q) return; const hb=$('#hintBox'); if(q.steps && q.steps.length){ if(currentHintStep<q.steps.length){ hb.textContent=q.steps[currentHintStep]; hb.classList.remove('hidden'); currentHintStep++; $('#hintBtn').textContent = currentHintStep<q.steps.length? ('×¨××– ' + (currentHintStep+1)) : '××™×Ÿ ×¢×•×“ ×¨××–×™×'; if(currentHintStep>=q.steps.length) $('#hintBtn').disabled=true; } } else if(q.hint){ hb.textContent=q.hint; hb.classList.remove('hidden'); $('#hintBtn').disabled=true; } playSelectTick(); });

    function showFinalFeedback(){ const fb=$('#feedback'), icon=$('#feedbackIcon'), text=$('#feedbackText'), nextBtn=$('#nextButton'); const pct=Math.round((correctCount/totalQuestions)*100); if(pct===100){ icon.textContent='ğŸ‘'; text.className='text-2xl font-bold mb-6 text-green-600'; text.textContent='××œ×•×¤×™×, ×¡×™×™×× ×• ××ª ×”×¡×˜'; } else if(pct>=60){ icon.textContent='ğŸ‘'; text.className='text-2xl font-bold mb-6 text-blue-600'; text.textContent='××¢×•×œ×”, ×××©×™×›×™× ×œ×œ××•×“'; } else { icon.textContent='ğŸ’ª'; text.className='text-2xl font-bold mb-6 text-orange-600'; text.textContent='×¡×™×™×× ×• ××ª ×”×¡×˜'; } nextBtn.textContent='×œ×¡×™×›×•× ×”×ª×•×¦××•×ª'; lastFocusEl = document.activeElement; nextBtn.onclick=()=>{ $('#feedback').classList.add('hidden'); showResults(); lastFocusEl && lastFocusEl.focus(); }; fb.classList.remove('hidden'); trapDialog('#feedback'); }

    function trapDialog(modalSel){ const modal=$(modalSel); if(!modal) return; const getF=()=>modal.querySelectorAll('button,[href],[tabindex]:not([tabindex="-1"])'); function onKey(e){ if(e.key==='Escape'){ modal.classList.add('hidden'); modal.removeEventListener('keydown',onKey); lastFocusEl && lastFocusEl.focus(); return; } if(e.key!=='Tab') return; const f=[...getF()]; if(!f.length) return; const first=f[0], last=f[f.length-1]; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } } modal.addEventListener('keydown',onKey); requestAnimationFrame(()=>{ const f=getF()[0]; f && f.focus(); }); }

    function showResults(){ showScreen('resultsScreen'); const incorrect=totalQuestions-correctCount; const pct=Math.round((correctCount/totalQuestions)*100); const prof=getActiveProfile(); const displayName=prof?prof.name:playerName; $('#resultsTitle').textContent = pct>=90 ? `×›×œ ×”×›×‘×•×“ ${displayName}, ×©×•×¤×™ ×’××”!` : pct>=60 ? `${displayName} ×¢×‘×•×“×” ×™×¤×”, × ××©×™×š ×œ×ª×¨×’×œ` : `${displayName} ×××©×™×›×™× ×œ×©×¤×¨, ×©×•×¤×™ ×›××Ÿ ×œ×¢×–×•×¨`; updatePerformanceBar(correctCount,incorrect,pct); $('#correctAnswers').textContent=String(correctCount); $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/totalQuestions))); $('#mistakesButton').classList.toggle('hidden', mistakes.length===0); logSessionToProfile(new Set(questions.map(q=>q.topic))); focusTop('#resultsTitle'); }

    function updatePerformanceBar(correct,incorrect,pct){ $('#correctBar').style.width=(correct/totalQuestions*100)+'%'; $('#incorrectBar').style.width=(incorrect/totalQuestions*100)+'%'; $('#performancePercentage').textContent=pct+'%'; $('#correctCount').textContent=String(correct); $('#incorrectCount').textContent=String(incorrect); }

    /* ========= Mistakes ========= */
    function showMistakes(){ showScreen('mistakesScreen'); const incorrect=totalQuestions-correctCount; $('#mistakesCorrectBar').style.width=((correctCount/totalQuestions)*100)+'%'; $('#mistakesIncorrectBar').style.width=((incorrect/totalQuestions)*100)+'%'; const mm=$('#mistakesMessage'); if(mistakes.length===0){ mm.textContent='××•×©×œ×, ××™×Ÿ ×˜×¢×•×™×•×ª!'; $('#mistakesList').innerHTML='<div class="text-center p-8"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold text-green-600">×›×œ ×”×›×‘×•×“!</h3><p class="text-lg text-gray-600">×¢× ×™×ª × ×›×•×Ÿ ×¢×œ ×›×œ ×”×©××œ×•×ª.</p></div>'; focusTop('#mistakesTitle'); return; } else if(correctCount>0){ mm.textContent='× ×œ××“ ×™×—×“ ××”×˜×¢×•×™×•×ª ×©× ×©××¨×•.'; } else { mm.textContent='×‘×•××• × ×¢×‘×•×¨ ×¢×œ ×”×”×¡×‘×¨×™× ×¦×¢×“ ×¦×¢×“.'; }
      const list=$('#mistakesList'); list.innerHTML=''; questions.forEach((q,i)=>{ const m=mistakes.find(x=>x.question.id===q.id); if(!m) return; const d=document.createElement('div'); d.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-6'; d.innerHTML=`<div class="flex items-center justify-between mb-4"><div class="flex items-center gap-3"><div class="w-4 h-4 bg-orange-500 rounded-full"></div><h3 class="text-xl font-bold text-orange-600">×©××œ×” ${(i+1)}</h3></div><div class="text-2xl">ğŸ¤”</div></div><div class="text-xl font-bold text-gray-800 mb-3">${m.question.q}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3"><div class="bg-red-100 border-2 border-red-300 rounded-xl p-4"><div class="text-sm text-red-600 font-bold mb-1">×”×ª×©×•×‘×” ×©×œ×š</div><div class="text-lg font-bold text-red-700 ltr">${m.userAnswer}</div></div><div class="bg-green-100 border-2 border-green-300 rounded-xl p-4"><div class="text-sm text-green-600 font-bold mb-1">×”×ª×©×•×‘×” ×”× ×›×•× ×”</div><div class="text-lg font-bold text-green-700 ltr">${m.correctAnswer}</div></div></div>`; const help=document.createElement('div'); help.className='mt-2 text-gray-700'; const steps=m.question.steps && m.question.steps.length ? m.question.steps : (m.question.hint?[m.question.hint]:[]); if(steps.length){ const btn=document.createElement('button'); btn.className='mt-2 px-4 py-2 rounded-xl bg-blue-600 text-white font-bold'; btn.textContent='×¨××–×™× ×¦×¢×“ ×¦×¢×“'; let at=0; const hb=document.createElement('div'); hb.className='mt-2 bg-blue-50 border-2 border-blue-200 rounded-2xl p-3 text-right'; btn.onclick=()=>{ hb.textContent=steps[Math.min(at,steps.length-1)]; at++; if(at>=steps.length) btn.disabled=true; }; help.appendChild(btn); help.appendChild(hb); }
        d.appendChild(help); list.appendChild(d); }); focusTop('#mistakesTitle'); }

    /* ========= Profile ========= */
    function showProfile(){ showScreen('profileScreen'); renderProfile(); focusTop('#profileScreen .text-indigo-600'); }
    function setSwitchBtnDisabled(disabled){ const btn=$('#profileSwitchBtn'); if(!btn) return; btn.disabled=disabled; btn.classList.toggle('opacity-50', disabled); }
    function renderProfile(){ const prof=getActiveProfile(); const header=$('#profileHeader'); const totalUsers=profilesArr().length; setSwitchBtnDisabled(totalUsers<=1); if(!prof){ header.textContent='××™×Ÿ ××©×ª××© ×¤×¢×™×œ. ××¤×©×¨ ×œ×™×¦×•×¨ ××©×ª××© ×—×“×© ××• ×œ×”×—×œ×™×£ ×œ××©×ª××© ×§×™×™×.'; $('#kpiSets').textContent='0'; $('#kpiAccuracy').textContent='0%'; $('#kpiAvg').textContent='0s'; $('#byTopicGrid').innerHTML=''; $('#historyList').innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>'; return; } header.innerHTML=`××©×ª××© ×¤×¢×™×œ: <span class="font-bold text-gray-900">${prof.name}</span>`; const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0}; const acc=tot.questions>0?Math.round((tot.correct/tot.questions)*100):0; const avg=tot.questions>0?Math.round(tot.timeSec/tot.questions):0; $('#kpiSets').textContent=String(tot.sets||0); $('#kpiAccuracy').textContent=acc+'%'; $('#kpiAvg').textContent=(avg||0)+'s'; const grid=$('#byTopicGrid'); grid.innerHTML=''; TOPICS.forEach(t=>{ const b=prof.byTopic?.[t.id]; const s=b?.sets||0, q=b?.questions||0, c=b?.correct||0, a=q?Math.round(c/q*100):0; const card=document.createElement('div'); card.className='p-4 rounded-2xl border-2 border-gray-200 bg-gray-50'; card.innerHTML=`<div class="font-bold mb-2">${t.emoji} ${t.label}</div><div class="text-sm text-gray-600 mb-1">×¡×˜×™×: <span class="ltr">${s}</span></div><div class="text-sm text-gray-600 mb-1">×“×™×•×§: <span class="ltr">${a}%</span></div><div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div style="width:${a}%" class="h-2 bg-blue-500"></div></div>`; grid.appendChild(card); }); const h=prof.history||[]; const list=$('#historyList'); list.innerHTML=''; if(h.length===0){ list.innerHTML='<div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¡×˜×™× ×¢×“×™×™×Ÿ.</div>'; } else { h.slice(0,12).forEach(item=>{ const pct=Math.round((item.correct/item.count)*100); const row=document.createElement('div'); row.className='p-3 border-2 border-gray-200 rounded-xl bg-white flex items-center justify-between gap-3'; const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'}); const topicsTxt=item.topics.map(id=> (TOPICS.find(x=>x.id===id)?.label)||id).join(', '); row.innerHTML=`<div><div class="text-sm text-gray-500">${date}</div><div class="text-gray-800">${topicsTxt||'××’×•×•×Ÿ'}</div><div class="text-sm text-gray-500">×¨××”: ${item.diff} Â· ×©××œ×•×ª: ${item.count}</div></div><div class="text-right"><div class="text-xl font-extrabold ${pct===100?'text-green-600': pct>=60?'text-blue-600':'text-orange-600'} ltr">${pct}%</div><div class="text-sm text-gray-500">×˜×¢×•×™×•×ª: ${item.mistakesCount}</div></div>`; list.appendChild(row); }); }
    }

    /* ========= Navigation & actions ========= */
    function showNameInput(){ const prof=getActiveProfile(); showScreen('nameScreen'); const subtitle=$('#nameSubtitle'); if(prof){ $('#playerName').value=prof.name; subtitle.textContent=`× ×¢×™× ×œ×¨××•×ª×š ×©×•×‘, ${prof.name}!`; subtitle.classList.remove('hidden'); } else { $('#playerName').value=''; subtitle.classList.add('hidden'); } focusTop('#nameTitle'); }
    function showTopics(){ let name=''; const prof=getActiveProfile(); if(prof && prof.name) name=prof.name.trim(); else { const inp=$('#playerName'); const typed=(inp?.value||'').trim(); if(!typed){ alert('×× × ×”×›× ×¡ ××ª ×©××š'); inp?.focus(); return; } name=typed; } playerName=name; ensureProfileByName(name); showScreen('topicsScreen'); selectedTopics=new Set(); buildTopicsGrid(); setTopicsExpanded(false); $('#topicsNext').disabled=true; $('#topicsNext').setAttribute('aria-disabled','true'); focusTop('#topicsTitle'); }

    function showDifficulty(){ showScreen('difficultyScreen'); $$('#difficultyScreen .diff-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); }); $$('#countChips .chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); }); $('#diffNext').disabled=true; $('#diffNext').setAttribute('aria-disabled','true'); focusTop('#diffTitle'); }

    function startGame(){ $('#feedback')?.classList.add('hidden'); const nb=$('#nextButton'); if(nb) nb.onclick=null; correctCount=0; totalTime=0; buildSessionFromBank(); showScreen('gameScreen'); const prof=getActiveProfile(); playerName=prof?prof.name:playerName; $('#gamePlayerName').textContent=playerName; const pb=$('#progressBar'); pb.style.width='0%'; pb.setAttribute('aria-valuenow','0'); focusTop('#questionText'); }

    function bindAll(){ initAudioToggle(); $('#startBtn')?.addEventListener('click',()=>{ unlockAudioOnce(); showNameInput(); }); $('#nameForm')?.addEventListener('submit', e=>{ e.preventDefault(); unlockAudioOnce(); showTopics(); }); $('#profileOrSwitchBtn')?.addEventListener('click',()=>{ const arr=profilesArr(); if(arr.length>1) showUserPicker(); else showProfile(); }); $('#profileBtn')?.addEventListener('click',()=> showProfile()); $('#profileFromResultsBtn')?.addEventListener('click',()=> showProfile()); $('#profileStartBtn')?.addEventListener('click',()=>{ const prof=getActiveProfile(); if(!prof){ showNameInput(); return; } playerName=prof.name; showTopics(); }); $('#profileSwitchBtn')?.addEventListener('click',()=>{ if(profilesArr().length>1) showUserPicker(); }); $('#profileNewBtn')?.addEventListener('click',()=>{ store.activeId=null; saveStore(); showNameInput(); }); $('#topicsMore')?.addEventListener('click',()=> setTopicsExpanded(!isTopicsExpanded)); $('#topicsNext')?.addEventListener('click',()=> showDifficulty()); selectChoice('#difficultyScreen','.diff-btn',(btn)=>{ currentDifficulty=btn.getAttribute('data-diff'); updateDiffNextState(); }); selectChoice('#countChips','.chip',(chip)=>{ questionCount=parseInt(chip.getAttribute('data-count'),10); updateDiffNextState(); }); $('#diffNext')?.addEventListener('click',()=> startGame()); $('#confirmButton')?.addEventListener('click',confirmAnswer); $('#restartBtn')?.addEventListener('click',()=> showNameInput()); $('#retryBtn')?.addEventListener('click',()=> startGame()); $('#mistakesButton')?.addEventListener('click',()=> showMistakes()); $('#altBtn')?.addEventListener('click',()=> showTopics()); $('#backToResults')?.addEventListener('click',()=> showResults()); $('#restartFromMistakes')?.addEventListener('click',()=> showNameInput()); window.addEventListener('resize', refreshTopicsOverflow); }

    function updateDiffNextState(){ const next=$('#diffNext'); const ok=!!currentDifficulty && !!questionCount; next.disabled=!ok; next.setAttribute('aria-disabled', ok?'false':'true'); }

    function showUserPicker(){ const list=$('#userList'); list.innerHTML=''; const arr=profilesArr(); if(arr.length<=1){ $('#userPickerModal').classList.add('hidden'); showProfile(); return; } arr.forEach(p=>{ const btn=document.createElement('button'); btn.className='w-full text-right p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 flex items-center justify-between'; btn.innerHTML=`<span class="font-bold text-gray-800">${p.name}</span><span class="text-sm text-gray-500 ltr">${new Date(p.lastSeen||Date.now()).toLocaleDateString('he-IL')}</span>`; btn.onclick=()=>{ setActiveProfile(p.id); $('#playerName').value=p.name; $('#userPickerModal').classList.add('hidden'); if(!$('#profileScreen').classList.contains('hidden')) renderProfile(); lastFocusEl && lastFocusEl.focus(); }; list.appendChild(btn); }); lastFocusEl = document.activeElement; $('#userPickerModal').classList.remove('hidden'); trapDialog('#userPickerModal'); }

    /* ========= Init ========= */
    function init(){ storeInit(); bindAll(); showScreen('welcomeScreen'); }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
