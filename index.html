<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Madonchik â€” ×—×™×“×•×Ÿ ×¤×™×–×™×§×”</title>
  <!--
    ===== × ×ª×•× ×™× ×“×™× ××™×™× =====
    JSON ×‘× ×ª×™×‘: /data/physics-questions.json
    ×¤×•×¨××˜ ×¤×¨×™×˜:
    {
      "q": "×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×¨×¢×?",
      "choices": ["×§×•×œ ××”×™×¨ ×™×•×ª×¨","××•×¨ ××”×™×¨ ×™×•×ª×¨","×–×” ×§×•×¨×” ×™×—×“","×ª×œ×•×™ ×‘×¢× × ×™×"],
      "correct": 1,
      "hint": "×”××•×¨ ××”×™×¨ ××”×§×•×œ.",
      "steps": ["×¦×¢×“ 1â€¦", "×¦×¢×“ 2â€¦"],
      "topic": "waves",        // ××•×¤×¦×™×•× ×œ×™: waves | optics | motion | electricity | gravity | pressure | buoyancy | thermo
      "level": "easy"          // ××•×¤×¦×™×•× ×œ×™: easy | medium | hard
      // ××•×¤×¦×™×•× ×œ×™: "img": "/images/physics/waves.svg"  // ××™×•×¨ ××•×ª×× ××™×©×™×ª ×× ×§×™×™×
    }
  -->
  <style>
    :root{
      --ink:#1f2430; --ink-soft:#4b5263; --bg:#f6f7fb; --card:#ffffff;
      --accent:#4f7cff; --accent-2:#00b894; --wrong:#ff6565; --muted:#e6e9f2;
      --ring: #93c5fd; --radius:14px; --shadow:0 6px 24px rgba(0,0,0,.06);
    }
    html.dark{
      --ink:#e6e9f2; --ink-soft:#b6bed1; --bg:#0f1116; --card:#161a24;
      --accent:#7aa2ff; --accent-2:#2bd4a7; --wrong:#ff7b88; --muted:#22283a; --ring:#7aa2ff;
      --shadow:0 6px 24px rgba(0,0,0,.40);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Heebo,Arimo,Arial,sans-serif; line-height:1.6 }

    /* ××‘× ×” ×•×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
    .wrap{ max-width:980px; margin:0 auto; padding: max(16px, env(safe-area-inset-top)) 16px 24px; min-height:100dvh; }

    header.top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; flex-wrap:wrap }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center;
      background:linear-gradient(135deg, var(--accent), #9ab7ff); color:#fff; font-weight:900; box-shadow:var(--shadow) }
    .brand h1{ margin:0; font-weight:900; letter-spacing:.2px; font-size:clamp(20px,2.2vw,26px) }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ border:1px solid var(--muted); background:var(--card); color:var(--ink);
      border-radius:999px; padding:9px 12px; cursor:pointer; font-weight:800; font-size:14px; box-shadow:var(--shadow) }
    .chip:focus-visible{ outline:3px solid var(--ring); outline-offset:2px }
    .chip[aria-pressed="true"]{ box-shadow:0 0 0 3px rgba(147,197,253,.35), var(--shadow) }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }

    .meta{ display:flex; justify-content:space-between; align-items:center; gap:8px; color:var(--ink-soft); font-size:14px; margin-bottom:10px }
    .score{ display:inline-flex; align-items:center; gap:8px; background:rgba(0,0,0,.02);
      border:1px solid var(--muted); padding:6px 10px; border-radius:10px }

    .progress{ height:10px; background:var(--muted); border-radius:999px; overflow:hidden; margin:8px 0 16px }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#6a9bff); transition:width .35s ease }

    .q-wrap{ display:grid; grid-template-columns: 64px 1fr; gap:14px; align-items:center }
    .q-illus{ width:64px; height:64px; border-radius:14px; background:rgba(79,124,255,.08); display:grid; place-items:center; overflow:hidden }
    .q-illus img{ width:100%; height:100%; object-fit:contain }
    .q-illus svg{ width:72%; height:72% }

    .q{ font-size:clamp(18px,2vw,22px); margin:6px 0 4px; font-weight:900 }
    .assist{ font-size:14px; color:var(--ink-soft) }

    .choices{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px }
    @media (min-width:640px){ .choices{ grid-template-columns:1fr 1fr } }

    .btn{ border:1px solid var(--muted); background:var(--card); border-radius:12px; padding:14px 14px; text-align:right;
      cursor:pointer; font-size:16px; transition:transform .02s ease, border-color .2s ease, box-shadow .2s ease; color:var(--ink); min-height:56px }
    @media (hover:hover) and (pointer:fine){ .btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.05) } }
    .btn:active{ transform:scale(.995) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn.correct{ border-color:var(--accent-2); box-shadow:0 0 0 3px rgba(43,212,167,.25) }
    .btn.wrong{ border-color:var(--wrong); box-shadow:0 0 0 3px rgba(255,101,101,.25) }
    .btn:focus-visible{ outline:3px solid var(--ring); outline-offset:2px }

    .hint{ background:rgba(79,124,255,.10); border:1px dashed rgba(79,124,255,.35);
      color:color-mix(in oklab, var(--ink) 90%, var(--ink-soft));
      padding:10px 12px; border-radius:12px; margin:12px 0 0; display:none; font-size:14px; }

    .controls{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap }
    .primary,.ghost{ border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:15px }
    .primary{ background:var(--accent); color:#fff }
    .primary:disabled{ opacity:.6; cursor:not-allowed }
    .ghost{ background:rgba(0,0,0,.06); color:var(--ink) }
    .ghost:focus-visible,.primary:focus-visible{ outline:3px solid var(--ring); outline-offset:2px }

    .summary{ text-align:center; padding:24px 8px; display:none }
    .summary h2{ margin:0 0 8px; font-size:clamp(20px,2.2vw,26px) }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px;
      background:rgba(43,212,167,.12); color:color-mix(in oklab, var(--ink) 90%, var(--ink-soft)); font-weight:900; margin:6px 0 14px }

    .muted-note{ font-size:12px; color:var(--ink-soft) }
    .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; padding:2px 6px; border-radius:8px; background:var(--muted); border:1px solid color-mix(in oklab, var(--ink) 10%, var(--muted)) }

    .foot{ text-align:center; margin-top:16px; color:var(--ink-soft); font-size:13px }
    [dir="rtl"] .choices .btn{ text-align:right }
    .ltr{ direction:ltr; unicode-bidi:embed; display:inline-block }

    /* Toast */
    .toast{ position:fixed; inset-inline:0; bottom:16px; display:grid; place-items:center; pointer-events:none; z-index:50 }
    .toast > div{ pointer-events:auto; background:var(--card); color:var(--ink); border:1px solid var(--muted); border-radius:12px; box-shadow:var(--shadow); padding:10px 14px; font-weight:700 }

    @media (prefers-reduced-motion: reduce){ .bar{ transition:none } }
  </style>
</head>
<body>
  <a href="#main" class="visually-hidden" style="position:absolute;inset-inline-start:8px;top:-40px;background:#000;color:#fff;padding:8px 12px;border-radius:8px;">×“×œ×’×• ×œ×ª×•×›×Ÿ</a>
  <div class="wrap">
    <header class="top" aria-label="×¡×¨×’×œ ×¢×œ×™×•×Ÿ">
      <div class="brand">
        <div class="logo" aria-hidden="true">Md</div>
        <h1 title="Madonchik">Madonchik â€” ×—×™×“×•×Ÿ ×¤×™×–×™×§×”</h1>
      </div>
      <div class="toolbar" role="group" aria-label="×‘×§×¨×•×ª">
        <button id="audioToggle" class="chip" type="button" aria-pressed="false" title="××¦×‘ ×¦×œ×™×œ">ğŸ”Š ×¦×œ×™×œ</button>
        <button id="themeToggle" class="chip" type="button" aria-pressed="false" title="××¦×‘ ×›×”×”/×‘×”×™×¨">ğŸŒ— ××¦×‘ ×›×”×”</button>
        <button id="refreshBankBtn" class="chip" type="button" title="×˜×¢×Ÿ/×¨×¢× ×Ÿ ×××’×¨ ×©××œ×•×ª">â™»ï¸ ×¨×¢× ×•×Ÿ ×××’×¨</button>
      </div>
    </header>

    <main id="main" class="card" tabindex="-1">
      <div class="meta">
        <div class="score" id="scoreBox" aria-live="polite">×ª×•×¦××”: <strong id="score">0</strong> / <span id="total">10</span></div>
        <div id="counter" aria-live="polite">×©××œ×” <b class="ltr">1</b> ××ª×•×š <b class="ltr">10</b></div>
      </div>

      <div class="progress" aria-label="×”×ª×§×“××•×ª ×—×™×“×•×Ÿ">
        <div class="bar" id="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0% ×”×•×©×œ××•"></div>
      </div>

      <div id="quizArea" aria-live="polite">
        <div class="q-wrap">
          <div class="q-illus" id="illus" aria-hidden="true"></div>
          <div>
            <div class="q" id="question">×˜×•×¢×Ÿ ×¡×˜ ×—×“×©â€¦</div>
            <div id="assist" class="assist">×‘×—×¨×• ×ª×©×•×‘×” ××—×ª. × ×™×ª×Ÿ ×œ×¢× ×•×ª ×’× ×¢× ×”××¡×¤×¨×™× ×‘××§×œ×“×ª.</div>
          </div>
        </div>

        <div class="choices" id="choices" aria-label="×‘×—×™×¨×ª ×ª×©×•×‘×”" role="group"></div>
        <div class="hint" id="hintBox" role="note"></div>

        <div class="controls">
          <button class="ghost" id="hintBtn" type="button" disabled aria-describedby="hintBox">×¢×–×¨×”</button>
          <button class="primary" id="nextBtn" type="button" disabled>×œ×©××œ×” ×”×‘××”</button>
          <button class="ghost" id="newSetBtn" type="button" title="×¡×˜ ×—×“×© ××ª×•×š ×”×××’×¨ ×”×˜×¢×•×Ÿ">×¡×˜ ×—×“×©</button>
        </div>
        <div class="muted-note">×˜×™×¤: ××¤×©×¨ ×œ×¢× ×•×ª ×’× ×¢× ×”××§×œ×“×ª (<span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span>/<span class="kbd">4</span>, ×•Ö¾<span class="kbd">N</span> ×œ×©××œ×” ×”×‘××”).</div>
      </div>

      <div id="summary" class="summary">
        <h2 id="summaryTitle">×¡×™×›×•× ×”×—×™×“×•×Ÿ</h2>
        <div class="pill"><span id="finalScore">0</span> / <span id="finalTotal">0</span></div>
        <p id="resultText"></p>
        <div class="controls" style="justify-content:center">
          <button class="primary" id="restartBtn" type="button">×©×—×§×• ×©×•×‘ (×¡×˜ ×—×“×©)</button>
          <button class="ghost" id="nextQuizBtn" type="button" title="×˜×¢×Ÿ ××—×“×© ××”×××’×¨">×¢×•×“ ×—×™×“×•×Ÿ</button>
        </div>
      </div>
    </main>

    <div class="foot">Â© 2025 Madonchik â€” ×—×™×“×•×Ÿ ×¤×™×–×™×§×” ×™×“×™×“×•×ª×™. ×”×©××œ×•×ª × ×˜×¢× ×•×ª ×“×™× ××™×ª; ×™×© × ×¤×™×œ×” ×—×›××” ×× ××™×Ÿ ×¨×©×ª.</div>
  </div>

  <!-- Toast container -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true" style="display:none"><div id="toastMsg">×”×•×“×¢×”</div></div>

  <script>
    /* ===== ×§×‘×•×¢×™× ×•××—×¡×•×Ÿ ===== */
    const BANK_URL = '/data/physics-questions.json';
    const TOTAL_QUESTIONS = 10;

    const LS_BANK = 'madonchik_bank_cache_v1';
    const LS_BANK_TS = 'madonchik_bank_cache_ts_v1';
    const LS_SOUND = 'madonchik_sound_muted';
    const LS_THEME = 'madonchik_theme'; // 'dark' | 'light'

    let bankLoaded = [];  // ×××’×¨ ×”× ×•×›×—×™ ×©××× ×• × ×‘× ×” ×›×œ ×¡×˜
    let quizData = [];    // ×¡×˜ ×©××œ×•×ª ×œ×¡×©×Ÿ
    let idx = 0, score = 0, locked = false, hintStep = -1;

    /* ===== ×¢×–×¨×™ ××§×¨××™×•×ª ===== */
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    function pickRandomQuestions(bank, n){
      const copy=[...bank]; shuffle(copy);
      return copy.slice(0, Math.min(n, copy.length)).map(q=>{
        const mix = q.choices.map((txt,i)=>({txt,i})); shuffle(mix);
        return {
          q: q.q, choices: mix.map(c=>c.txt),
          correct: mix.findIndex(c=>c.i===q.correct),
          hint: q.hint || '', steps: Array.isArray(q.steps)? q.steps.slice() : [],
          topic: q.topic || null, level: q.level || null, img: q.img || null
        };
      });
    }

    /* ===== ×××’×¨ ××§×•××™ (fallback) ===== */
    const localBigBank = [
      { q:"××” ××•×©×š ×—×¤×¦×™× ×œ×§×¨×§×¢?", choices:["×—×™×›×•×š","×’×¨×‘×™×˜×¦×™×”","××’× ×˜×™×•×ª","×¨×•×—"], correct:1, hint:"×”×›×•×— ×©××•×©×š ×”×›×•×œ ×œ××˜×”", topic:'gravity' },
      { q:"××™×–×• ×× ×¨×’×™×” ×™×© ×œ×ª× ×•×¢×”?", choices:["×§×™× ×˜×™×ª","×—×©××œ×™×ª","×ª×¨××™×ª","××œ×¡×˜×™×ª"], correct:0, hint:"×§×™× ×˜×™×ª = ×ª× ×•×¢×”", topic:'motion' },
      { q:"×œ××” ×¨×•××™× ×‘×¨×§ ×œ×¤× ×™ ×©×©×•××¢×™× ×¨×¢×?", choices:["×”×§×•×œ ××”×™×¨ ×™×•×ª×¨","×”××•×¨ ××”×™×¨ ×™×•×ª×¨","×–×” ×§×•×¨×” ×™×—×“","×ª×œ×•×™ ×‘×¢× × ×™×"], correct:1, hint:"×”××•×¨ ××”×™×¨ ××”×§×•×œ", steps:["×”××•×¨ × ×¢ ××”×¨ ×™×•×ª×¨ ××”×§×•×œ.","×‘×¨×§ ×–×” ××•×¨, ×¨×¢× ×–×” ×§×•×œ.","×œ×›×Ÿ ×¨×•××™× ×§×•×“× ××ª ×”×‘×¨×§."], topic:'waves' },
      { q:"××“×•×¢ ×¡×¤×™× ×” ×¦×¤×”?", choices:["××©×§×œ ×§×˜×Ÿ","×¦×¤×™×¤×•×ª × ××•×›×” ×××™×","×× ×•×¢ ×—×–×§","××’× ×˜×™×"], correct:1, hint:"×¦×¤×™×¤×•×ª ×§×•×‘×¢×ª ×¦×™×¤×”", topic:'buoyancy' },
      { q:"××™×–×• ×× ×¨×’×™×” × ××’×¨×ª ×‘×§×¤×™×¥ ×“×—×•×¡?", choices:["×§×™× ×˜×™×ª","×¤×•×˜× ×¦×™××œ×™×ª ××œ×¡×˜×™×ª","×ª×¨××™×ª","×—×©××œ×™×ª"], correct:1, hint:"××©×ª×—×¨×¨×ª ×‘×¢×‘×•×“×”", topic:'motion' },
      { q:"××” ××•×“×“ ××“×—×•×?", choices:["×˜××¤×¨×˜×•×¨×”","××¡×”","×œ×—×¥","××”×™×¨×•×ª"], correct:0, hint:"×›××” ×—× ××• ×§×¨", topic:'thermo' },
      { q:"××™×–×” ×›×•×— ×’×•×¨× ×œ××¡×œ×•×œ ××¢×’×œ×™?", choices:["×¦×™×¤×”","×¦× ×˜×¨×™×¤×˜×œ×™","×—×™×›×•×š","××œ×¡×˜×™"], correct:1, hint:"×¤×•× ×” ××œ ×”××¨×›×–", topic:'motion' },
      { q:"×‘××¢×’×œ ×—×©××œ×™ ×¡×’×•×¨ ×¢× ×¡×•×œ×œ×” ×•× ×•×¨×”:", choices:["×©×•× ×“×‘×¨","×”× ×•×¨×” ×ª×“×œ×§","×”×¡×•×œ×œ×” × ×¢×œ××ª","×™×”×™×” ×¦×œ×™×œ"], correct:1, hint:"×–×¨× × ×¢ ×‘××¢×’×œ ×¡×’×•×¨", topic:'electricity' },
      { q:"××™×–×” ×¦×‘×¢ × ×©×‘×¨ ×”×›×™ ×”×¨×‘×” ×‘××™×?", choices:["××“×•×","×™×¨×•×§","×›×—×•×œ","×¡×’×•×œ"], correct:3, hint:"×§×¦×” ×¡×’×œ×’×œ ×©×œ ×”×§×©×ª", topic:'optics' },
      { q:"××” ××§×•×¨ ×”×× ×¨×’×™×” ×œ×¨×•×—?", choices:["×”×©××© ××—×××ª ×œ× ××—×™×“","×”×™×¨×—","××’× ×˜×™×","×¨×¢×©"], correct:0, hint:"×”×‘×“×œ×™ ×˜××¤×³ ×•×œ×—×¥", topic:'thermo' }
    ];

    /* ===== DOM ===== */
    const el = {
      bar: document.getElementById('bar'),
      score: document.getElementById('score'),
      total: document.getElementById('total'),
      counter: document.getElementById('counter'),
      question: document.getElementById('question'),
      illus: document.getElementById('illus'),
      assist: document.getElementById('assist'),
      choices: document.getElementById('choices'),
      hintBox: document.getElementById('hintBox'),
      hintBtn: document.getElementById('hintBtn'),
      nextBtn: document.getElementById('nextBtn'),
      quizArea: document.getElementById('quizArea'),
      summary: document.getElementById('summary'),
      finalScore: document.getElementById('finalScore'),
      finalTotal: document.getElementById('finalTotal'),
      resultText: document.getElementById('resultText'),
      restartBtn: document.getElementById('restartBtn'),
      nextQuizBtn: document.getElementById('nextQuizBtn'),
      newSetBtn: document.getElementById('newSetBtn'),
      refreshBankBtn: document.getElementById('refreshBankBtn'),
      audioToggle: document.getElementById('audioToggle'),
      themeToggle: document.getElementById('themeToggle'),
      toast: document.getElementById('toast'),
      toastMsg: document.getElementById('toastMsg'),
      summaryTitle: document.getElementById('summaryTitle')
    };
    el.total.textContent = TOTAL_QUESTIONS;

    /* ===== ×¡××•× ×“ (WebAudio) ×¢× ×˜×•×’×œ) ===== */
    let isMuted = false, audioCtx = null, audioUnlocked = false;
    function getAudioCtx(){
      if(isMuted) return null;
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return null;
      if(!audioCtx) audioCtx = new AC();
      if(audioCtx.state !== 'running' && audioCtx.resume){ try{ audioCtx.resume(); }catch{} }
      return audioCtx;
    }
    function unlockAudioOnce(){
      if(audioUnlocked || isMuted) return;
      const ctx = getAudioCtx(); if(!ctx) return;
      try{
        const buffer = ctx.createBuffer(1,1,ctx.sampleRate);
        const src = ctx.createBufferSource(); const g=ctx.createGain();
        g.gain.value = 0.0001; src.buffer = buffer; src.connect(g); g.connect(ctx.destination); src.start(0);
        setTimeout(()=>{ try{ src.disconnect(); g.disconnect(); }catch{} audioUnlocked=true; },0);
      }catch{}
    }
    function tone(freq, dur, t, type='sine', gain=0.22){
      if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return;
      const start = typeof t==='number'?t:ctx.currentTime;
      const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start);
      g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur);
      o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{}
    }
    function playTick(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520, .08, t, 'triangle', .18); }
    function playSuccess(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,.10,t,'sine',.18); tone(659.25,.10,t+.09,'sine',.16); tone(783.99,.12,t+.18,'sine',.14); }
    function playError(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,.10,t,'square',.18); tone(180,.10,t+.09,'square',.16); }

    try{ isMuted = localStorage.getItem(LS_SOUND) === 'true'; }catch{ isMuted=false }
    el.audioToggle.setAttribute('aria-pressed', isMuted?'true':'false');
    el.audioToggle.textContent = (isMuted ? 'ğŸ”‡' : 'ğŸ”Š') + ' ' + '×¦×œ×™×œ';
    el.audioToggle.addEventListener('click', ()=>{
      isMuted = !isMuted;
      el.audioToggle.setAttribute('aria-pressed', isMuted?'true':'false');
      el.audioToggle.textContent = (isMuted ? 'ğŸ”‡' : 'ğŸ”Š') + ' ' + '×¦×œ×™×œ';
      try{ localStorage.setItem(LS_SOUND, String(isMuted)); }catch{}
      if(!isMuted) unlockAudioOnce();
      playTick();
    });
    ['pointerdown','touchstart','click','keydown'].forEach(ev=> window.addEventListener(ev, unlockAudioOnce, { once:true, passive:true }));

    /* ===== Theme ===== */
    (function initTheme(){
      let stored=null; try{ stored = localStorage.getItem(LS_THEME); }catch{}
      const wantsDark = stored ? stored==='dark' : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.classList.toggle('dark', wantsDark);
      el.themeToggle.setAttribute('aria-pressed', wantsDark ? 'true' : 'false');
      el.themeToggle.textContent = (wantsDark ? 'ğŸŒ' : 'ğŸŒ—') + ' ××¦×‘ ' + (wantsDark ? '×‘×”×™×¨' : '×›×”×”');
    })();
    el.themeToggle.addEventListener('click', ()=>{
      const nowDark = !document.documentElement.classList.contains('dark');
      document.documentElement.classList.toggle('dark', nowDark);
      el.themeToggle.setAttribute('aria-pressed', nowDark ? 'true':'false');
      el.themeToggle.textContent = (nowDark ? 'ğŸŒ' : 'ğŸŒ—') + ' ××¦×‘ ' + (nowDark ? '×‘×”×™×¨' : '×›×”×”');
      try{ localStorage.setItem(LS_THEME, nowDark?'dark':'light'); }catch{}
      playTick();
    });

    /* ===== ×˜×¢×™× ×ª ×××’×¨ ===== */
    async function fetchBankNoStore(){
      const res = await fetch(BANK_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('Bad status');
      const json = await res.json();
      if(!Array.isArray(json) || !json.length) throw new Error('Empty JSON');
      return json;
    }
    async function loadQuestionBank({forceNetwork=false} = {}){
      if(forceNetwork){
        try{
          const bank = await fetchBankNoStore();
          try{ localStorage.setItem(LS_BANK, JSON.stringify(bank)); localStorage.setItem(LS_BANK_TS, String(Date.now())); }catch{}
          toast('×××’×¨ ×¨×•×¢× ×Ÿ ××”×©×¨×ª');
          return bank;
        }catch{ /* ×××©×™×›×™× ×œ× ×™×¡×™×•×Ÿ ×§××©/××§×•××™ */ }
      }
      try{
        const cached = JSON.parse(localStorage.getItem(LS_BANK) || '[]');
        if(cached && cached.length){ toast('× ×˜×¢×Ÿ ×××’×¨ ××”×™×¨ ××”×“×¤×“×¤×Ÿ'); return cached; }
      }catch{}
      try{
        const bank = await fetchBankNoStore();
        try{ localStorage.setItem(LS_BANK, JSON.stringify(bank)); localStorage.setItem(LS_BANK_TS, String(Date.now())); }catch{}
        toast('×××’×¨ × ×˜×¢×Ÿ ××”×©×¨×ª');
        return bank;
      }catch{
        toast('××™×Ÿ ×¨×©×ª â€” × ×˜×¢×Ÿ ×××’×¨ ××§×•××™');
        return localBigBank;
      }
    }

    async function refreshBank(){
      el.refreshBankBtn.disabled = true; el.refreshBankBtn.textContent = 'â³ ××¨×¢× ×Ÿâ€¦';
      try{ bankLoaded = await loadQuestionBank({forceNetwork:true}); playSuccess(); }
      catch{ playError(); }
      finally{ el.refreshBankBtn.disabled = false; el.refreshBankBtn.textContent = 'â™»ï¸ ×¨×¢× ×•×Ÿ ×××’×¨'; }
    }

    /* ===== ××™×•×¨×™× ×§×œ×™× ×œ×¤×™ topic ××• ×ª××•× ×” ×—×™×¦×•× ×™×ª ===== */
    function svgIcon(topic){
      const map={
        waves:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 12c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/><path d="M2 16c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2"/></svg>`,
        optics:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="7" cy="12" r="3"/><path d="M2 12h3m5-4 12 8M10 16l12-8"/></svg>`,
        motion:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12h9"/><path d="M13 12l-3-3m3 3-3 3"/><circle cx="18" cy="12" r="2"/></svg>`,
        electricity:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2 3 14h7l-1 8 11-12h-7l0-8z"/></svg>`,
        gravity:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="7" r="3"/><path d="M12 10v7m-4 0h8"/></svg>`,
        pressure:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="7"/><path d="M12 12l4-2"/></svg>`,
        buoyancy:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 15c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2"/><rect x="9" y="5" width="6" height="5" rx="1"/></svg>`,
        thermo:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M10 2v9a4 4 0 1 0 4 0V2z"/><circle cx="12" cy="17" r="3"/></svg>`
      };
      return map[topic] || `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/></svg>`;
    }
    function renderIllustration(item){
      el.illus.innerHTML = '';
      if(item?.img){
        const img = document.createElement('img'); img.alt='××™×•×¨ ×ª×•××š'; img.src=item.img; el.illus.appendChild(img); return;
      }
      if(item?.topic){ el.illus.innerHTML = svgIcon(item.topic); }
    }

    /* ===== Toast ===== */
    let toastTimer=null;
    function toast(msg){
      el.toastMsg.textContent = msg;
      el.toast.style.display = 'grid';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.toast.style.display='none'; }, 2000);
    }

    /* ===== ××©×—×§ ===== */
    function render(){
      locked = false;
      const item = quizData[idx];
      el.question.textContent = item?.q || 'â€”';
      el.assist.textContent = '×‘×—×¨×• ×ª×©×•×‘×” ××—×ª. × ×™×ª×Ÿ ×œ×¢× ×•×ª ×’× ×¢× ×”××¡×¤×¨×™× ×‘××§×œ×“×ª.';
      renderIllustration(item);

      el.choices.innerHTML = '';
      el.hintBox.style.display = 'none'; el.hintBox.textContent = '';
      hintStep = -1;

      const hasAssist = (item?.steps && item.steps.length) || item?.hint;
      el.hintBtn.disabled = !hasAssist;
      el.hintBtn.textContent = (item?.steps && item.steps.length) ? '×”×¦×¢×“ ×”×‘×' : '×¨××–';
      el.nextBtn.disabled = true;

      el.counter.innerHTML = `×©××œ×” <b class="ltr">${idx+1}</b> ××ª×•×š <b class="ltr">${quizData.length}</b>`;
      const progress = Math.round((idx / quizData.length) * 100);
      el.bar.style.width = progress + '%';
      el.bar.setAttribute('aria-valuenow', String(progress));
      el.bar.setAttribute('aria-valuetext', `${progress}% ×”×•×©×œ××•`);

      (item?.choices || []).forEach((txt, i) => {
        const b = document.createElement('button');
        b.className = 'btn'; b.type = 'button'; b.textContent = txt;
        b.addEventListener('click', () => selectAnswer(i, b));
        b.addEventListener('keydown', (e)=>{ if((e.key==='Enter'||e.key===' ')&&!b.disabled){ e.preventDefault(); b.click(); }});
        el.choices.appendChild(b);
      });

      // ×¤×•×§×•×¡ ×œ×›×•×ª×¨×ª ×”×©××œ×” ×œ× ×’×™×©×•×ª
      requestAnimationFrame(()=>{ try{ document.getElementById('main').focus({preventScroll:true}); }catch{} });
    }

    function selectAnswer(choiceIndex, btn){
      if(locked) return; locked = true; playTick();
      const item = quizData[idx]; const correct = item.correct;

      [...el.choices.children].forEach((b, i) => { b.disabled = true; if(i === correct) b.classList.add('correct'); });

      if(choiceIndex === correct){ score++; el.score.textContent = String(score); playSuccess(); }
      else{ btn.classList.add('wrong'); playError(); onWrongAnswer(item); }

      el.nextBtn.disabled = false;
      el.assist.textContent = '××¦×•×™×Ÿ. ××¤×©×¨ ×œ×”×ª×§×“× ×œ×©××œ×” ×”×‘××”.';
    }

    function onWrongAnswer(item){
      if(item.steps && item.steps.length){
        hintStep = 0; el.hintBox.textContent = item.steps[0]; el.hintBox.style.display = 'block';
        el.hintBtn.textContent = (item.steps.length > 1) ? '×”×¦×¢×“ ×”×‘×' : '×¡×™×•× ×¦×¢×“×™×';
        el.hintBtn.disabled = (item.steps.length <= 1);
      }else if(item.hint){
        el.hintBox.textContent = item.hint; el.hintBox.style.display = 'block'; el.hintBtn.disabled = true;
      }
    }

    el.hintBtn.addEventListener('click', ()=>{
      const item = quizData[idx]; if(!item) return; playTick();
      if(item.steps && item.steps.length){
        hintStep++; const stepText = item.steps[Math.min(hintStep, item.steps.length-1)];
        el.hintBox.textContent = stepText; el.hintBox.style.display = 'block';
        const moreLeft = hintStep < item.steps.length - 1;
        el.hintBtn.textContent = moreLeft ? '×”×¦×¢×“ ×”×‘×' : '×¡×™×•× ×¦×¢×“×™×';
        if(!moreLeft) el.hintBtn.disabled = true;
      }else if(item.hint){ el.hintBox.textContent = item.hint; el.hintBox.style.display = 'block'; el.hintBtn.disabled = true; }
    });

    el.nextBtn.addEventListener('click', ()=>{ if(idx < quizData.length - 1){ idx++; render(); } else { finish(); } playTick(); });
    el.newSetBtn.addEventListener('click', ()=>{ buildSessionFromLoadedBank(); playTick(); });
    el.nextQuizBtn.addEventListener('click', async ()=>{ await refreshBank(); await newSession(); });
    el.restartBtn.addEventListener('click', ()=>{ newSession(); playTick(); });

    // ×§×™×¦×•×¨×™ ××§×œ×“×ª: 1/2/3/4 ×‘×—×™×¨×”; N ×œ×©××œ×” ×”×‘××”; H ×œ×¨××–
    document.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if(['1','2','3','4'].includes(k) && el.choices.children.length){ const i = parseInt(k,10)-1; const b = el.choices.children[i]; if(b) b.click(); }
      else if(k==='n' && !el.nextBtn.disabled){ el.nextBtn.click(); }
      else if(k==='h' && !el.hintBtn.disabled){ el.hintBtn.click(); }
    });

    function finish(){
      el.bar.style.width = '100%'; el.bar.setAttribute('aria-valuenow','100'); el.bar.setAttribute('aria-valuetext','100% ×”×•×©×œ××•');
      el.quizArea.style.display = 'none'; el.summary.style.display = 'block';
      el.finalScore.textContent = String(score); el.finalTotal.textContent = String(quizData.length);

      const pct = Math.round((score/quizData.length)*100);
      let title = '×¡×™×›×•× ×”×—×™×“×•×Ÿ'; let msg = '×™×¤×” ×××•×“! ×”××©×™×›×• ×œ×©××•×œ, ×œ×‘×“×•×§ ×•×œ×’×œ×•×ª.';
      if(pct === 100){ title='××•×©×œ×!'; msg='××œ×•×¤×™×! ×ª×¤×“×œ×• ×œ×¢×•×“ ××ª×’×¨ ×§×˜×Ÿ â­'; confetti(); }
      else if(pct >= 80){ title='××¢×•×œ×”!'; msg='×›××¢×˜ ××•×©×œ× â€” ×¡×™×‘×•×‘ × ×•×¡×£ ×•×™×© ×©×™× ×—×“×©.'; }
      else if(pct >= 50){ title='×™×© ×”×ª×§×“××•×ª!'; msg='×¢×•×“ ×ª×¨×’×•×œ ×§×¦×¨ ×•×ª×¨××• ×§×¤×™×¦×” ×—×“×” ×‘×‘×™×˜×—×•×Ÿ.'; }
      else { title='×›×œ ×”×ª×—×œ×” ×”×™× ×¦×¢×“ ×¨××©×•×Ÿ'; msg='×œ× × ×•×¨×. ×—×•×–×¨×™× ×œ×¡×™×‘×•×‘ × ×•×¡×£ ×•××©×ª×¤×¨×™× ××”×¨.'; }
      el.summaryTitle.textContent = title; el.resultText.textContent = msg;
    }

    function buildSessionFromLoadedBank(){
      const n = Math.min(TOTAL_QUESTIONS, bankLoaded.length || TOTAL_QUESTIONS);
      quizData = pickRandomQuestions(bankLoaded.length? bankLoaded : localBigBank, n);
      idx = 0; score = 0; locked = false;
      el.score.textContent = '0'; el.total.textContent = String(quizData.length);
      el.quizArea.style.display = 'block'; el.summary.style.display = 'none';
      render();
    }

    async function newSession(){ if(!bankLoaded.length){ bankLoaded = await loadQuestionBank(); } buildSessionFromLoadedBank(); }

    /* ===== Confetti ×¢×“×™×Ÿ ===== */
    function confetti(){
      try{ if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; }catch{}
      const root = document.body; const n = 28;
      for(let i=0;i<n;i++){
        const dot=document.createElement('span'); dot.style.position='fixed'; dot.style.width='8px'; dot.style.height='8px'; dot.style.borderRadius='50%';
        dot.style.left='50%'; dot.style.top='20%';
        const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7']; dot.style.background=colors[i%colors.length]; dot.style.zIndex=60;
        const angle=(i/n)*Math.PI*2, dist=80+Math.random()*60, tx=Math.cos(angle)*dist, ty=Math.sin(angle)*dist;
        const anim=dot.animate([
          { transform:'translate(-50%,-50%) scale(1)', opacity:1 },
          { transform:`translate(${tx-50}%,${ty-50}%) scale(.9)`, opacity:0 }
        ], { duration: 900, easing:'cubic-bezier(.2,.8,.2,1)' });
        anim.onfinish=()=>dot.remove(); root.appendChild(dot);
      }
    }

    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª + ××™×¨×•×¢ ×¨×¢× ×•×Ÿ ×××’×¨
    (async function init(){ await newSession(); })();
    el.refreshBankBtn.addEventListener('click', async ()=>{ await refreshBank(); await newSession(); });
  </script>
</body>
</html>
