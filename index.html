<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מדעונצ'יק — משחק מדע</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap');
    :root{
      --radius:1.25rem
    }
    body{font-family:'Assistant',system-ui,-apple-system,Segoe UI,Roboto,Heebo,Arimo,sans-serif}
    .ltr{direction:ltr; unicode-bidi:embed; display:inline-block}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .owl-blink{animation:blink 2.2s infinite}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(.1)}}
    .no-outline:focus{outline:none !important; box-shadow:none !important}
    /* תשובה */
    .answer-item{position:relative; transition:transform .12s, box-shadow .12s, border-color .12s; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent; background:#fff; border-radius:var(--radius); border:2px solid transparent; outline:none}
    .answer-item:active{transform:scale(.985)}
    .answer-item.selected{border-color:#2563eb; box-shadow:0 10px 26px rgba(0,0,0,.12)}
    /* כרטיס בחירה */
    .choice-card{position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.25rem; background:#fff; border:2px solid #e5e7eb; border-radius:var(--radius); padding:1rem; box-shadow:0 8px 20px rgba(0,0,0,.08); transition:.16s; cursor:pointer}
    .choice-card:hover{transform:translateY(-2px)}
    .choice-card.selected{border-color:#2563eb; box-shadow:0 12px 30px rgba(0,0,0,.14)}
    /* צ'יפים */
    .chip{min-width:64px; min-height:48px; display:inline-flex; align-items:center; justify-content:center; border:2px solid #e5e7eb; background:#fff; border-radius:999px; padding:.35rem .8rem; font-weight:700; font-size:1rem; cursor:pointer; transition:.16s}
    .chip:hover{transform:translateY(-2px)}
    .chip.selected{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.20)}
    /* ציפה */
    #floatingControls{position:fixed; left:16px; top:16px; z-index:50; display:flex; flex-direction:column; gap:10px}
    #audioToggle,#profileBtn{width:44px;height:44px;display:grid;place-items:center;border-radius:9999px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    #audioToggle[aria-pressed="true"] .muted{display:inline} #audioToggle[aria-pressed="true"] .unmuted{display:none}
    #audioToggle[aria-pressed="false"] .muted{display:none} #audioToggle[aria-pressed="false"] .unmuted{display:inline}
    /* חתימה */
    .site-signature{ text-align:center;color:#6b7280;font-size:.95rem;line-height:1.6; margin:1.25rem 0 }
    .site-signature a{color:#4b5563;text-decoration:underline}
    .site-signature a:hover{color:#111827}
    /* טקסט */
    .h1{font-weight:800; font-size:clamp(1.6rem,1.2rem + 1.8vw,2.2rem); line-height:1.15}
    .h2{font-weight:800; font-size:clamp(1.4rem,1.1rem + 1.4vw,2rem); line-height:1.2}
    .lead{font-weight:400; font-size:clamp(1.1rem,1rem + .6vw,1.35rem); line-height:1.5; color:#374151}
    .body{font-weight:400; font-size:clamp(1rem,.95rem + .3vw,1.1rem); line-height:1.7}
    .btn-strong{font-weight:700}
    @media (prefers-reduced-motion: reduce){ .owl-blink{animation:none} }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-green-100 min-h-screen">

  <!-- כפתורי ציפה -->
  <div id="floatingControls" aria-label="בקרות מהירות">
    <button id="audioToggle" type="button" aria-label="החלפת מצב צליל" aria-pressed="false" title="הצליל פעיל">
      <span class="unmuted" aria-hidden="true">🔊</span><span class="muted" aria-hidden="true">🔇</span>
    </button>
    <button id="profileBtn" type="button" aria-label="אזור אישי" title="אזור אישי">👤</button>
  </div>

  <!-- פתיחה -->
  <div id="welcomeScreen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-6xl mb-3 owl-blink">🦉</div>
      <div class="h1 text-purple-600 mb-2">מדעונצ'יק</div>
      <p class="lead mb-8">בואו לגלות מדע עם שופי הינשוף</p>
      <button type="button" id="startBtn" class="btn-strong bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-full text-lg hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg">התחל משחק</button>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- שם -->
  <div id="nameScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <form id="nameForm" class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-5xl mb-3">👋</div>
      <div class="h2 text-blue-600 mb-2">איך קוראים לך?</div>
      <input type="text" id="playerName" required placeholder="כתבו את השם כאן" class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl mb-3 text-center focus:border-blue-500 focus:outline-none">
      <div class="text-center mb-6">
        <button type="button" id="profileOrSwitchBtn" class="underline btn-strong">החלפת משתמש או אזור אישי</button>
      </div>
      <button type="submit" class="btn-strong bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-4 rounded-full text-lg hover:from-blue-600 hover:to-green-600 transform hover:scale-105 transition-all duration-200 shadow-lg">המשך</button>
    </form>
  </div>

  <!-- בורר משתמשים -->
  <div id="userPickerModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl max-w-md w-full p-6">
      <div class="h2 text-gray-800 mb-3">בחרו משתמש</div>
      <div id="userList" class="space-y-2 max-h-[50vh] overflow-auto mb-4"></div>
      <div class="flex gap-2 justify-between">
        <button id="userPickerCancel" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 btn-strong">סגור</button>
        <button id="newUserBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white btn-strong hover:bg-blue-700">משתמש חדש</button>
      </div>
    </div>
  </div>

  <!-- בחירת תחומים -->
  <div id="topicsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-3xl w-full">
      <div class="text-5xl mb-3">📚</div>
      <div class="h2 text-green-600 mb-2">בוחרים תחומי מדע</div>
      <p class="body mb-6 btn-strong">בחרו תחום אחד או יותר ואז לחצו על המשך</p>
      <div id="topicsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="topicsSelectAll" type="button" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 btn-strong">בחר הכל</button>
        <button id="topicsNext" class="btn-strong bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-lg shadow-lg" disabled aria-disabled="true">המשך</button>
      </div>
    </div>
  </div>

  <!-- רמה וכמות -->
  <div id="difficultyScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-5xl mb-3">⚡</div>
      <div class="h2 text-blue-600 mb-6">איזו רמה וכמה שאלות?</div>
      <div class="flex flex-col gap-3 mb-6">
        <button type="button" data-diff="easy"   class="choice-card diff-btn" aria-pressed="false"><div class="text-2xl">🌱</div><div class="btn-strong">קל</div><div class="text-sm text-gray-500">כיתות א–ב</div></button>
        <button type="button" data-diff="medium" class="choice-card diff-btn" aria-pressed="false"><div class="text-2xl">🔥</div><div class="btn-strong">בינוני</div><div class="text-sm text-gray-500">כיתות ג–ה</div></button>
        <button type="button" data-diff="hard"   class="choice-card diff-btn" aria-pressed="false"><div class="text-2xl">🚀</div><div class="btn-strong">מתקדם</div><div class="text-sm text-gray-500">כיתות ו–ז</div></button>
      </div>
      <div>
        <div class="btn-strong mb-3">מספר שאלות בסט</div>
        <div id="countChips" class="flex flex-wrap items-center justify-center gap-2">
          <button type="button" class="chip" data-count="8" aria-pressed="false">8</button>
          <button type="button" class="chip" data-count="10" aria-pressed="false">10</button>
          <button type="button" class="chip" data-count="12" aria-pressed="false">12</button>
        </div>
      </div>
      <div class="mt-6">
        <button id="difficultyNext" class="btn-strong bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full text-lg shadow-lg" disabled aria-disabled="true">להתחיל</button>
      </div>
    </div>
  </div>

  <!-- משחק -->
  <div id="gameScreen" class="hidden min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-3">
        <div class="text-xl btn-strong text-purple-600">שאלה <span id="currentQuestion" class="ltr">1</span> מתוך <span id="totalQuestions" class="ltr">8</span></div>
        <div class="text-base text-gray-600">שלום <span id="gamePlayerName" class="btn-strong"></span>!</div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3" aria-hidden="true">
        <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" style="width:0%"></div>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 mx-auto max-w-xl text-center">
      <div class="text-5xl mb-3">🦉</div>
      <div id="questionText" tabindex="-1" class="no-outline h2 text-gray-900 mb-4">טוען...</div>
      <div class="body text-gray-700 mb-2">בחרו את התשובה הנכונה</div>
    </div>

    <div id="answersGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-xl mx-auto px-2 mb-6"></div>

    <div class="text-center space-y-3 pb-8">
      <button id="confirmButton" class="btn-strong bg-gradient-to-r from-green-500 to-blue-500 text-white px-7 py-3 rounded-full text-lg transition-all duration-200 shadow-lg" disabled aria-disabled="true">אשר תשובה</button>
      <button type="button" id="restartBtn" class="btn-strong bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-base hover:scale-[1.02] transition-all duration-200 shadow-lg">התחל מחדש</button>
    </div>

    <!-- מודאל משוב+רמז (נשאר עד שממשיכים) -->
    <div id="answerModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div role="dialog" aria-modal="true" class="bg-white rounded-3xl p-7 text-center max-w-md w-full">
        <div id="answerIcon" class="text-7xl mb-3">🎉</div>
        <div id="answerTitle" class="h2 mb-2">כל הכבוד!</div>
        <div id="answerHint" class="body text-gray-700 mb-5 hidden"></div>
        <button id="answerNext" class="btn-strong bg-gradient-to-r from-green-500 to-blue-500 text-white px-7 py-3 rounded-full text-lg shadow-lg">הבא</button>
      </div>
    </div>
  </div>

  <!-- תוצאות -->
  <div id="resultsScreen" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-center bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
      <div class="text-7xl mb-3">🏆</div>
      <div id="resultsTitle" class="h2 text-green-600 mb-4">כל הכבוד!</div>
      <div class="mb-5">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm text-gray-600">הביצועים שלך</span>
          <span id="performancePercentage" class="btn-strong text-blue-600 ltr">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
          <div id="performanceBar" class="h-5 rounded-full flex">
            <div id="correctBar" class="bg-gradient-to-r from-green-400 to-green-500" style="width:0%"></div>
            <div id="incorrectBar" class="bg-gradient-to-r from-orange-400 to-orange-500" style="width:0%"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <span class="text-green-700">✓ נכונות: <span id="correctCount" class="ltr btn-strong">0</span></span>
          <span class="text-orange-700">✗ שגויות: <span id="incorrectCount" class="ltr btn-strong">0</span></span>
        </div>
      </div>
      <div class="body text-gray-700 mb-5">
        <div class="mb-2">תשובות נכונות: <span id="correctAnswers" class="btn-strong text-green-700 ltr">0</span>/<span id="resultsTotal" class="ltr">8</span></div>
        <div>זמן ממוצע לשאלה: <span id="averageTime" class="btn-strong text-blue-700 ltr">0</span> שניות</div>
      </div>
      <div class="flex flex-col gap-3">
        <button id="retryBtn" class="btn-strong bg-gradient-to-r from-green-500 to-blue-500 text-white px-7 py-3 rounded-full text-lg shadow-lg">עוד סיבוב</button>
        <button id="mistakesButton" class="btn-strong bg-gradient-to-r from-orange-500 to-red-500 text-white px-7 py-3 rounded-full text-lg shadow-lg">ללמוד מהטעויות</button>
        <button id="altBtn" class="btn-strong bg-gradient-to-r from-purple-500 to-pink-500 text-white px-7 py-3 rounded-full text-lg shadow-lg">בחירת נושאים אחרת</button>
        <button id="profileFromResultsBtn" class="btn-strong bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-7 py-3 rounded-full text-lg shadow-lg">אזור אישי</button>
      </div>
    </div>
    <footer class="site-signature px-4">
      <div>© 2025 yaroni studio - תוכן חזק, עובד חכם ומבוסס על בינה</div>
      <a href="mailto:hello@yaronistudio.com" dir="ltr" class="ltr">hello@yaronistudio.com</a>
    </footer>
  </div>

  <!-- טעויות -->
  <div id="mistakesScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="text-center mb-6">
        <div class="text-6xl mb-3">📚</div>
        <div class="h2 text-orange-600 mb-2">לומדים מהטעויות</div>
        <p class="body text-gray-600">לוחצים על שאלה כדי לקרוא את ההסבר הקצר</p>
      </div>
      <div id="mistakesList" class="space-y-5 mb-6"></div>
      <div class="text-center space-y-3">
        <button id="backToResults" class="btn-strong bg-gradient-to-r from-blue-500 to-purple-500 text-white px-7 py-3 rounded-full text-lg shadow-lg">חזרה לתוצאות</button>
        <button type="button" id="restartFromMistakes" class="btn-strong bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full text-base shadow-lg">התחל מחדש</button>
      </div>
    </div>
  </div>

  <!-- אזור אישי -->
  <div id="profileScreen" class="hidden min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-5 flex-wrap gap-3">
        <div class="h2 text-indigo-600">האזור האישי</div>
        <div class="flex gap-2">
          <button id="profileStartBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white btn-strong hover:bg-green-700">התחל משחק</button>
          <button id="profileSwitchBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white btn-strong hover:bg-blue-700">החלפת משתמש</button>
          <button id="profileNewBtn" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 btn-strong">משתמש חדש</button>
        </div>
      </div>
      <div id="profileHeader" class="body text-gray-700 mb-5"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-7">
        <div class="p-4 rounded-2xl border-2 border-green-200 bg-green-50">
          <div class="text-sm text-green-700">סטים שבוצעו</div><div id="kpiSets" class="text-2xl btn-strong text-gray-900 ltr">0</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-blue-200 bg-blue-50">
          <div class="text-sm text-blue-700">דיוק מצטבר</div><div id="kpiAccuracy" class="text-2xl btn-strong text-gray-900 ltr">0%</div>
        </div>
        <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50">
          <div class="text-sm text-purple-700">זמן ממוצע לשאלה</div><div id="kpiAvg" class="text-2xl btn-strong text-gray-900 ltr">0s</div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-7" id="byTopicGrid"></div>
      <div>
        <div class="text-xl btn-strong text-gray-800 mb-2">היסטוריית סטים</div>
        <div id="historyList" class="space-y-2"></div>
      </div>
    </div>
  </div>

<script>
/* ========= מצב כללי ========= */
let currentDiff='easy', currentCount=8, selectedTopics=new Set(), questions=[], idx=0, correctCount=0, totalTime=0, startTime=0;
let selectedAnswer=null, playerName='', mistakes=[], lastFocusEl=null;
const SCREENS=['welcomeScreen','nameScreen','userPickerModal','topicsScreen','difficultyScreen','gameScreen','resultsScreen','mistakesScreen','profileScreen'];

/* ========= Store ========= */
const STORE_KEY='mdn_profiles_v1'; let store=null, memOnly=false;
function uuid(){return 'xxxxxxxyxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}
function storeInit(){try{store=JSON.parse(localStorage.getItem(STORE_KEY)||'null');}catch{store=null;memOnly=true;}
  if(!store){store={version:1,installedAt:Date.now(),activeId:null,profiles:{},recentQ:[]}; try{localStorage.setItem(STORE_KEY,JSON.stringify(store));}catch{memOnly=true;}}
}
function saveStore(){ if(memOnly) return; try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch{ memOnly=true; } }
function profilesArr(){ return Object.entries(store.profiles).map(([id,p])=>({id,...p})); }
function getActiveProfile(){ return store.activeId ? store.profiles[store.activeId]||null : null; }
function setActiveProfile(id){ if(!store.profiles[id]) return; store.activeId=id; store.profiles[id].lastSeen=Date.now(); saveStore(); }
function ensureProfileByName(name){
  const norm=(name||'').trim(); if(!norm) return null;
  const existing=profilesArr().find(p=>p.name.trim()===norm);
  if(existing){ setActiveProfile(existing.id); return existing; }
  const id=uuid();
  store.profiles[id]={ name:norm, createdAt:Date.now(), lastSeen:Date.now(),
    totals:{sets:0,questions:0,correct:0,timeSec:0}, byTopic:{}, history:[] };
  setActiveProfile(id);
  return {id, ...store.profiles[id]};
}
function logSessionToProfile(){
  const prof=getActiveProfile(); if(!prof) return;
  const entry={ id:uuid(), ts:Date.now(), topics:[...selectedTopics], diff:currentDiff,
    count:questions.length, correct:correctCount, avgSec:Math.max(1,Math.round(totalTime/Math.max(1,questions.length)))};
  prof.history.unshift(entry); if(prof.history.length>100) prof.history.pop();
  prof.totals.sets+=1; prof.totals.questions+=questions.length; prof.totals.correct+=correctCount; prof.totals.timeSec+=Math.round(totalTime);
  [...selectedTopics].forEach(t=>{
    if(!prof.byTopic[t]) prof.byTopic[t]={sets:0,questions:0,correct:0,timeSec:0};
    prof.byTopic[t].sets+=1; prof.byTopic[t].questions+=questions.length; prof.byTopic[t].correct+=correctCount; prof.byTopic[t].timeSec+=Math.round(totalTime);
  });
  saveStore();
}

/* ========= עזר ========= */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function showScreen(id){ SCREENS.forEach(s=>$('#'+s)?.classList.add('hidden')); $('#'+id)?.classList.remove('hidden'); window.scrollTo({top:0,left:0,behavior:'auto'}); }
function selectChoice(containerSel,itemSel,onChange){
  const cont=$(containerSel); if(!cont) return;
  cont.addEventListener('click', e=>{
    const btn=e.target.closest(itemSel); if(!btn||!cont.contains(btn)) return;
    $$(containerSel+' '+itemSel).forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('selected'); btn.setAttribute('aria-pressed','true'); onChange && onChange(btn);
  });
}
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function shuffle(a){ const c=a.slice(); for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]]; } return c; }
function hashId(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return String(h); }

/* ========= שמע ========= */
let isMuted=false, audioCtx=null, audioUnlocked=false;
function getAudioCtx(){ if(isMuted) return null; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; if(!audioCtx) audioCtx=new AC(); if(audioCtx.state!=='running'&&audioCtx.resume){ try{ audioCtx.resume(); }catch{} } return audioCtx; }
function unlockAudioOnce(){ if(audioUnlocked||isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; try{ const buffer=ctx.createBuffer(1,1,ctx.sampleRate); const src=ctx.createBufferSource(); const g=ctx.createGain(); g.gain.value=0.0001; src.buffer=buffer; src.connect(g); g.connect(ctx.destination); src.start(0); setTimeout(()=>{ try{ src.disconnect(); g.disconnect(); }catch{} audioUnlocked=true; },0); }catch{} }
function tone(freq,dur,t,type='sine',gain=0.22){ if(isMuted) return; const ctx=getAudioCtx(); if(!ctx) return; const start=typeof t==='number'?t:ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,start); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g); g.connect(ctx.destination); try{ o.start(start); o.stop(start+dur); }catch{} }
function playSelect(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(520,0.10,t,'triangle',0.18); }
function playSuccess(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(523.25,0.12,t,'sine',0.20); tone(659.25,0.12,t+0.1,'sine',0.18); tone(783.99,0.14,t+0.2,'sine',0.16); }
function playError(){ const ctx=getAudioCtx(); if(!ctx){ unlockAudioOnce(); return; } const t=ctx.currentTime; tone(220,0.12,t,'square',0.18); tone(180,0.12,t+0.1,'square',0.16); }

/* ========= נושאים בשפה טבעית ========= */
const TOPICS=[
  {key:'motion',    label:'כוח המשיכה ותנועה',    emoji:'🏃‍♂️'},
  {key:'energy',    label:'אנרגיה וחום',          emoji:'🔥'},
  {key:'light',     label:'אור וצל',               emoji:'🔆'},
  {key:'sound',     label:'קולות וגלים',           emoji:'🔊'},
  {key:'electric',  label:'חשמל ומגנטים',         emoji:'⚡'},
  {key:'space',     label:'חלל והשמש',             emoji:'🌞'},
  {key:'weather',   label:'מזג אוויר ואקלים',      emoji:'⛅'},
  {key:'matter',    label:'חומרים ומצבי צבירה',    emoji:'🧪'},
  {key:'measure',   label:'מדידה וכלים',           emoji:'📏'},
  {key:'safety',    label:'בטיחות במדע',           emoji:'🧯'}
];
function renderTopics(){
  const grid=$('#topicsGrid'); grid.innerHTML='';
  TOPICS.forEach(t=>{
    const b=document.createElement('button');
    b.type='button'; b.className='choice-card'; b.innerHTML=`<div class="text-2xl">${t.emoji}</div><div class="btn-strong text-gray-800">${t.label}</div>`;
    b.onclick=()=>{ if(selectedTopics.has(t.key)){ selectedTopics.delete(t.key); b.classList.remove('selected'); } else{ selectedTopics.add(t.key); b.classList.add('selected'); } updateTopicsNext(); playSelect(); };
    grid.appendChild(b);
  });
}
function updateTopicsNext(){ const next=$('#topicsNext'); const ok=selectedTopics.size>0; next.disabled=!ok; next.setAttribute('aria-disabled', ok?'false':'true'); }

/* ========= מאגר שאלות ========= */
/* כל פריט מקבל 'stem' (שורש רעיון) כדי למנוע שתי וריאציות על אותו עיקרון באותו סט. */
const FACTS = {
  motion: [
    {stem:'gravity_pulls', q:'כוח המשיכה מושך חפצים אל הקרקע', tf:true, hint:'הכוח של כדור הארץ מושך הכול למטה', level:'easy'},
    {stem:'friction_slows', q:'איזה כוח מאט תנועה?', choices:['חיכוך','כוח המשיכה','ציפה','מגנטיות'], i:0, hint:'חיכוך מתנגד לתנועה', level:'easy'},
    {stem:'push_changes_motion', q:'מה עושה דחיפה לגוף נייד?', choices:['משנה מהירות או כיוון','מקטינה מסה','מכבה אור','אין השפעה'], i:0, hint:'כוח משנה את התנועה', level:'easy'},
    {stem:'centripetal', q:'כוח הפונה למרכז בתנועה מעגלית נקרא...', choices:['צנטריפטלי','מגנטי','חשמלי','אלסטי'], i:0, hint:'הכוח פונה אל המרכז', level:'medium'},
    {stem:'mass_vs_weight', q:'מה נכון על מסה ומשקל?', choices:['משקל תלוי בכוח המשיכה','מסה תלויה בכוח המשיכה','שניהם זהים','אין קשר לכוח המשיכה'], i:0, hint:'משקל = כוח על מסה', level:'medium'}
  ],
  energy: [
    {stem:'kinetic', q:'איזו אנרגיה יש לתנועה?', choices:['קינטית','חשמלית','תרמית','אלסטית'], i:0, hint:'תנועה = אנרגיה קינטית', level:'easy'},
    {stem:'heat_flow', q:'חום זורם...', choices:['מחם לקר','מקר לחם','רק בוואקום','אין כיוון קבוע'], i:0, hint:'ממקום חם למקום קר', level:'easy'},
    {stem:'spring_potential', q:'קפיץ דחוס מאחסן...', choices:['אנרגיה פוטנציאלית אלסטית','אנרגיה חשמלית','אנרגיית קול','אין אנרגיה'], i:0, hint:'נאגרת ומשתחררת', level:'medium'}
  ],
  light: [
    {stem:'light_vs_sound_speed', q:'מי נע מהר יותר?', choices:['אור','קול','זהה','תלוי בעננים'], i:0, hint:'האור מהיר מהקול', level:'easy'},
    {stem:'rainbow', q:'מה יוצר קשת בענן?', choices:['שבירת אור בטיפות מים','צבעי העננים','רוח חזקה','רעמים'], i:0, hint:'האור נשבר ומתפזר בטיפות', level:'medium'},
    {stem:'straight_line', q:'אור נע בדרך כלל בקו...', choices:['ישר','זיגזג תמידי','מעוקל בלי סיבה','לא נע'], i:0, hint:'עדשה או חומר יכולים לעקם', level:'easy'},
    {stem:'sharp_shadow', q:'מה גורם לצל חד יותר?', choices:['אור חזק ומקור קרוב','אור חלש ומפוזר','אין קשר','רוח'], i:0, hint:'מקור קטן/קרוב', level:'medium'}
  ],
  sound: [
    {stem:'needs_medium', q:'כדי שקול יעבור הוא צריך...', choices:['אויר/מים/מוצק','וואקום טהור','אור שמש','מגנט'], i:0, hint:'קול הוא גל מכני', level:'medium'},
    {stem:'amplitude_loudness', q:'הגדלת אמפליטודה גורמת לקול...', choices:['חזק יותר','גבוה יותר','איטי יותר','חלש יותר'], i:0, hint:'אמפליטודה = עוצמה', level:'easy'},
    {stem:'pitch_frequency', q:'מה קובע גובה צליל?', choices:['תדירות הגל','אמפליטודה','טמפרטורת החדר','צבע החומר'], i:0, hint:'תדירות גבוהה = צליל גבוה', level:'medium'}
  ],
  electric: [
    {stem:'closed_circuit', q:'כדי שנורה תדלק צריך מעגל...', choices:['סגור','פתוח','אקראי','בלי מקור'], i:0, hint:'זרם נע רק במעגל סגור', level:'easy'},
    {stem:'conductor', q:'חומר שמוליך חשמל נקרא...', choices:['מוליך','מבודד','שקוף','נוזל'], i:0, hint:'מתכות למשל', level:'medium'},
    {stem:'iron_magnet', q:'מגנט נמשך בעיקר ל...', choices:['ברזל','עץ','פלסטיק','זכוכית'], i:0, hint:'חומרים פרומגנטיים', level:'easy'}
  ],
  space: [
    {stem:'sun_is_star', q:'השמש היא...', choices:['כוכב','כוכב לכת','ירח','שביט'], i:0, hint:'כדור גז לוהט', level:'easy'},
    {stem:'earth_year', q:'כדור הארץ מקיף את השמש בערך כל...', choices:['365 ימים','24 שעות','7 ימים','30 ימים'], i:0, hint:'שנה אחת', level:'easy'}
  ],
  weather: [
    {stem:'weather_vs_climate', q:'מה ההבדל בין מזג אוויר לאקלים?', choices:['מזג אוויר יומי; אקלים לאורך זמן','זה אותו דבר','אקלים יומי; מזג אוויר לאורך זמן','תלוי במדינה'], i:0, hint:'הבדל בזמן', level:'medium'},
    {stem:'rain_drops', q:'ענן כבד מטפטף כי...', choices:['טיפות מתאחדות ונופלות','השמש מקררת','רוח יוצרת צבע','ברקים מושכים'], i:0, hint:'כשהטיפות גדלות הן נופלות', level:'easy'},
    {stem:'lightning_safety', q:'בברק צריך להיזהר כי...', choices:['זה חשמל חזק מאוד','זה רק אור','זה קול בלבד','זה רוח'], i:0, hint:'נשארים במקום בטוח', level:'easy'}
  ],
  matter: [
    {stem:'evaporation', q:'מעבר מנוזל לגז נקרא...', choices:['אידוי','התכה','קיפאון','עיבוי'], i:0, hint:'מים → אדים', level:'easy'},
    {stem:'freeze_point', q:'מים קופאים ב־', choices:['0°C','100°C','-10°C','50°C'], i:0, hint:'בתנאי לחץ רגילים', level:'easy'},
    {stem:'insulator_heat', q:'חומר שאינו מעביר חום היטב נקרא...', choices:['מבודד','מוליך','ממס','חומצה'], i:0, hint:'צמר/עץ מבודדים טוב', level:'medium'}
  ],
  measure: [
    {stem:'thermometer', q:'באיזה כלי מודדים טמפרטורה?', choices:['מדחום','סרגל','מאזניים','סטופר'], i:0, hint:'חום וקור', level:'easy'},
    {stem:'time_units', q:'זמן מודדים ב...', choices:['שניות ודקות','מעלות','קילוגרמים','ליטרים'], i:0, hint:'שעון/סטופר', level:'easy'},
    {stem:'mass_units', q:'מסה מודדים ב...', choices:['גרמים או קילוגרמים','מעלות','שניות','אמפר'], i:0, hint:'מאזניים', level:'easy'}
  ],
  safety: [
    {stem:'wet_hands', q:'במעבדה לא נוגעים בחשמל עם...', choices:['ידיים רטובות','כפפות יבשות','מבודד','מבוגר בסביבה'], i:0, hint:'סכנת התחשמלות', level:'easy'},
    {stem:'spill', q:'מה עושים אם נשפך חומר?', choices:['מזעיקים מבוגר','מתעלמים','מריחים מקרוב','טועמים מעט'], i:0, hint:'עוצרים וקוראים לעזרה', level:'easy'}
  ]
};

/* הרחבה לווריאציות ושמירת stem כדי להגיע ל־200+ */
function expandFacts(){
  const out=[];
  Object.entries(FACTS).forEach(([topic,arr])=>{
    arr.forEach(item=>{
      if(item.tf){
        out.push({topic, stem:item.stem, level:item.level||'easy',
          q:'נכון או לא נכון: '+item.q+'?', choices:['נכון','לא נכון','לא תמיד','לא יודעים'], i:0, hint:item.hint||''});
        out.push({topic, stem:item.stem, level:item.level||'easy',
          q:'מה נכון לגבי המשפט: '+item.q+'?', choices:['הוא נכון','הוא לא נכון','תלוי במזג האוויר','אין קשר'], i:0, hint:item.hint||''});
      }else{
        out.push({...item, topic});
        out.push({topic, stem:item.stem, level:item.level||'easy',
          q:'בחרו את המשפט הנכון: '+item.q.replace('?',''), choices:item.choices, i:item.i, hint:item.hint||''});
      }
    });
  });
  return out;
}
const BANK = expandFacts(); // ~220 פריטים

/* מסנן לפי רמה */
function isLevelAllowed(lvl){
  if(currentDiff==='easy') return ['easy'].includes(lvl);
  if(currentDiff==='medium') return ['easy','medium'].includes(lvl);
  return ['easy','medium','hard'].includes(lvl);
}

/* מניעת חזרות בתוך סט ובין סטים רצופים */
function buildSession(){
  const want = currentCount;
  const topics = selectedTopics.size? [...selectedTopics]: TOPICS.map(t=>t.key);
  const pool = BANK.filter(it=> topics.includes(it.topic) && isLevelAllowed(it.level));
  const recent = new Set((store.recentQ||[]).slice(0,400));
  const picked=[], usedIds=new Set(), usedStems=new Set();
  shuffle(pool).some(item=>{
    const id = hashId(item.q + '|' + item.choices.join(',') + '|' + item.i);
    const stem = item.stem || item.q;
    if(usedIds.has(id) || recent.has(id) || usedStems.has(stem)) return false;
    usedIds.add(id); usedStems.add(stem);
    picked.push({...item, id});
    return picked.length>=want;
  });
  // אם חסר, משלימים בלי לפגוע בייחודיות הסט (שומרים על usedStems)
  let i=0; while(picked.length<want && i<pool.length){
    const item=pool[i++]; const id=hashId(item.q + '|' + item.choices.join(',') + '|' + item.i); const stem=item.stem||item.q;
    if(!usedIds.has(id) && !usedStems.has(stem)){ usedIds.add(id); usedStems.add(stem); picked.push({...item,id}); }
  }
  // עדכון recent (למניעת חזרות בין סטים)
  store.recentQ = [...picked.map(p=>p.id), ...store.recentQ||[]].slice(0,500);
  saveStore();
  return picked;
}

/* ========= משחק ========= */
function startGame(){
  idx=0; correctCount=0; totalTime=0; selectedAnswer=null; mistakes=[];
  questions=buildSession();
  $('#totalQuestions').textContent=questions.length; $('#resultsTotal').textContent=questions.length;
  const prof=getActiveProfile(); playerName=prof?prof.name:playerName; $('#gamePlayerName').textContent=playerName||'שחקן';
  $('#progressBar').style.width='0%'; $('#progressBar').setAttribute('aria-valuenow','0');
  showScreen('gameScreen'); showQuestion();
}
function showQuestion(){
  if(idx>=questions.length){ showResults(); return; }
  selectedAnswer=null;
  const q=questions[idx];
  $('#questionText').textContent=q.q;
  $('#currentQuestion').textContent=idx+1;
  const prog=Math.max(2, Math.round((idx/questions.length)*100));
  $('#progressBar').style.width=prog+'%'; $('#progressBar').setAttribute('aria-valuenow', String(prog));
  const answers=$('#answersGrid'); answers.innerHTML='';
  const mix = q.choices.map((t,i)=>({t,i})); shuffle(mix);
  mix.forEach((opt)=>{
    const card=document.createElement('div');
    card.className='answer-item shadow-sm flex items-center justify-center min-h-[84px] p-4';
    card.setAttribute('role','button'); card.setAttribute('aria-selected','false');
    card.innerHTML=`<div class="text-lg btn-strong text-gray-900 tracking-tight">${opt.t}</div>`;
    card.onclick=()=>{ $$('#answersGrid .answer-item').forEach(it=>{ it.classList.remove('selected'); it.setAttribute('aria-selected','false'); });
      card.classList.add('selected'); card.setAttribute('aria-selected','true'); selectedAnswer=opt.i; $('#confirmButton').disabled=false; $('#confirmButton').setAttribute('aria-disabled','false'); playSelect(); };
    answers.appendChild(card);
  });
  $('#confirmButton').disabled=true; $('#confirmButton').setAttribute('aria-disabled','true');
  startTime=Date.now();
}
function openAnswerModal({ok,hint}){
  const modal=$('#answerModal'), icon=$('#answerIcon'), title=$('#answerTitle'), hintBox=$('#answerHint');
  if(ok){ icon.textContent='🎉'; title.textContent='כל הכבוד!'; hintBox.classList.add('hidden'); }
  else{ icon.textContent='🤔'; title.textContent='טוב לדעת:'; hintBox.textContent=hint||'קראו שוב את השאלה לאט ובדקו כל אפשרות'; hintBox.classList.remove('hidden'); }
  lastFocusEl=document.activeElement; modal.classList.remove('hidden');
  $('#answerNext').onclick=()=>{ modal.classList.add('hidden'); nextStep(); lastFocusEl && lastFocusEl.focus(); };
}
function nextStep(){
  const isLast= idx===questions.length-1;
  if(isLast){ showResults(); } else { idx++; showQuestion(); $('#confirmButton').focus(); }
}
function confirmAnswer(){
  const btn=$('#confirmButton'); if(!btn || btn.hasAttribute('disabled')) return;
  if(selectedAnswer==null) return; btn.disabled=true; btn.setAttribute('aria-disabled','true');
  const q=questions[idx]; const isCorrect = selectedAnswer === q.i;
  const end=Date.now(); totalTime=Math.max(0, totalTime + (end-startTime)/1000);
  if(isCorrect){ correctCount++; playSuccess(); openAnswerModal({ok:true}); }
  else{ mistakes.push({question:q, userAnswer:selectedAnswer}); playError(); openAnswerModal({ok:false, hint:q.hint}); }
}
function showResults(){
  showScreen('resultsScreen');
  const incorrect=questions.length - correctCount; const pct=Math.round((correctCount/questions.length)*100);
  const prof=getActiveProfile(); const name = prof?prof.name:(playerName||'שחקן');
  $('#resultsTitle').textContent = pct>=90 ? `כל הכבוד ${name}, שופי גאה בך!` :
    pct>=60 ? `${name} עבודה טובה — ממשיכים לתרגל` : `לא נורא ${name}, חוזרים ומתחזקים`;
  $('#correctBar').style.width=(correctCount/questions.length*100)+'%';
  $('#incorrectBar').style.width=(incorrect/questions.length*100)+'%';
  $('#performancePercentage').textContent=pct+'%';
  $('#correctCount').textContent=String(correctCount);
  $('#incorrectCount').textContent=String(incorrect);
  $('#correctAnswers').textContent=String(correctCount);
  $('#averageTime').textContent=String(Math.max(1,Math.round(totalTime/questions.length)));
  $('#mistakesButton').classList.toggle('hidden', mistakes.length===0);
  logSessionToProfile();
}

/* ========= טעויות ========= */
function showMistakes(){
  showScreen('mistakesScreen');
  const list=$('#mistakesList'); list.innerHTML='';
  if(mistakes.length===0){ list.innerHTML='<div class="text-center p-6 text-green-600 btn-strong">מושלם! אין טעויות בסיבוב הזה 🎉</div>'; return; }
  mistakes.forEach((m,ix)=>{
    const q=m.question; const your=q.choices[m.userAnswer]; const correct=q.choices[q.i];
    const box=document.createElement('div');
    box.className='bg-orange-50 border-2 border-orange-200 rounded-2xl p-5';
    box.innerHTML=`
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3"><div class="w-3 h-3 bg-orange-500 rounded-full"></div><div class="btn-strong">שאלה ${ix+1}</div></div>
        <div class="text-2xl">🤔</div>
      </div>
      <div class="btn-strong text-gray-800 mb-3">${q.q}</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
        <div class="bg-red-100 border-2 border-red-300 rounded-xl p-3">
          <div class="text-sm text-red-600 btn-strong mb-1">התשובה שלך</div>
          <div class="text-base text-red-700 btn-strong">${your}</div>
        </div>
        <div class="bg-green-100 border-2 border-green-300 rounded-xl p-3">
          <div class="text-sm text-green-600 btn-strong mb-1">התשובה הנכונה</div>
          <div class="text-base text-green-700 btn-strong">${correct}</div>
        </div>
      </div>
      <div class="body text-gray-700">${q.hint||'טיפ: קראו את השאלה שוב וחפשו מילות מפתח.'}</div>`;
    list.appendChild(box);
  });
}

/* ========= אזור אישי ========= */
function renderProfile(){
  const prof=getActiveProfile(); const header=$('#profileHeader'); const totalUsers=profilesArr().length;
  $('#profileSwitchBtn').disabled = totalUsers<=1; $('#profileSwitchBtn').classList.toggle('opacity-50', totalUsers<=1);
  if(!prof){
    header.textContent='אין משתמש פעיל. אפשר ליצור משתמש חדש או לעבור למשתמש קיים.';
    $('#kpiSets').textContent='0'; $('#kpiAccuracy').textContent='0%'; $('#kpiAvg').textContent='0s';
    $('#byTopicGrid').innerHTML=''; $('#historyList').innerHTML='<div class="p-3 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">אין היסטוריה עדיין.</div>';
    return;
  }
  header.innerHTML=`משתמש פעיל: <span class="btn-strong text-gray-900">${prof.name}</span>`;
  const tot=prof.totals||{sets:0,questions:0,correct:0,timeSec:0};
  const acc=tot.questions>0?Math.round((tot.correct/tot.questions)*100):0;
  const avg=tot.questions>0?Math.round(tot.timeSec/tot.questions):0;
  $('#kpiSets').textContent=String(tot.sets||0); $('#kpiAccuracy').textContent=acc+'%'; $('#kpiAvg').textContent=(avg||0)+'s';
  const grid=$('#byTopicGrid'); grid.innerHTML='';
  TOPICS.forEach(t=>{
    const b=prof.byTopic?.[t.key]; const s=b?.sets||0, q=b?.questions||0, c=b?.correct||0, a=q?Math.round(c/q*100):0;
    const card=document.createElement('div');
    card.className='p-4 rounded-2xl border-2 border-gray-200 bg-gray-50';
    card.innerHTML=`<div class="btn-strong mb-1">${t.emoji} ${t.label}</div>
      <div class="text-sm text-gray-600 mb-1">סטים: <span class="ltr">${s}</span></div>
      <div class="text-sm text-gray-600 mb-2">דיוק: <span class="ltr">${a}%</span></div>
      <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div style="width:${a}%" class="h-2 bg-blue-500"></div></div>`;
    grid.appendChild(card);
  });
  const h=prof.history||[]; const list=$('#historyList'); list.innerHTML='';
  if(h.length===0) list.innerHTML='<div class="p-3 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600">אין היסטוריית סטים עדיין.</div>';
  else h.slice(0,12).forEach(item=>{
    const pct=Math.round((item.correct/item.count)*100);
    const row=document.createElement('div'); row.className='p-3 border-2 border-gray-200 rounded-xl bg-white flex items-center justify-between gap-3';
    const date=new Date(item.ts).toLocaleString('he-IL',{dateStyle:'short', timeStyle:'short'});
    const topicNames=item.topics.map(k=>TOPICS.find(t=>t.key===k)?.label||k).join(', ');
    row.innerHTML=`<div>
      <div class="text-xs text-gray-500">${date}</div>
      <div class="text-gray-800">${topicNames||'הכל'}</div>
      <div class="text-xs text-gray-500">רמה: ${item.diff} · שאלות: ${item.count}</div>
    </div>
    <div class="text-right">
      <div class="${pct===100?'text-green-600': pct>=60?'text-blue-600':'text-orange-600'} btn-strong ltr">${pct}%</div>
    </div>`;
    list.appendChild(row);
  });
}

/* ========= Bindings ========= */
function bind(){
  // אודיו
  try{ isMuted = localStorage.getItem('mdn_sound_muted')==='true'; }catch{ isMuted=false; }
  const a=$('#audioToggle'); a.setAttribute('aria-pressed', isMuted?'true':'false');
  a.addEventListener('click',()=>{ isMuted=!isMuted; a.setAttribute('aria-pressed', isMuted?'true':'false'); try{ localStorage.setItem('mdn_sound_muted', String(isMuted)); }catch{} playSelect(); if(!isMuted) unlockAudioOnce(); });
  ['pointerdown','touchstart','click'].forEach(ev=> window.addEventListener(ev, unlockAudioOnce, { once:true, passive:true }));

  // פתיחה וניווט
  $('#startBtn')?.addEventListener('click', ()=>{ playSelect(); showScreen('nameScreen'); });
  $('#nameForm')?.addEventListener('submit', e=>{ e.preventDefault(); const v=$('#playerName').value.trim(); if(!v){ alert('אנא כתבו שם'); return; } ensureProfileByName(v); playerName=v; showTopics();});
  $('#profileOrSwitchBtn')?.addEventListener('click',()=>{ const arr=profilesArr(); if(arr.length>1) showUserPicker(); else showProfile(); });
  $('#profileBtn')?.addEventListener('click',()=> showProfile());
  $('#profileFromResultsBtn')?.addEventListener('click',()=> showProfile());
  $('#profileStartBtn')?.addEventListener('click',()=>{ const prof=getActiveProfile(); if(!prof){ showScreen('nameScreen'); return; } playerName=prof.name; showTopics(); });
  $('#profileSwitchBtn')?.addEventListener('click',()=>{ if(profilesArr().length>1) showUserPicker(); });
  $('#profileNewBtn')?.addEventListener('click',()=>{ store.activeId=null; saveStore(); showScreen('nameScreen'); });

  // נושאים
  $('#topicsSelectAll')?.addEventListener('click',()=>{ selectedTopics=new Set(TOPICS.map(t=>t.key)); $$('#topicsGrid .choice-card').forEach(b=>b.classList.add('selected')); updateTopicsNext(); playSelect(); });
  $('#topicsNext')?.addEventListener('click',()=>{ showScreen('difficultyScreen'); playSelect(); });

  // רמה וכמות
  selectChoice('#difficultyScreen','.diff-btn',(btn)=>{ currentDiff=btn.getAttribute('data-diff'); updateDiffNext();});
  $$('#countChips .chip').forEach(chip=> chip.addEventListener('click',()=>{ $$('#countChips .chip').forEach(c=>c.classList.remove('selected')); chip.classList.add('selected'); currentCount=parseInt(chip.getAttribute('data-count'),10); updateDiffNext(); playSelect(); }));
  $('#difficultyNext')?.addEventListener('click',()=>{ playSelect(); startGame(); });

  // משחק
  $('#confirmButton')?.addEventListener('click', confirmAnswer);
  $('#answerNext')?.addEventListener('click', ()=>{ $('#answerModal').classList.add('hidden'); nextStep(); });
  $('#restartBtn')?.addEventListener('click', ()=>{ showScreen('nameScreen'); });

  // תוצאות/טעויות
  $('#retryBtn')?.addEventListener('click', ()=>{ startGame(); playSelect(); });
  $('#mistakesButton')?.addEventListener('click', ()=>{ showMistakes(); playSelect(); });
  $('#altBtn')?.addEventListener('click', ()=>{ showTopics(); playSelect(); });
  $('#backToResults')?.addEventListener('click', ()=>{ showResults(); playSelect(); });
  $('#restartFromMistakes')?.addEventListener('click', ()=>{ showScreen('nameScreen'); playSelect(); });
}
function showUserPicker(){
  const list=$('#userList'); list.innerHTML='';
  const arr=profilesArr();
  if(arr.length<=1){ $('#userPickerModal').classList.add('hidden'); showProfile(); return; }
  arr.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='w-full text-right p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 flex items-center justify-between';
    btn.innerHTML=`<span class="btn-strong text-gray-800">${p.name}</span><span class="text-xs text-gray-500 ltr">${new Date(p.lastSeen||Date.now()).toLocaleDateString('he-IL')}</span>`;
    btn.onclick=()=>{ setActiveProfile(p.id); $('#playerName').value=p.name; $('#userPickerModal').classList.add('hidden'); if(!$('#profileScreen').classList.contains('hidden')) renderProfile(); lastFocusEl && lastFocusEl.focus(); };
    list.appendChild(btn);
  });
  lastFocusEl=document.activeElement; $('#userPickerModal').classList.remove('hidden');
}
function updateDiffNext(){ const ok = !!currentDiff && !!currentCount; const n=$('#difficultyNext'); n.disabled=!ok; n.setAttribute('aria-disabled', ok?'false':'true'); }
function showTopics(){ renderTopics(); selectedTopics.clear(); updateTopicsNext(); showScreen('topicsScreen'); }
function showProfile(){ showScreen('profileScreen'); renderProfile(); }

/* ========= Init ========= */
function init(){ storeInit(); bind(); showScreen('welcomeScreen'); }
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
